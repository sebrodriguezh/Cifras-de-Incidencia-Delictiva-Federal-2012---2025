<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Incidencia Delictiva - SESNSP M√©xico</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Custom CSS Files -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/snapshots.css">
</head>
<body>
    <!-- Header Section -->
    <header class="main-header">
        <div class="header-content">
            <h1>An√°lisis de las cifras de incidencia delictiva federal </h1>
            <p class="subtitle">Datos del Secretariado Ejecutivo del Sistema Nacional de Seguridad P√∫blica</p>
            <p class="update-date">√öltima actualizaci√≥n: Agosto 2025</p>
        </div>
    </header>

    <!-- Main Content Container -->
    <main class="main-container">
        <!-- Overview section -->
        <section class="content-section">
            <h2>Estructura de la base de datos</h2>
            <p class="section-description">Overview de la base de datos original</p>

            <!-- Data Summary Cards -->
            <div class="data-overview">
                <div class="summary-card">
                    <div class="card-icon"></div>
                    <div class="card-content">
                        <h3>Total de registros</h3>
                        <p class="card-number" id="total-registros-original">Cargando...</p>
                        <p class="card-description">Registros delictivos incluidos</p>
                    </div>
                </div>
                
                <div class="summary-card">
                    <div class="card-icon"></div>
                    <div class="card-content">
                        <h3>Per√≠odo</h3>
                        <p class="card-number" id="periodo-original">Cargando...</p>
                        <p class="card-description">Rango temporal completo</p>
                    </div>
                </div>
                
                <div class="summary-card">
                    <div class="card-icon"></div>
                    <div class="card-content">
                        <h3>Estados</h3>
                        <p class="card-number" id="total-estados-original">Cargando...</p>
                        <p class="card-description">Entidades federativas incluidas</p>
                    </div>
                </div>
                
                <div class="summary-card">
                    <div class="card-icon"></div>
                    <div class="card-content">
                        <h3>Conceptos</h3>
                        <p class="card-number" id="conceptos-unicos-original">Cargando...</p>
                        <p class="card-description">Conceptos principales</p>
                    </div>
                </div>
            </div>
            <p class="section-description">Base de datos procesada para el resto del informe</p>
            <!-- Data Summary Cards - Base Procesada -->
            <div class="data-overview">
                <div class="summary-card">
                    <div class="card-icon"></div>
                    <div class="card-content">
                        <h3>Total de Registros</h3>
                        <p class="card-number" id="total-registros-procesados">Cargando...</p>
                        <p class="card-description">Registros delictivos procesados</p>
                    </div>
                </div>
                
                <div class="summary-card">
                    <div class="card-icon"></div>
                    <div class="card-content">
                        <h3>Per√≠odo</h3>
                        <p class="card-number" id="periodo-procesado">Cargando...</p>
                        <p class="card-description">Rango temporal filtrado</p>
                    </div>
                </div>
                
                <div class="summary-card">
                    <div class="card-icon"></div>
                    <div class="card-content">
                        <h3>Estados</h3>
                        <p class="card-number" id="total-estados-procesados">Cargando...</p>
                        <p class="card-description">Entidades federativas incluidas</p>
                    </div>
                </div>
                
                <div class="summary-card">
                    <div class="card-icon"></div>
                    <div class="card-content">
                        <h3>Conceptos</h3>
                        <p class="card-number" id="conceptos-unicos-procesados">Cargando...</p>
                        <p class="card-description">Conceptos principales</p>
                    </div>
                </div>
            </div>
            
            <!-- Database Preview Table - Solo Base Procesada -->
            <div class="database-preview">
                <h3>Vista previa de la base procesada</h3>
                <p class="preview-description">Primeras 10 filas de la base procesada - 'IDEFF_processed.csv'</p>
                <div class="table-container">
                    <table class="data-table" id="preview-table-procesados">
                        <thead>
                            <tr>
                                <th>Cargando...</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Cargando datos...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>


        <!-- Nacional Section -->
        <section class="content-section">
            <h2>Secci√≥n: Nacional</h2>
            <p class="section-description">An√°lisis a nivel nacional</p>
            
            <!-- Placeholder for your content -->
            <div class="chart-container">
                <h2>Gr√°fica 1. Incidencia delictiva del fuero federal por concepto (2019‚Äì2025)</h2>
                <p class="table-description">Datos reportados por el Secretariado Ejecutivo del Sistema Nacional de Seguridad P√∫blica, enero‚Äìjulio de cada a√±o</p>
                <div style="height: 500px; width: 100%;">
                    <canvas id="nationalChart"></canvas>
                </div>
            </div>
            <!-- Tabla de Datos de la Gr√°fica -->
            <div class="table-container">
                <h3>Tabla 1. Incidencia delictiva del fuero federal por concepto (2019‚Äì2025)</h3>
                <p class="table-description">Valores agregados por concepto y a√±o (suma de todos los meses)</p>
                
                <table class="data-table" id="national-concept-table">
                    <thead>
                        <tr>
                            <th>Concepto</th>
                            <th>2019</th>
                            <th>2020</th>
                            <th>2021</th>
                            <th>2022</th>
                            <th>2023</th>
                            <th>2024</th>
                            <th>2025</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Cargando datos...</td>
                            <td colspan="7">Espera...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- Tabla de cambios porcentuales de la Gr√°fica -->
            <div class="table-container">
                <h3>Tabla 2. Incidencia delictiva del fuero federal por concepto (2019‚Äì2025)</h3>
                <p class="table-description">Cambios porcentuales con respecto al a√±o anterior (enero-julio)</p>
                
                <table class="data-table" id="percentage-changes-table">
                    <thead>
                        <tr>
                            <th>Concepto</th>
                            <th>2019</th>
                            <th>2020</th>
                            <th>2021</th>
                            <th>2022</th>
                            <th>2023</th>
                            <th>2024</th>
                            <th>2025</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Cargando datos...</td>
                            <td colspan="7">Espera...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Estatal Section -->
        <section class="content-section">
            <h2>Estatal</h2>
            <p class="section-description">An√°lisis estatal con evoluci√≥n de rankings</p>
            
            <!-- Placeholder for your content -->
            <div class="placeholder-content">
                <p>Tu contenido aqu√≠...</p>
            </div>
        </section>

        <!-- Snapshots Section -->
        <section class="content-section">
            <h2>Snapshots Temporales</h2>
            <p class="section-description">Vista r√°pida de la evoluci√≥n temporal</p>
            
            <!-- Placeholder for your content -->
            <div class="placeholder-content">
                <p>Tu contenido aqu√≠...</p>
            </div>
        </section>
    </main>

    <!-- JavaScript para cargar estad√≠sticas -->
         <!-- JavaScript para cargar estad√≠sticas -->
    <script>
        // Funci√≥n para cargar estad√≠sticas de la base ORIGINAL
        async function loadOriginalStats() {
            try {
                console.log('üîÑ Cargando estad√≠sticas de base original...');
                const response = await fetch('data/stats.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const stats = await response.json();
                console.log('‚úÖ Estad√≠sticas originales cargadas:', stats);
                
                // Actualizar elementos de la base ORIGINAL
                if (stats.total_registros !== undefined) {
                    document.getElementById('total-registros-original').textContent = stats.total_registros.toLocaleString();
                }
                
                if (stats.fecha_minima && stats.fecha_maxima) {
                    document.getElementById('periodo-original').textContent = `${stats.fecha_minima} - ${stats.fecha_maxima}`;
                }
                
                if (stats.conceptos_unicos !== undefined) {
                    document.getElementById('conceptos-unicos-original').textContent = stats.conceptos_unicos;
                }
                
                if (stats.estados_unicos !== undefined) {
                    document.getElementById('total-estados-original').textContent = stats.estados_unicos;
                } else {
                    document.getElementById('total-estados-original').textContent = '32';
                }
                
                console.log('‚úÖ Base original actualizada');
                
            } catch (error) {
                console.error('‚ùå Error cargando estad√≠sticas originales:', error);
                document.getElementById('total-registros-original').textContent = 'Error';
                document.getElementById('periodo-original').textContent = 'Error';
                document.getElementById('conceptos-unicos-original').textContent = 'Error';
                document.getElementById('total-estados-original').textContent = 'Error';
            }
        }
        
        // Funci√≥n para cargar estad√≠sticas de la base PROCESADA
        async function loadProcessedStats() {
            try {
                console.log('üîÑ Cargando estad√≠sticas de base procesada...');
                const response = await fetch('data/stats_processed.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const stats = await response.json();
                console.log('‚úÖ Estad√≠sticas procesadas cargadas:', stats);
                
                // Actualizar elementos de la base PROCESADA
                if (stats.total_registros_procesados !== undefined) {
                    document.getElementById('total-registros-procesados').textContent = stats.total_registros_procesados.toLocaleString();
                }
                
                if (stats.fecha_minima_procesada && stats.fecha_maxima_procesada) {
                    document.getElementById('periodo-procesado').textContent = `${stats.fecha_minima_procesada} - ${stats.fecha_maxima_procesada}`;
                }
                
                if (stats.conceptos_unicos_procesados !== undefined) {
                    document.getElementById('conceptos-unicos-procesados').textContent = stats.conceptos_unicos_procesados;
                }
                
                if (stats.estados_unicos_procesados !== undefined) {
                    document.getElementById('total-estados-procesados').textContent = stats.estados_unicos_procesados;
                }
                
                console.log('‚úÖ Base procesada actualizada');
                
            } catch (error) {
                console.error('‚ùå Error cargando estad√≠sticas procesadas:', error);
                document.getElementById('total-registros-procesados').textContent = 'Error';
                document.getElementById('periodo-procesado').textContent = 'Error';
                document.getElementById('conceptos-unicos-procesados').textContent = 'Error';
                document.getElementById('total-estados-procesados').textContent = 'Error';
            }
        }
        
        // Funci√≥n para cargar preview de la base PROCESADA (solo esta)
        async function loadProcessedPreview() {
            try {
                console.log('üîÑ Cargando preview de base procesada...');
                const response = await fetch('data/preview_processed.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const previewData = await response.json();
                updatePreviewTable('preview-table-procesados', previewData);
                console.log('‚úÖ Preview procesado actualizado');
                
            } catch (error) {
                console.error('‚ùå Error cargando preview procesado:', error);
                document.getElementById('preview-table-procesados').innerHTML = '<tbody><tr><td>Error cargando preview</td></tr></tbody>';
            }
        }
        
        // Funci√≥n auxiliar para actualizar tabla de preview
        function updatePreviewTable(tableId, previewData) {
            if (previewData.length > 0) {
                const columns = Object.keys(previewData[0]);
                
                let tableHTML = '<thead><tr>';
                columns.forEach(col => {
                    tableHTML += `<th>${col}</th>`;
                });
                tableHTML += '</tr></thead><tbody>';
                
                previewData.forEach(row => {
                    tableHTML += '<tr>';
                    columns.forEach(col => {
                        const value = row[col] || '';
                        tableHTML += `<td>${value}</td>`;
                    });
                    tableHTML += '</tr>';
                });
                
                tableHTML += '</tbody>';
                document.getElementById(tableId).innerHTML = tableHTML;
            }
        }

        // Funci√≥n para crear el stacked chart nacional
        function createNationalStackedChart() {
            // Obtener el canvas
            const ctx = document.getElementById('nationalChart').getContext('2d');
            
            // Datos del CSV (esto se cargar√° din√°micamente)
            const chartData = {
                labels: ['2019', '2020', '2021', '2022', '2023', '2024', '2025'],
                datasets: []
            };
            
            // Colores para los conceptos
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
            ];
            
            // Cargar datos del CSV
            fetch('data/national_concept_analysis.csv')
                .then(response => response.text())
                .then(csvText => {
                    const lines = csvText.split('\n');
                    const headers = lines[0].split(',');
                    const years = headers.slice(1); // A√±os (2019, 2020, etc.)
                    
                    // Procesar cada l√≠nea (concepto)
                    for (let i = 1; i < lines.length; i++) {
                        if (lines[i].trim()) {
                            const values = lines[i].split(',');
                            const concepto = values[0];
                            const data = values.slice(1).map(val => parseInt(val) || 0);
                            
                            // Crear dataset para este concepto
                            chartData.datasets.push({
                                label: concepto,
                                data: data,
                                backgroundColor: colors[i % colors.length],
                                borderColor: colors[i % colors.length],
                                borderWidth: 1,
                            });
                        }
                    }
                    
                    // Crear el chart
                    new Chart(ctx, {
                        type: 'bar',
                        data: chartData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        usePointStyle: true,
                                        padding: 20
                                    }
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + ' casos';
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: 'A√±o (enero-julio)'
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: 'N√∫mero de carpetas de investigaci√≥n'
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return value.toLocaleString();
                                        }
                                    }
                                }
                            },
                            interaction: {
                                mode: 'nearest',
                                axis: 'x',
                                intersect: false
                            }
                        }
                    });
                })
                .catch(error => {
                    console.error('Error cargando datos:', error);
                });
        }
                // Funci√≥n para cargar la tabla de datos nacionales
        async function loadNationalTable() {
            try {
                console.log('üîÑ Cargando tabla de datos nacionales...');
                const response = await fetch('data/national_concept_analysis.csv');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                const rows = csvText.split('\n');
                const headers = rows[0].split(',');
                
                // Crear tabla HTML
                let tableHTML = '<thead><tr>';
                headers.forEach(header => {
                    tableHTML += `<th>${header}</th>`;
                });
                tableHTML += '<th>Total</th></tr></thead><tbody>';
                
                // Procesar filas de datos (saltar la primera que son headers)
                for (let i = 1; i < rows.length; i++) {
                    if (rows[i].trim() === '') continue; // Saltar filas vac√≠as
                    
                    const values = rows[i].split(',');
                    if (values.length < headers.length) continue; // Saltar filas incompletas
                    
                    tableHTML += '<tr>';
                    
                    // Primera columna (Concepto)
                    tableHTML += `<td>${values[0]}</td>`;
                    
                    // Columnas de a√±os (convertir a n√∫meros y formatear)
                    let total = 0;
                    for (let j = 1; j < values.length; j++) {
                        const value = parseInt(values[j]) || 0;
                        total += value;
                        tableHTML += `<td class="text-right">${value.toLocaleString()}</td>`;
                    }
                    
                    // Columna de total
                    tableHTML += `<td class="text-right total-cell"><strong>${total.toLocaleString()}</strong></td>`;
                    
                    tableHTML += '</tr>';
                }
                
                tableHTML += '</tbody>';
                
                // Actualizar la tabla
                document.getElementById('national-concept-table').innerHTML = tableHTML;
                console.log('‚úÖ Tabla nacional actualizada');
                
            } catch (error) {
                console.error('‚ùå Error cargando tabla nacional:', error);
                document.getElementById('national-concept-table').innerHTML = 
                    '<tbody><tr><td colspan="8">Error cargando datos</td></tr></tbody>';
            }
        }

        // Funci√≥n para cargar la tabla de datos nacionales
        async function loadNationalTable() {
            try {
                console.log('üîÑ Cargando tabla de datos nacionales...');
                const response = await fetch('data/national_concept_analysis.csv');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                const rows = csvText.split('\n');
                const headers = rows[0].split(',');
                
                // Crear tabla HTML
                let tableHTML = '<thead><tr>';
                headers.forEach(header => {
                    tableHTML += `<th>${header}</th>`;
                });
                tableHTML += '<th>Total</th></tr></thead><tbody>';
                
                // Procesar filas de datos (saltar la primera que son headers)
                for (let i = 1; i < rows.length; i++) {
                    if (rows[i].trim() === '') continue; // Saltar filas vac√≠as
                    
                    const values = rows[i].split(',');
                    if (values.length < headers.length) continue; // Saltar filas incompletas
                    
                    tableHTML += '<tr>';
                    
                    // Primera columna (Concepto)
                    tableHTML += `<td>${values[0]}</td>`;
                    
                    // Columnas de a√±os (convertir a n√∫meros y formatear)
                    let total = 0;
                    for (let j = 1; j < values.length; j++) {
                        const value = parseInt(values[j]) || 0;
                        total += value;
                        tableHTML += `<td class="text-right">${value.toLocaleString()}</td>`;
                    }
                    
                    // Columna de total
                    tableHTML += `<td class="text-right total-cell"><strong>${total.toLocaleString()}</strong></td>`;
                    
                    tableHTML += '</tr>';
                }
                
                tableHTML += '</tbody>';
                
                // Actualizar la tabla
                document.getElementById('national-concept-table').innerHTML = tableHTML;
                console.log('‚úÖ Tabla nacional actualizada');
                
            } catch (error) {
                console.error('‚ùå Error cargando tabla nacional:', error);
                document.getElementById('national-concept-table').innerHTML = 
                    '<tbody><tr><td colspan="8">Error cargando datos</td></tr></tbody>';
            }
        }
        
        // ===== FUNCI√ìN PARA CARGAR TABLA DE CAMBIOS PORCENTUALES =====
        
        async function loadPercentageChangesTable() {
            try {
                console.log('üîÑ Cargando tabla de cambios porcentuales...');
                const response = await fetch('data/national_percentage_analysis.csv');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                const rows = csvText.split('\n');
                const headers = rows[0].split(',');
                
                // Crear tabla HTML
                let tableHTML = '<thead><tr>';
                headers.forEach(header => {
                    tableHTML += `<th>${header}</th>`;
                });
                tableHTML += '</tr></thead><tbody>';
                
                // Procesar filas de datos (saltar la primera que son headers)
                for (let i = 1; i < rows.length; i++) {
                    if (rows[i].trim() === '') continue; // Saltar filas vac√≠as
                    
                    const values = rows[i].split(',');
                    if (values.length < headers.length) continue; // Saltar filas incompletas
                    
                    tableHTML += '<tr>';
                    
                    // Primera columna (Concepto)
                    tableHTML += `<td>${values[0]}</td>`;
                    
                    // Columnas de a√±os (cambios porcentuales)
                    for (let j = 1; j < values.length; j++) {
                        const value = parseFloat(values[j]) || 0;
                        
                        // Formatear cambios porcentuales con colores
                        let cellClass = 'text-right';
                        let displayValue = value;
                        
                        if (value > 0) {
                            cellClass += ' positive-change';
                            displayValue = `+${value.toFixed(1)}%`;
                        } else if (value < 0) {
                            cellClass += ' negative-change';
                            displayValue = `${value.toFixed(1)}%`;
                        } else {
                            displayValue = '0.0%';
                        }
                        
                        tableHTML += `<td class="${cellClass}">${displayValue}</td>`;
                    }
                    
                    tableHTML += '</tr>';
                }
                
                tableHTML += '</tbody>';
                
                // Actualizar la tabla
                document.getElementById('percentage-changes-table').innerHTML = tableHTML;
                console.log('‚úÖ Tabla de cambios porcentuales actualizada');
                
            } catch (error) {
                console.error('‚ùå Error cargando tabla de cambios porcentuales:', error);
                document.getElementById('percentage-changes-table').innerHTML = 
                    '<tbody><tr><td colspan="7">Error cargando datos</td></tr></tbody>';
            }
        }
        
        // ===== EVENT LISTENERS Y INICIALIZACI√ìN =====
        
        // Cargar todos los datos cuando la p√°gina se cargue
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ P√°gina cargada, iniciando carga de datos...');
            
            // Cargar estad√≠sticas
            loadOriginalStats();
            loadProcessedStats();
            loadProcessedPreview();
            loadNationalTable();
            loadPercentageChangesTable();
            
            // Crear gr√°fica nacional
            createNationalStackedChart();
        });
        
        // Event listeners adicionales para debugging
        document.querySelectorAll('.content-section').forEach(section => {
            section.addEventListener('click', function() {
                console.log('Section clicked:', this.querySelector('h2').textContent);
            });
        });

    </script>
</body>
</html>
