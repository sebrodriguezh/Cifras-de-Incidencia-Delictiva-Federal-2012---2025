<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Incidencia Delictiva - SESNSP México</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Custom CSS Files -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/snapshots.css">
    <!-- Leaflet CSS para mapas -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
    <!-- Header Section -->
    <header class="main-header">
        <div class="header-content">
            <h1>Análisis de las cifras de incidencia delictiva federal </h1>
            <p class="subtitle">Datos del Secretariado Ejecutivo del Sistema Nacional de Seguridad Pública</p>
            <p class="update-date">Última actualización: Agosto 2025</p>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="tab-navigation">
        <div class="tab-container">
            <button class="tab-button active" data-tab="nacional">Nacional</button>
            <button class="tab-button" data-tab="estatal">Estatal</button>
        </div>
    </nav>

    <!-- Main Content Container -->
    <main class="main-container">
        
        <!-- Tab Content: Nacional -->
        <div id="nacional-content" class="tab-content active">
        <!-- Overview section -->
        <section class="content-section">
            <h2>Estructura de la base de datos</h2>
            <p class="section-description">Overview de la base de datos original</p>

            <!-- Data Summary Cards -->
            <div class="data-overview">
                <div class="summary-card">
                    <div class="card-icon"></div>
                    <div class="card-content">
                        <h3>Total de registros</h3>
                        <p class="card-number" id="total-registros-original">Cargando...</p>
                        <p class="card-description">Registros delictivos incluidos</p>
                    </div>
                </div>
                
                <div class="summary-card">
                    <div class="card-icon"></div>
                    <div class="card-content">
                        <h3>Período</h3>
                        <p class="card-number" id="periodo-original">Cargando...</p>
                        <p class="card-description">Rango temporal completo</p>
                    </div>
                </div>
                
                <div class="summary-card">
                    <div class="card-icon"></div>
                    <div class="card-content">
                        <h3>Estados</h3>
                        <p class="card-number" id="total-estados-original">Cargando...</p>
                        <p class="card-description">Entidades federativas incluidas</p>
                    </div>
                </div>
                
                <div class="summary-card">
                    <div class="card-icon"></div>
                    <div class="card-content">
                        <h3>Conceptos</h3>
                        <p class="card-number" id="conceptos-unicos-original">Cargando...</p>
                        <p class="card-description">Conceptos principales</p>
                    </div>
                </div>
            </div>
            <p class="section-description">Base de datos procesada para el resto del informe</p>
            <!-- Data Summary Cards - Base Procesada -->
            <div class="data-overview">
                <div class="summary-card">
                    <div class="card-icon"></div>
                    <div class="card-content">
                        <h3>Total de Registros</h3>
                        <p class="card-number" id="total-registros-procesados">Cargando...</p>
                        <p class="card-description">Registros delictivos procesados</p>
                    </div>
                </div>
                
                <div class="summary-card">
                    <div class="card-icon"></div>
                    <div class="card-content">
                        <h3>Período</h3>
                        <p class="card-number" id="periodo-procesado">Cargando...</p>
                        <p class="card-description">Rango temporal filtrado</p>
                    </div>
                </div>
                
                <div class="summary-card">
                    <div class="card-icon"></div>
                    <div class="card-content">
                        <h3>Estados</h3>
                        <p class="card-number" id="total-estados-procesados">Cargando...</p>
                        <p class="card-description">Entidades federativas incluidas</p>
                    </div>
                </div>
                
                <div class="summary-card">
                    <div class="card-icon"></div>
                    <div class="card-content">
                        <h3>Conceptos</h3>
                        <p class="card-number" id="conceptos-unicos-procesados">Cargando...</p>
                        <p class="card-description">Conceptos principales</p>
                    </div>
                </div>
            </div>
            
            <!-- Database Preview Table - Solo Base Procesada -->
            <div class="database-preview">
                <h3>Vista previa de la base procesada</h3>
                <p class="preview-description">Primeras 10 filas de la base procesada - 'IDEFF_processed.csv'</p>
                <div class="table-container">
                    <table class="data-table" id="preview-table-procesados">
                        <thead>
                            <tr>
                                <th>Cargando...</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Cargando datos...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>


        <!-- Nacional Section -->
        <section class="content-section">
            <h2>Sección: Nacional anual</h2>
            <p class="section-description">Análisis a nivel nacional de 2019 a 2025</p>
            
            <!-- Gráfica 1 -->
            <div class="chart-container">
                <h2>Gráfica 1. Evolución temporal de la incidencia delictiva del fuero federal por concepto (2019–2025)</h2>
                <p class="table-description">Datos reportados por el Secretariado Ejecutivo del Sistema Nacional de Seguridad Pública, enero–julio de cada año</p>
                <div style="height: 500px; width: 100%;">
                    <canvas id="nationalChart"></canvas>
                </div>
            </div>
            <!-- Tabla de Datos de la Gráfica -->
            <div class="table-container">
                <h3>Tabla 1. Valores absolutos de incidencia delictiva del fuero federal por concepto (2019–2025)</h3>
                <p class="table-description">Valores agregados por concepto y año (suma de todos los meses)</p>
                
                <table class="data-table" id="national-concept-table">
                    <thead>
                        <tr>
                            <th>Concepto</th>
                            <th>2019</th>
                            <th>2020</th>
                            <th>2021</th>
                            <th>2022</th>
                            <th>2023</th>
                            <th>2024</th>
                            <th>2025</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Cargando datos...</td>
                            <td colspan="7">Espera...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- Tabla de cambios porcentuales de la Gráfica -->
            <div class="table-container">
                <h3>Tabla 1.1 Variación porcentual en la incidencia delictiva del fuero federal por concepto (2019–2025)</h3>
                <p class="table-description">Cambios porcentuales con respecto al año anterior (enero-julio)</p>
                
                <table class="data-table" id="percentage-changes-table">
                    <thead>
                        <tr>
                            <th>Concepto</th>
                            <th>2019</th>
                            <th>2020</th>
                            <th>2021</th>
                            <th>2022</th>
                            <th>2023</th>
                            <th>2024</th>
                            <th>2025</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Cargando datos...</td>
                            <td colspan="7">Espera...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- Gráfica 2 -->
            <div class="chart-container">
                <h2>Gráfica 2. Distribución porcentual anual de la incidencia delictiva del fuero federal por concepto (2019–2025)</h2>
                <p class="table-description">Datos reportados por el Secretariado Ejecutivo del Sistema Nacional de Seguridad Pública, enero–julio de cada año</p>
                <!-- Grid de 7 pie charts -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 50px; margin-top: 20px;">
                    <div style="height: 300px; width: 100%;">
                        <canvas id="pieChart2019"></canvas>
                </div>
                    <div style="height: 300px; width: 100%;">
                        <canvas id="pieChart2020"></canvas>
            </div>
                    <div style="height: 300px; width: 100%;">
                        <canvas id="pieChart2021"></canvas>
            </div>
                    <div style="height: 300px; width: 100%;">
                        <canvas id="pieChart2022"></canvas>
                    </div>
                    <div style="height: 300px; width: 100%;">
                        <canvas id="pieChart2023"></canvas>
                    </div>
                    <div style="height: 300px; width: 100%;">
                        <canvas id="pieChart2024"></canvas>
                    </div>
                    <div style="height: 300px; width: 100%;">
                        <canvas id="pieChart2025"></canvas>
                    </div>
                </div>
            </div>
            <!-- Gráfica 3 -->
            <div class="chart-container">
                <h2>Gráfica 3. Distribución porcentual anual de la incidencia delictiva del fuero federal por tipo (2019–2025)</h2>
                <p class="table-description">Distribución porcentual de tipos para el concepto seleccionado</p>
                
                <!-- Selector de Concepto -->
                <div class="concept-selector">
                    <label for="concept-select">Selecciona un concepto:</label>
                    <select id="concept-select">
                        <option value="">Cargando conceptos...</option>
                    </select>
                </div>


                
                <!-- Grid de 7 pie charts -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-top: 20px;">
                    <div style="height: 300px; width: 100%;">
                        <canvas id="typePieChart2019"></canvas>
                    </div>
                    <div style="height: 300px; width: 100%;">
                        <canvas id="typePieChart2020"></canvas>
                    </div>
                    <div style="height: 300px; width: 100%;">
                        <canvas id="typePieChart2021"></canvas>
                    </div>
                    <div style="height: 300px; width: 100%;">
                        <canvas id="typePieChart2022"></canvas>
                    </div>
                    <div style="height: 300px; width: 100%;">
                        <canvas id="typePieChart2023"></canvas>
                    </div>
                    <div style="height: 300px; width: 100%;">
                        <canvas id="typePieChart2024"></canvas>
                    </div>
                    <div style="height: 300px; width: 100%;">
                        <canvas id="typePieChart2025"></canvas>
                    </div>
                </div>
            </div>
            <!-- Tabla de datos de la gráfica 3-->
            <div class="table-container">
                <h3>Tabla 2. Valores absolutos de la incidencia delictiva del fuero federal por tipo (2019–2025)</h3>
                <p class="table-description">Valores absolutos por concepto y año (suma de enero-julio)</p>
            </div>
            
            <!-- Tabla de cambios porcentuales de la Gráfica 3 -->
            <div class="table-container">
                <h3>Tabla 2.1. Variación porcentual de la incidencia delictiva del fuero federal por tipos (2019–2025)</h3>
                <p class="table-description">Cambios porcentuales con respecto al año anterior para cada tipo</p>
            </div>
            
            <!-- Gráfica 4: Mapa de distribución por entidad -->
            <div class="chart-container">
                <h2>Gráfica 4. Distribución por entidad federativa</h2>
                
                <!-- Selectores de concepto, tipo y año -->
                <div class="map-selectors">
                    <div class="concept-selector">
                        <label for="map-concept-selector">Selecciona el concepto a visualizar:</label>
                        <select id="map-concept-selector">
                            <option value="">Cargando conceptos...</option>
                        </select>
                    </div>
                    
                    <div class="concept-selector">
                        <label for="map-type-selector">Selecciona el tipo:</label>
                        <select id="map-type-selector">
                            <option value="">Primero selecciona un concepto...</option>
                        </select>
                    </div>
                    
                    <div class="year-selector">
                        <label for="map-year-slider">Selecciona el año: <span id="year-display">2019</span></label>
                        <input type="range" id="map-year-slider" min="2019" max="2025" value="2019" step="1">
                        <div class="year-labels">
                            <span>2019</span>
                            <span>2020</span>
                            <span>2021</span>
                            <span>2022</span>
                            <span>2023</span>
                            <span>2024</span>
                            <span>2025</span>
                        </div>
                    </div>
                </div>
                
                <!-- Contenedor de mapas lado a lado -->
                <div class="maps-container">
                    <!-- Mapa 1: Mapa actual (funcional) -->
                    <div class="map-wrapper">
                        <h3>Mapa 1: Distribución por concepto</h3>
                        <div id="map" class="map-container"></div>
                    </div>
                    
                    <!-- Mapa 2: Placeholder -->
                    <div class="map-wrapper">
                        <h3>Mapa 2: Distribución por tipo</h3>
                        <div id="map2" class="map-container placeholder">
                            <div class="placeholder-content">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tabla de datos por entidad y concepto -->
                <div class="table-container">
                    <h3>Tabla 3. Valores absolutos de la incidencia delictiva del fuero federal por entidad federativa y concepto</h3>
                    <p class="table-description">Valores absolutos por entidad, concepto y año (suma de enero-julio)</p>
                    <table class="data-table" id="entidad-concepto-table">
                        <thead>
                            <tr>
                                <th>Entidad</th>
                                <th>2019</th>
                                <th>2020</th>
                                <th>2021</th>
                                <th>2022</th>
                                <th>2023</th>
                                <th>2024</th>
                                <th>2025</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Selecciona un concepto para ver datos...</td>
                                <td colspan="8">Espera...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Tabla de variación porcentual por entidad y concepto -->
                <div class="table-container">
                    <h3>Tabla 3.1. Variación porcentual de la incidencia delictiva del fuero federal por entidad federativa y concepto</h3>
                    <p class="table-description">Cambios porcentuales año tras año (2019 vs 2018, 2020 vs 2019, etc.)</p>
                    <table class="data-table" id="entidad-concepto-percentage-table">
                        <thead>
                            <tr>
                                <th>Entidad</th>
                                <th>2019</th>
                                <th>2020</th>
                                <th>2021</th>
                                <th>2022</th>
                                <th>2023</th>
                                <th>2024</th>
                                <th>2025</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Selecciona un concepto para ver datos...</td>
                                <td colspan="7">Espera...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Tabla de datos por entidad y tipo -->
                <div class="table-container">
                    <h3>Tabla 3.2. Valores absolutos de la incidencia delictiva del fuero federal por entidad federativa y tipo</h3>
                    <p class="table-description">Valores absolutos por entidad, tipo y año (suma de enero-julio)</p>
                    <table class="data-table" id="entidad-tipo-table">
                        <thead>
                            <tr>
                                <th>Entidad</th>
                                <th>2019</th>
                                <th>2020</th>
                                <th>2021</th>
                                <th>2022</th>
                                <th>2023</th>
                                <th>2024</th>
                                <th>2025</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Selecciona un concepto y tipo para ver datos...</td>
                                <td colspan="8">Espera...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Tabla de variación porcentual por entidad y tipo -->
                <div class="table-container">
                    <h3>Tabla 3.3. Variación porcentual de la incidencia delictiva del fuero federal por entidad federativa y tipo</h3>
                    <p class="table-description">Cambios porcentuales año tras año por tipo (2019 vs 2018, 2020 vs 2019, etc.)</p>
                    <table class="data-table" id="entidad-tipo-percentage-table">
                        <thead>
                            <tr>
                                <th>Entidad</th>
                                <th>2019</th>
                                <th>2020</th>
                                <th>2021</th>
                                <th>2022</th>
                                <th>2023</th>
                                <th>2024</th>
                                <th>2025</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Selecciona un concepto y tipo para ver datos...</td>
                                <td colspan="7">Espera...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

            </div>

        </section>

        <!-- Estatal Section -->
        <section class="content-section">
            <h2>Sección: Nacional mensual</h2>
            <p class="section-description">Análisis a nivel nacional de enero 2024 a julio 2025</p>

            <!-- Gráfica 1 -->
            <div class="chart-container">
                <h2>Gráfica 5. Evolución temporal de la incidencia delictiva del fuero federal por concepto (enero 2024 a julio 2025)</h2>
                <p class="table-description">Datos reportados por el Secretariado Ejecutivo del Sistema Nacional de Seguridad Pública</p>
                <div style="height: 500px; width: 100%;">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>
            
            <!-- Tabla de datos mensuales -->
            <div class="table-container">
                <h3>Tabla 4. Valores absolutos de incidencia delictiva del fuero federal por concepto (enero 2024 a julio 2025)</h3>
                <p class="table-description">Datos mensuales por concepto (mismos datos de la gráfica)</p>
                <table class="data-table" id="monthly-data-table">
                    <thead>
                        <tr>
                            <th>Concepto</th>
                            <th>Ene 2024</th>
                            <th>Feb 2024</th>
                            <th>Mar 2024</th>
                            <th>Abr 2024</th>
                            <th>May 2024</th>
                            <th>Jun 2024</th>
                            <th>Jul 2024</th>
                            <th>Ago 2024</th>
                            <th>Sep 2024</th>
                            <th>Oct 2024</th>
                            <th>Nov 2024</th>
                            <th>Dic 2024</th>
                            <th>Ene 2025</th>
                            <th>Feb 2025</th>
                            <th>Mar 2025</th>
                            <th>Abr 2025</th>
                            <th>May 2025</th>
                            <th>Jun 2025</th>
                            <th>Jul 2025</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Cargando datos...</td>
                            <td colspan="19">Espera...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Gráfica 6 -->
            <div class="chart-container">
                <h2>Gráfica 6. Distribución porcentual mensual de la incidencia delictiva del fuero federal por concepto (enero 2024 a julio 2025)</h2>
                <p class="table-description">Distribución porcentual por concepto, datos mensuales</p>
                
                <!-- Grid de pie charts mensuales -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-top: 20px;">
                    <div style="height: 300px; width: 100%;"><canvas id="monthlyPieChart2024-01"></canvas></div>
                    <div style="height: 300px; width: 100%;"><canvas id="monthlyPieChart2024-02"></canvas></div>
                    <div style="height: 300px; width: 100%;"><canvas id="monthlyPieChart2024-03"></canvas></div>
                    <div style="height: 300px; width: 100%;"><canvas id="monthlyPieChart2024-04"></canvas></div>
                    <div style="height: 300px; width: 100%;"><canvas id="monthlyPieChart2024-05"></canvas></div>
                    <div style="height: 300px; width: 100%;"><canvas id="monthlyPieChart2024-06"></canvas></div>
                    <div style="height: 300px; width: 100%;"><canvas id="monthlyPieChart2024-07"></canvas></div>
                    <div style="height: 300px; width: 100%;"><canvas id="monthlyPieChart2024-08"></canvas></div>
                    <div style="height: 300px; width: 100%;"><canvas id="monthlyPieChart2024-09"></canvas></div>
                    <div style="height: 300px; width: 100%;"><canvas id="monthlyPieChart2024-10"></canvas></div>
                    <div style="height: 300px; width: 100%;"><canvas id="monthlyPieChart2024-11"></canvas></div>
                    <div style="height: 300px; width: 100%;"><canvas id="monthlyPieChart2024-12"></canvas></div>
                    <div style="height: 300px; width: 100%;"><canvas id="monthlyPieChart2025-01"></canvas></div>
                    <div style="height: 300px; width: 100%;"><canvas id="monthlyPieChart2025-02"></canvas></div>
                    <div style="height: 300px; width: 100%;"><canvas id="monthlyPieChart2025-03"></canvas></div>
                    <div style="height: 300px; width: 100%;"><canvas id="monthlyPieChart2025-04"></canvas></div>
                    <div style="height: 300px; width: 100%;"><canvas id="monthlyPieChart2025-05"></canvas></div>
                    <div style="height: 300px; width: 100%;"><canvas id="monthlyPieChart2025-06"></canvas></div>
                    <div style="height: 300px; width: 100%;"><canvas id="monthlyPieChart2025-07"></canvas></div>
                </div>
            </div>
            
            <!-- Gráfica 7 -->
            <div class="chart-container">
                <h2>Gráfica 7. Distribución porcentual mensual de la incidencia delictiva del fuero federal por tipo (enero 2024 a julio 2025)</h2>
                <p class="table-description">Distribución porcentual de tipos para el concepto seleccionado</p>
                
                <!-- Selector de Concepto -->
                <div class="concept-selector">
                    <label for="monthly-concept-select">Selecciona un concepto:</label>
                    <select id="monthly-concept-select">
                        <option value="">Cargando conceptos...</option>
                    </select>
                </div>
                
                <!-- Grid de pie charts mensuales -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-top: 20px;">
                    <div style="height: 300px; width: 100%;"><canvas id="monthlyTypePieChart2024-01"></canvas></div>
                    <div style="height: 300px; width: 100%;"><canvas id="monthlyTypePieChart2024-02"></canvas></div>
                    <div style="height: 300px; width: 100%;"><canvas id="monthlyTypePieChart2024-03"></canvas></div>
                    <div style="height: 300px; width: 100%;"><canvas id="monthlyTypePieChart2024-04"></canvas></div>
                    <div style="height: 300px; width: 100%;"><canvas id="monthlyTypePieChart2024-05"></canvas></div>
                    <div style="height: 300px; width: 100%;"><canvas id="monthlyTypePieChart2024-06"></canvas></div>
                    <div style="height: 300px; width: 100%;"><canvas id="monthlyTypePieChart2024-07"></canvas></div>
                    <div style="height: 300px; width: 100%;"><canvas id="monthlyTypePieChart2024-08"></canvas></div>
                    <div style="height: 300px; width: 100%;"><canvas id="monthlyTypePieChart2024-09"></canvas></div>
                    <div style="height: 300px; width: 100%;"><canvas id="monthlyTypePieChart2024-10"></canvas></div>
                    <div style="height: 300px; width: 100%;"><canvas id="monthlyTypePieChart2024-11"></canvas></div>
                    <div style="height: 300px; width: 100%;"><canvas id="monthlyTypePieChart2024-12"></canvas></div>
                    <div style="height: 300px; width: 100%;"><canvas id="monthlyTypePieChart2025-01"></canvas></div>
                    <div style="height: 300px; width: 100%;"><canvas id="monthlyTypePieChart2025-02"></canvas></div>
                    <div style="height: 300px; width: 100%;"><canvas id="monthlyTypePieChart2025-03"></canvas></div>
                    <div style="height: 300px; width: 100%;"><canvas id="monthlyTypePieChart2025-04"></canvas></div>
                    <div style="height: 300px; width: 100%;"><canvas id="monthlyTypePieChart2025-05"></canvas></div>
                    <div style="height: 300px; width: 100%;"><canvas id="monthlyTypePieChart2025-06"></canvas></div>
                    <div style="height: 300px; width: 100%;"><canvas id="monthlyTypePieChart2025-07"></canvas></div>
                </div>
            </div>
            
            <!-- Tabla de valores absolutos mensuales por tipo -->
            <div class="table-container">
                <h3>Tabla 5. Valores absolutos de la incidencia delictiva del fuero federal por tipo (enero 2024 a julio 2025)</h3>
                <p class="table-description">Valores absolutos por concepto y mes (datos mensuales)</p>
            </div>
            
            <!-- Tabla de cambios porcentuales mensuales por tipo -->
            <div class="table-container">
                <h3>Tabla 5.1. Variación porcentual de la incidencia delictiva del fuero federal por tipos (enero 2024 a julio 2025)</h3>
                <p class="table-description">Cambios porcentuales mes tras mes para cada tipo</p>
            </div>

            <!-- Gráfica 8: Mapas mensuales de distribución por entidad federativa -->
            <div class="chart-container">
                <h2>Gráfica 8. Distribución mensual por entidad federativa</h2>
                <p class="table-description">Mapas interactivos mensuales de enero 2024 a julio 2025</p>
                
                <!-- Selectores de concepto, tipo y mes/año -->
                <div class="map-selectors">
                    <div class="concept-selector">
                        <label for="monthly-map-concept-selector">Selecciona el concepto a visualizar:</label>
                        <select id="monthly-map-concept-selector">
                            <option value="">Cargando conceptos...</option>
                        </select>
                    </div>
                    
                    <div class="concept-selector">
                        <label for="monthly-map-type-selector">Selecciona el tipo:</label>
                        <select id="monthly-map-type-selector" disabled>
                            <option value="">Primero selecciona un concepto...</option>
                        </select>
                    </div>
                    
                    <div class="year-selector">
                        <label for="monthly-map-month-slider">Selecciona el mes: <span id="monthly-month-display">Febrero 2024</span></label>
                        <input type="range" id="monthly-map-month-slider" min="1" max="19" value="2" step="1">
                    </div>
                </div>
                
                <!-- Contenedor de mapas lado a lado -->
                <div class="maps-container">
                    <!-- Mapa 1: Distribución mensual por concepto -->
                    <div class="map-wrapper">
                        <h3>Mapa 1: Distribución mensual por concepto</h3>
                        <div id="monthly-map" class="map-container"></div>
                    </div>
                    
                    <!-- Mapa 2: Distribución mensual por tipo -->
                    <div class="map-wrapper">
                        <h3>Mapa 2: Distribución mensual por tipo</h3>
                        <div id="monthly-map2" class="map-container placeholder">
            <div class="placeholder-content">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tabla 8. Valores absolutos mensuales por entidad y concepto -->
                <div class="table-container">
                    <h3>Tabla 8. Valores absolutos mensuales de la incidencia delictiva del fuero federal por entidad federativa y concepto</h3>
                    <p class="table-description">Valores absolutos por entidad, concepto y mes (enero 2024 - julio 2025)</p>
                    <table class="data-table" id="monthly-entidad-concepto-table">
                        <thead>
                            <tr>
                                <th>Entidad</th>
                                <th>Ene 2024</th>
                                <th>Feb 2024</th>
                                <th>Mar 2024</th>
                                <th>Abr 2024</th>
                                <th>May 2024</th>
                                <th>Jun 2024</th>
                                <th>Jul 2024</th>
                                <th>Ago 2024</th>
                                <th>Sep 2024</th>
                                <th>Oct 2024</th>
                                <th>Nov 2024</th>
                                <th>Dic 2024</th>
                                <th>Ene 2025</th>
                                <th>Feb 2025</th>
                                <th>Mar 2025</th>
                                <th>Abr 2025</th>
                                <th>May 2025</th>
                                <th>Jun 2025</th>
                                <th>Jul 2025</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Selecciona un concepto para ver datos...</td>
                                <td colspan="20">Espera...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Tabla 8.1. Variación porcentual mensual por entidad y concepto -->
                <div class="table-container">
                    <h3>Tabla 8.1. Variación porcentual mensual de la incidencia delictiva del fuero federal por entidad federativa y concepto</h3>
                    <p class="table-description">Cambios porcentuales mes tras mes (enero 2024 vs diciembre 2023, febrero 2024 vs enero 2024, etc.)</p>
                    <table class="data-table" id="monthly-entidad-concepto-percentage-table">
                        <thead>
                            <tr>
                                <th>Entidad</th>
                                <th>Ene 2024</th>
                                <th>Feb 2024</th>
                                <th>Mar 2024</th>
                                <th>Abr 2024</th>
                                <th>May 2024</th>
                                <th>Jun 2024</th>
                                <th>Jul 2024</th>
                                <th>Ago 2024</th>
                                <th>Sep 2024</th>
                                <th>Oct 2024</th>
                                <th>Nov 2024</th>
                                <th>Dic 2024</th>
                                <th>Ene 2025</th>
                                <th>Feb 2025</th>
                                <th>Mar 2025</th>
                                <th>Abr 2025</th>
                                <th>May 2025</th>
                                <th>Jun 2025</th>
                                <th>Jul 2025</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Selecciona un concepto para ver datos...</td>
                                <td colspan="19">Espera...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Tabla 8.2. Valores absolutos mensuales por entidad y tipo -->
                <div class="table-container">
                    <h3>Tabla 8.2. Valores absolutos mensuales de la incidencia delictiva del fuero federal por entidad federativa y tipo</h3>
                    <p class="table-description">Valores absolutos por entidad, tipo y mes (enero 2024 - julio 2025)</p>
                    <table class="data-table" id="monthly-entidad-tipo-table">
                        <thead>
                            <tr>
                                <th>Entidad</th>
                                <th>Ene 2024</th>
                                <th>Feb 2024</th>
                                <th>Mar 2024</th>
                                <th>Abr 2024</th>
                                <th>May 2024</th>
                                <th>Jun 2024</th>
                                <th>Jul 2024</th>
                                <th>Ago 2024</th>
                                <th>Sep 2024</th>
                                <th>Oct 2024</th>
                                <th>Nov 2024</th>
                                <th>Dic 2024</th>
                                <th>Ene 2025</th>
                                <th>Feb 2025</th>
                                <th>Mar 2025</th>
                                <th>Abr 2025</th>
                                <th>May 2025</th>
                                <th>Jun 2025</th>
                                <th>Jul 2025</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Selecciona un concepto y tipo para ver datos...</td>
                                <td colspan="20">Espera...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Tabla 8.3. Variación porcentual mensual por entidad y tipo -->
                <div class="table-container">
                    <h3>Tabla 8.3. Variación porcentual mensual de la incidencia delictiva del fuero federal por entidad federativa y tipo</h3>
                    <p class="table-description">Cambios porcentuales mes tras mes por tipo (enero 2024 vs diciembre 2023, febrero 2024 vs enero 2024, etc.)</p>
                    <table class="data-table" id="monthly-entidad-tipo-percentage-table">
                        <thead>
                            <tr>
                                <th>Entidad</th>
                                <th>Ene 2024</th>
                                <th>Feb 2024</th>
                                <th>Mar 2024</th>
                                <th>Abr 2024</th>
                                <th>May 2024</th>
                                <th>Jun 2024</th>
                                <th>Jul 2024</th>
                                <th>Ago 2024</th>
                                <th>Sep 2024</th>
                                <th>Oct 2024</th>
                                <th>Nov 2024</th>
                                <th>Dic 2024</th>
                                <th>Ene 2025</th>
                                <th>Feb 2025</th>
                                <th>Mar 2025</th>
                                <th>Abr 2025</th>
                                <th>May 2025</th>
                                <th>Jun 2025</th>
                                <th>Jul 2025</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Selecciona un concepto y tipo para ver datos...</td>
                                <td colspan="19">Espera...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

            </div>
        </section>

        </div> <!-- Fin Tab Content: Nacional -->

        <!-- Tab Content: Estatal -->
        <div id="estatal-content" class="tab-content">
        <section class="content-section">
                <h2>Análisis Estatal</h2>
                <p class="section-description">Análisis detallado por entidad federativa</p>
                
            <!-- Gráfica Estatal 1 -->
            <div class="chart-container">
                <h2>Gráfica 1. Incidencia delictiva por tipo y entidad federativa (enero–julio 2025)</h2>
                <p class="table-description">Casos de investigación ordenados por entidad federativa de mayor a menor incidencia</p>
                
                <!-- Selector de Concepto -->
                <div class="map-selectors">
                    <div class="concept-selector">
                        <label for="estatal-concepto-selector">Selecciona el concepto a visualizar:</label>
                        <select id="estatal-concepto-selector">
                            <option value=""> Selecciona un concepto </option>
                        </select>
            </div>
                </div>
                
                <div style="height: 800px; width: 100%;">
                    <canvas id="estatal-chart-1"></canvas>
                </div>
            </div>

            <!-- Tabla Estatal 1 -->
            <div class="table-container">
                <h2>Tabla 1. Valores absolutos por tipo y entidad federativa (enero–julio 2025)</h2>
                <p class="table-description">Datos correspondientes a la gráfica anterior</p>
            </div>
                
                <!-- Gráfica Estatal 2 -->
                <h3>Gráfica 2. Top 10 entidades por concepto o tipo (enero 2024 - julio 2025)</h3>
                <p class="chart-description">
                    Ranking mensual de las 10 entidades federativas con mayor incidencia delictiva (enero 2024 - julio 2025)
                </p>
                
                <!-- Selectores para Gráfica Estatal 2 -->
                <div class="map-selectors">
                    <div class="concept-selector">
                        <label for="estatal2-concepto-selector">Selecciona el concepto a visualizar:</label>
                        <select id="estatal2-concepto-selector">
                            <option value="">-- Selecciona un concepto --</option>
                        </select>
                    </div>
                    <div class="concept-selector">
                        <label for="estatal2-tipo-selector">Selecciona el tipo a visualizar:</label>
                        <select id="estatal2-tipo-selector" disabled>
                            <option value="">-- Primero selecciona un concepto --</option>
                        </select>
                    </div>
                </div>
                
                <!-- Contenedor para las cajas mensuales -->
                <div id="estatal2-chart-container" class="chart-container" style="display: none;">
                    <div id="estatal2-monthly-boxes" class="monthly-boxes-grid">
                        <!-- Las cajas se generarán dinámicamente -->
                    </div>
                </div>
                
                <!-- Tabla Estatal 2 -->
                <div id="table-estatal2-container" class="table-container" style="display: none;">
                    <h4>Tabla Estatal 2. Datos detallados del ranking mensual</h4>
                    <div id="table-estatal2"></div>
                </div> <!-- Fin tabla estatal 2 -->
                
        </section>
        </div> <!-- Fin Tab Content: Estatal -->
        
    </main>

         <!-- JavaScript para cargar estadísticas -->
    <script>
        // ========================================
        // TAB NAVIGATION FUNCTIONALITY
        // ========================================
        
        document.addEventListener('DOMContentLoaded', function() {
            // Obtener todos los botones de pestañas
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            // Agregar event listeners a los botones
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-tab');
                    
                    // Remover clase active de todos los botones y contenidos
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Agregar clase active al botón clickeado
                    this.classList.add('active');
                    
                    // Mostrar el contenido correspondiente
                    const targetContent = document.getElementById(targetTab + '-content');
                    if (targetContent) {
                        targetContent.classList.add('active');
                    }
                    
                    console.log('🔄 Pestaña cambiada a:', targetTab);
                });
            });
        });
        
        // ========================================
        // DATA LOADING FUNCTIONS
        // ========================================
        
        // Función para cargar estadísticas de la base ORIGINAL
        async function loadOriginalStats() {
            try {
                console.log('🔄 Cargando estadísticas de base original...');
                const response = await fetch('data/stats.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const stats = await response.json();
                console.log('✅ Estadísticas originales cargadas:', stats);
                
                // Actualizar elementos de la base ORIGINAL
                if (stats.total_registros !== undefined) {
                    document.getElementById('total-registros-original').textContent = stats.total_registros.toLocaleString();
                }
                
                if (stats.fecha_minima && stats.fecha_maxima) {
                    document.getElementById('periodo-original').textContent = `${stats.fecha_minima} - ${stats.fecha_maxima}`;
                }
                
                if (stats.conceptos_unicos !== undefined) {
                    document.getElementById('conceptos-unicos-original').textContent = stats.conceptos_unicos;
                }
                
                if (stats.estados_unicos !== undefined) {
                    document.getElementById('total-estados-original').textContent = stats.estados_unicos;
                } else {
                    document.getElementById('total-estados-original').textContent = '32';
                }
                
                console.log('✅ Base original actualizada');
                
            } catch (error) {
                console.error('❌ Error cargando estadísticas originales:', error);
                document.getElementById('total-registros-original').textContent = 'Error';
                document.getElementById('periodo-original').textContent = 'Error';
                document.getElementById('conceptos-unicos-original').textContent = 'Error';
                document.getElementById('total-estados-original').textContent = 'Error';
            }
        }
        
        // Función para cargar estadísticas de la base PROCESADA
        async function loadProcessedStats() {
            try {
                console.log('🔄 Cargando estadísticas de base procesada...');
                const response = await fetch('data/stats_processed.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const stats = await response.json();
                console.log('✅ Estadísticas procesadas cargadas:', stats);
                
                // Actualizar elementos de la base PROCESADA
                if (stats.total_registros_procesados !== undefined) {
                    document.getElementById('total-registros-procesados').textContent = stats.total_registros_procesados.toLocaleString();
                }
                
                if (stats.fecha_minima_procesada && stats.fecha_maxima_procesada) {
                    document.getElementById('periodo-procesado').textContent = `${stats.fecha_minima_procesada} - ${stats.fecha_maxima_procesada}`;
                }
                
                if (stats.conceptos_unicos_procesados !== undefined) {
                    document.getElementById('conceptos-unicos-procesados').textContent = stats.conceptos_unicos_procesados;
                }
                
                if (stats.estados_unicos_procesados !== undefined) {
                    document.getElementById('total-estados-procesados').textContent = stats.estados_unicos_procesados;
                }
                
                console.log('✅ Base procesada actualizada');
                
            } catch (error) {
                console.error('❌ Error cargando estadísticas procesadas:', error);
                document.getElementById('total-registros-procesados').textContent = 'Error';
                document.getElementById('periodo-procesado').textContent = 'Error';
                document.getElementById('conceptos-unicos-procesados').textContent = 'Error';
                document.getElementById('total-estados-procesados').textContent = 'Error';
            }
        }
        
        // Función para cargar preview de la base PROCESADA (solo esta)
        async function loadProcessedPreview() {
            try {
                console.log('🔄 Cargando preview de base procesada...');
                const response = await fetch('data/preview_processed.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const previewData = await response.json();
                updatePreviewTable('preview-table-procesados', previewData);
                console.log('✅ Preview procesado actualizado');
                
            } catch (error) {
                console.error('❌ Error cargando preview procesado:', error);
                document.getElementById('preview-table-procesados').innerHTML = '<tbody><tr><td>Error cargando preview</td></tr></tbody>';
            }
        }
        
        // Función auxiliar para actualizar tabla de preview
        function updatePreviewTable(tableId, previewData) {
            if (previewData.length > 0) {
                const columns = Object.keys(previewData[0]);
                
                let tableHTML = '<thead><tr>';
                columns.forEach(col => {
                    tableHTML += `<th>${col}</th>`;
                });
                tableHTML += '</tr></thead><tbody>';
                
                previewData.forEach(row => {
                    tableHTML += '<tr>';
                    columns.forEach(col => {
                        const value = row[col] || '';
                        tableHTML += `<td>${value}</td>`;
                    });
                    tableHTML += '</tr>';
                });
                
                tableHTML += '</tbody>';
                document.getElementById(tableId).innerHTML = tableHTML;
            }
        }

        // Función para crear el stacked chart nacional
        function createNationalStackedChart() {
            // Obtener el canvas
            const ctx = document.getElementById('nationalChart').getContext('2d');
            
            // Datos del CSV (esto se cargará dinámicamente)
            const chartData = {
                labels: ['2019', '2020', '2021', '2022', '2023', '2024', '2025'],
                datasets: []
            };
            
            // Colores consistentes para cada concepto
            const conceptColors = {
                'OTRAS LEYES Y CODIGOS': '#FF6384',
                'OTROS DELITOS': '#36A2EB', 
                'CONTRA LA SALUD': '#FFCE56',
                'LEY GENERAL DE SALUD (L.G.S.)': '#4BC0C0',
                'LEY FEDERAL CONTRA LA DELINCUENCIA ORGANIZADA (L.F.C.D.O.)': '#FF9F40'
            };
            
            // Colores de respaldo
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
            ];
            
            // Cargar datos del CSV
            fetch('data/national_concept_analysis.csv')
                .then(response => response.text())
                .then(csvText => {
                    const lines = csvText.split('\n');
                    const headers = lines[0].split(',');
                    const years = headers.slice(1); // Años (2019, 2020, etc.)
                    
                    // Procesar cada línea (concepto)
                    for (let i = 1; i < lines.length; i++) {
                        if (lines[i].trim()) {
                            const values = lines[i].split(',');
                            const concepto = values[0];
                            const data = values.slice(1).map(val => parseInt(val) || 0);
                            
                            // Crear dataset para este concepto
                            chartData.datasets.push({
                                label: concepto,
                                data: data,
                                backgroundColor: conceptColors[concepto] || colors[i % colors.length],
                                borderColor: conceptColors[concepto] || colors[i % colors.length],
                                borderWidth: 1,
                            });
                        }
                    }
                    
                    // Crear el chart
                    new Chart(ctx, {
                        type: 'bar',
                        data: chartData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        usePointStyle: true,
                                        padding: 20
                                    }
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + ' casos';
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Año (enero-julio)'
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: 'Número de carpetas de investigación'
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return value.toLocaleString();
                                        }
                                    }
                                }
                            },
                            interaction: {
                                mode: 'nearest',
                                axis: 'x',
                                intersect: false
                            }
                        }
                    });
                })
                .catch(error => {
                    console.error('Error cargando datos:', error);
                });
        }

        // Función para crear gráfica mensual stacked
        function createMonthlyStackedChart() {
            // Obtener el canvas
            const ctx = document.getElementById('monthlyChart').getContext('2d');
            
            // Colores consistentes para cada concepto (mismos que la gráfica anual)
            const conceptColors = {
                'OTRAS LEYES Y CODIGOS': '#FF6384',
                'OTROS DELITOS': '#36A2EB', 
                'CONTRA LA SALUD': '#FFCE56',
                'LEY GENERAL DE SALUD (L.G.S.)': '#4BC0C0',
                'LEY FEDERAL CONTRA LA DELINCUENCIA ORGANIZADA (L.F.C.D.O.)': '#FF9F40'
            };
            
            // Cargar datos del CSV mensual
            fetch('data/monthly_concept_analysis.csv')
                .then(response => response.text())
                .then(csvText => {
                    const lines = csvText.split('\n');
                    const headers = lines[0].split(',');
                    const conceptos = headers.slice(1); // Conceptos (columnas 2 en adelante)
                    
                    // Extraer etiquetas (meses) y datos
                    const labels = [];
                    const dataByConcepto = {};
                    
                    // Inicializar arrays para cada concepto
                    conceptos.forEach(concepto => {
                        dataByConcepto[concepto] = [];
                    });
                    
                    // Procesar cada línea (mes)
                    for (let i = 1; i < lines.length; i++) {
                        if (lines[i].trim()) {
                            const values = lines[i].split(',');
                            const mesAño = values[0];
                            
                            // Formatear etiqueta del mes (de "2024-01" a "Ene 2024")
                            const [año, mes] = mesAño.split('-');
                            const mesesNombres = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 
                                                 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                            const mesNombre = mesesNombres[parseInt(mes) - 1];
                            labels.push(`${mesNombre} ${año}`);
                            
                            // Agregar datos para cada concepto
                            for (let j = 1; j < values.length && j <= conceptos.length; j++) {
                                const concepto = conceptos[j - 1];
                                const valor = parseInt(values[j]) || 0;
                                dataByConcepto[concepto].push(valor);
                            }
                        }
                    }
                    
                    // Crear datasets para Chart.js
                    const datasets = [];
                    conceptos.forEach((concepto, index) => {
                        datasets.push({
                            label: concepto,
                            data: dataByConcepto[concepto],
                            backgroundColor: conceptColors[concepto] || `hsl(${index * 72}, 70%, 60%)`,
                            borderColor: conceptColors[concepto] || `hsl(${index * 72}, 70%, 50%)`,
                            borderWidth: 1
                        });
                    });
                    
                    // Crear la gráfica
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    stacked: true,
                                    title: {
                                        display: true,
                                        text: 'Período (enero 2024 - julio 2025)'
                                    },
                                    ticks: {
                                        maxRotation: 45
                                    }
                                },
                                y: {
                                    stacked: true,
                                    title: {
                                        display: true,
                                        text: 'Carpetas de investigación'
                                    },
                                    beginAtZero: true
                                }
                            },
                            plugins: {
                                title: {
                                    display: false,
                                },
                                legend: {
                                    display: true,
                                    position: 'bottom',
                                    labels: {
                                        usePointStyle: true,
                                        padding: 20
                                    }
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    callbacks: {
                                        footer: function(tooltipItems) {
                                            let total = 0;
                                            tooltipItems.forEach(item => {
                                                total += item.raw;
                                            });
                                            return `Total: ${total.toLocaleString()} carpetas`;
                                        }
                                    }
                                }
                            },
                            interaction: {
                                mode: 'nearest',
                                axis: 'x',
                                intersect: false
                            }
                        }
                    });
                    
                    console.log('✅ Gráfica mensual stacked creada con', labels.length, 'meses y', conceptos.length, 'conceptos');
                })
                                .catch(error => {
                    console.error('❌ Error cargando datos mensuales:', error);
                });
        }

        // Función para cargar la tabla de datos mensuales (Tabla 4)
        async function loadMonthlyTable() {
            try {
                console.log('🔄 Cargando tabla de datos mensuales...');
                const response = await fetch('data/monthly_concept_analysis.csv');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                console.log('✅ CSV de tabla mensual cargado, longitud:', csvText.length);
                
                // Parsear CSV
                const lines = csvText.split('\n');
                const headers = lines[0].split(',');
                const conceptos = headers.slice(1); // Conceptos (columnas 2 en adelante)
                
                // Extraer etiquetas (meses) y datos organizados por concepto
                const mesesLabels = [];
                const dataByConcepto = {};
                
                // Inicializar arrays para cada concepto
                conceptos.forEach(concepto => {
                    dataByConcepto[concepto] = [];
                });
                
                // Procesar cada línea (mes)
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const values = lines[i].split(',');
                        const mesAño = values[0];
                        
                        // Formatear etiqueta del mes (de "2024-01" a "Ene 2024")
                        const [año, mes] = mesAño.split('-');
                        const mesesNombres = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 
                                             'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                        const mesNombre = mesesNombres[parseInt(mes) - 1];
                        mesesLabels.push(`${mesNombre} ${año}`);
                        
                        // Agregar datos para cada concepto
                        for (let j = 1; j < values.length && j <= conceptos.length; j++) {
                            const concepto = conceptos[j - 1];
                            const valor = parseInt(values[j]) || 0;
                            dataByConcepto[concepto].push(valor);
                        }
                    }
                }
                
                // Crear encabezados de la tabla
                let tableHTML = '<thead><tr><th>Concepto</th>';
                mesesLabels.forEach(mes => {
                    tableHTML += `<th>${mes}</th>`;
                });
                tableHTML += '</tr></thead><tbody>';
                
                // Crear filas para cada concepto
                conceptos.forEach(concepto => {
                    tableHTML += '<tr>';
                    tableHTML += `<td>${concepto}</td>`;
                    
                    // Agregar datos mensuales para este concepto
                    dataByConcepto[concepto].forEach(valor => {
                        tableHTML += `<td class="text-right">${valor.toLocaleString()}</td>`;
                    });
                    
                    tableHTML += '</tr>';
                });
                
                // Agregar fila de totales
                tableHTML += '<tr class="total-row">';
                tableHTML += '<td><strong>TOTAL</strong></td>';
                
                // Calcular totales por mes
                for (let mesIndex = 0; mesIndex < mesesLabels.length; mesIndex++) {
                    let totalMes = 0;
                    conceptos.forEach(concepto => {
                        if (dataByConcepto[concepto][mesIndex] !== undefined) {
                            totalMes += dataByConcepto[concepto][mesIndex];
                        }
                    });
                    tableHTML += `<td class="text-right"><strong>${totalMes.toLocaleString()}</strong></td>`;
                }
                
                tableHTML += '</tr>';
                tableHTML += '</tbody>';
                
                // Actualizar la tabla
                const table = document.getElementById('monthly-data-table');
                if (table) {
                    table.innerHTML = tableHTML;
                    console.log('✅ Tabla 4 de datos mensuales creada con', mesesLabels.length, 'meses y', conceptos.length, 'conceptos');
                } else {
                    console.error('❌ No se encontró el elemento monthly-data-table');
                }
                
            } catch (error) {
                console.error('❌ Error cargando tabla mensual:', error);
                
                // Mostrar error en la tabla
                const table = document.getElementById('monthly-data-table');
                if (table) {
                    table.innerHTML = `
                        <thead>
                            <tr>
                                <th>Concepto</th>
                                <th colspan="19">Error cargando datos</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Error cargando datos</td>
                                <td colspan="19">Revisa la consola para más detalles</td>
                            </tr>
                        </tbody>
                    `;
                }
            }
        }

        // Función para crear gráficas mensuales de pie (Gráfica 6)
        function createMonthlyPieCharts() {
            // Colores consistentes para cada concepto (mismos que las gráficas anuales)
            const conceptColors = {
                'OTRAS LEYES Y CODIGOS': '#FF6384',
                'OTROS DELITOS': '#36A2EB', 
                'CONTRA LA SALUD': '#FFCE56',
                'LEY GENERAL DE SALUD (L.G.S.)': '#4BC0C0',
                'LEY FEDERAL CONTRA LA DELINCUENCIA ORGANIZADA (L.F.C.D.O.)': '#FF9F40'
            };
            
            // Colores de respaldo
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
            ];
            
            // Cargar datos del CSV mensual
            fetch('data/monthly_concept_analysis.csv')
                .then(response => response.text())
                .then(csvText => {
                    const lines = csvText.split('\n');
                    const headers = lines[0].split(',');
                    const conceptos = headers.slice(1); // Conceptos (columnas 2 en adelante)
                    
                    // Extraer datos organizados por mes
                    const monthlyData = [];
                    
                    // Procesar cada línea (mes)
                    for (let i = 1; i < lines.length; i++) {
                        if (lines[i].trim()) {
                            const values = lines[i].split(',');
                            const mesAño = values[0];
                            
                            // Formatear etiqueta del mes 
                            const [año, mes] = mesAño.split('-');
                            const mesesNombres = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 
                                                 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                            const mesNombre = mesesNombres[parseInt(mes) - 1];
                            
                            // Crear objeto de datos para este mes
                            const mesData = {
                                id: mesAño,
                                label: `${mesNombre} ${año}`,
                                data: []
                            };
                            
                            // Agregar datos para cada concepto
                            for (let j = 1; j < values.length && j <= conceptos.length; j++) {
                                const concepto = conceptos[j - 1];
                                const valor = parseInt(values[j]) || 0;
                                mesData.data.push({
                                    concepto: concepto,
                                    valor: valor
                                });
                            }
                            
                            monthlyData.push(mesData);
                        }
                    }
                    
                    // Crear un donut chart para cada mes
                    monthlyData.forEach((mesData) => {
                        const canvasId = `monthlyPieChart${mesData.id}`;
                        const canvas = document.getElementById(canvasId);
                        
                        if (canvas) {
                            const ctx = canvas.getContext('2d');
                            
                            // Preparar datos para Chart.js
                            const chartData = {
                                labels: mesData.data.map(item => item.concepto),
                                datasets: [{
                                    data: mesData.data.map(item => item.valor),
                                    backgroundColor: mesData.data.map(item => conceptColors[item.concepto] || colors[mesData.data.indexOf(item) % colors.length]),
                                    borderColor: mesData.data.map(item => conceptColors[item.concepto] || colors[mesData.data.indexOf(item) % colors.length]),
                                    borderWidth: 2,
                                    hoverOffset: 4
                                }]
                            };
                            
                            // Crear el donut chart para este mes (REPLICANDO EXACTAMENTE EL ESTILO ANUAL)
                            new Chart(ctx, {
                                type: 'doughnut',
                                data: chartData,
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    cutout: '40%',  // Tamaño del agujero central
                                    plugins: {
                                        title: {
                                            display: true,
                                            text: mesData.label,
                                            font: {
                                                size: 16
                                            }
                                        },
                                        legend: {
                                            display: false  // Sin leyenda individual (como las anuales)
                                        },
                                        tooltip: {
                                            callbacks: {
                                                label: function(context) {
                                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                                    const shortLabel = context.label.length > 30 ? 
                                                        context.label.substring(0, 15) + '...' : 
                                                        context.label;
                                                    return shortLabel + ': ' + context.parsed.toLocaleString() + ' casos (' + percentage + '%)';
                                                }
                                            }
                                        }
                                    }
                                }
                            });
                        }
                    });
                    
                    console.log('✅ Gráficas mensuales de pie creadas:', monthlyData.length, 'meses');
                })
                .catch(error => {
                    console.error('❌ Error cargando datos para gráficas mensuales de pie:', error);
                });
        }

        // ===== GRÁFICA 7: DISTRIBUCIÓN MENSUAL DE TIPOS POR CONCEPTO =====
        
        // Variables globales para la gráfica 7
        let monthlyTypeChartData = null;
        let currentMonthlyConcept = '';
        
        // Función para cargar conceptos disponibles para gráficas mensuales de tipo
        async function loadAvailableMonthlyTypeConcepts() {
            try {
                console.log('🔄 Cargando conceptos para gráficas mensuales de tipo...');
                
                const response = await fetch('data/monthly_type_distribution_analysis.csv');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                monthlyTypeChartData = parseCSVToMonthlyTypeData(csvText);
                
                const conceptos = Object.keys(monthlyTypeChartData);
                const selector = document.getElementById('monthly-concept-select');
                
                if (selector) {
                    selector.innerHTML = '<option value=""> Selecciona un concepto </option>';
                    conceptos.forEach(concepto => {
                        const option = document.createElement('option');
                        option.value = concepto;
                        option.textContent = concepto;
                        selector.appendChild(option);
                    });
                    
                    console.log('✅ Conceptos mensuales cargados:', conceptos);
                }
                
                // Event listener para el selector (EXACTO COMO GRÁFICA 3)
                selector.addEventListener('change', function() {
                    currentMonthlyConcept = this.value;
                    if (currentMonthlyConcept) {
                        createMonthlyTypePieCharts(currentMonthlyConcept);
                        createMonthlyTypeDistributionTable(currentMonthlyConcept);
                        createMonthlyTypePercentageTable(currentMonthlyConcept);
                    }
                });
                
            } catch (error) {
                console.error('❌ Error cargando conceptos mensuales:', error);
            }
        }
        
        // Función para parsear CSV mensual de tipos a datos estructurados
        function parseCSVToMonthlyTypeData(csvText) {
            const lines = csvText.split('\n');
            const headers = [];
            
            // Parsear headers manualmente para manejar comillas correctamente (IGUAL QUE GRÁFICA 3)
            const firstLine = lines[0];
            let currentHeader = '';
            let inQuotes = false;
            
            for (let i = 0; i < firstLine.length; i++) {
                const char = firstLine[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    headers.push(currentHeader.trim());
                    currentHeader = '';
                } else {
                    currentHeader += char;
                }
            }
            
            if (currentHeader.trim()) {
                headers.push(currentHeader.trim());
            }
            
            const data = {};
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const values = parseCSVLine(line);
                if (values.length < 3) continue;
                
                const concepto = values[0];
                const mesAño = values[1];
                
                if (!data[concepto]) {
                    data[concepto] = {};
                }
                if (!data[concepto][mesAño]) {
                    data[concepto][mesAño] = {};
                }
                
                // Procesar cada tipo (columnas 2 en adelante)
                for (let j = 2; j < values.length && j < headers.length; j++) {
                    const tipoName = headers[j];
                        const value = parseInt(values[j]) || 0;
                    data[concepto][mesAño][tipoName] = value;
                }
            }
            
            return data;
        }
        
        // Función para crear gráficas mensuales de pie por tipo (REPLICANDO EXACTAMENTE GRÁFICA 3)
        function createMonthlyTypePieCharts(concepto) {
            if (!monthlyTypeChartData || !monthlyTypeChartData[concepto]) {
                console.error('No hay datos mensuales para el concepto:', concepto);
                return;
            }
            
            // Lista de meses para mostrar en las gráficas (enero 2024 a julio 2025)
            const meses = [
                '2024-01', '2024-02', '2024-03', '2024-04', '2024-05', '2024-06',
                '2024-07', '2024-08', '2024-09', '2024-10', '2024-11', '2024-12',
                '2025-01', '2025-02', '2025-03', '2025-04', '2025-05', '2025-06', '2025-07'
            ];
            
            // Lista completa incluyendo diciembre 2023 para detectar tipos
            const mesesCompletos = [
                '2023-12', '2024-01', '2024-02', '2024-03', '2024-04', '2024-05', '2024-06',
                '2024-07', '2024-08', '2024-09', '2024-10', '2024-11', '2024-12',
                '2025-01', '2025-02', '2025-03', '2025-04', '2025-05', '2025-06', '2025-07'
            ];
            
            const conceptData = monthlyTypeChartData[concepto];
            
            // Obtener todos los tipos únicos para este concepto usando todos los meses (IGUAL QUE GRÁFICA 3)
            const allTipos = new Set();
            mesesCompletos.forEach(mes => {
                if (conceptData[mes]) {
                    Object.keys(conceptData[mes]).forEach(tipo => {
                        if (conceptData[mes][tipo] > 0) {
                            allTipos.add(tipo);
                        }
                    });
                }
            });
            
            const tiposArray = Array.from(allTipos);
            
            // Generar colores flexibles (IGUAL QUE GRÁFICA 3)
            const colors = generateFlexibleColorsForMonthlyTypes(tiposArray);
            
            console.log(`🎨 Generando gráficas mensuales para concepto: ${concepto}`);
            console.log(`📊 Tipos encontrados: ${tiposArray.length}`, tiposArray);
            
            // Crear un pie chart para cada mes (IGUAL QUE GRÁFICA 3)
            meses.forEach((mes) => {
                const canvasId = `monthlyTypePieChart${mes}`;
                const canvas = document.getElementById(canvasId);
                
                if (canvas) {
                    // Limpiar gráfica anterior
                    if (window[`monthlyTypeChart${mes}`]) {
                        window[`monthlyTypeChart${mes}`].destroy();
                    }
                    
                    const ctx = canvas.getContext('2d');
                    const mesData = conceptData[mes] || {};
                    
                    // Preparar datos y colores para este mes
                    const labels = [];
                    const valores = [];
                    const backgroundColor = [];
                    const borderColor = [];
                    
                    tiposArray.forEach(tipo => {
                        const valor = mesData[tipo] || 0;
                        if (valor > 0) {
                            labels.push(tipo);
                            valores.push(valor);
                            backgroundColor.push(colors[tipo]);
                            borderColor.push(colors[tipo]);
                        }
                    });
                    
                    // Formatear etiqueta del mes
                    const [año, mesNum] = mes.split('-');
                    const mesesNombres = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 
                                         'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                    const mesNombre = mesesNombres[parseInt(mesNum) - 1];
                    const mesLabel = `${mesNombre} ${año}`;
                    
                    // Crear datos para Chart.js
                    const chartData = {
                        labels: labels,
                        datasets: [{
                            data: valores,
                            backgroundColor: backgroundColor,
                            borderColor: borderColor,
                            borderWidth: 2,
                            hoverOffset: 4
                        }]
                    };
                    
                    // Crear el donut chart (EXACTAMENTE COMO GRÁFICA 3)
                    window[`monthlyTypeChart${mes}`] = new Chart(ctx, {
                        type: 'doughnut',
                        data: chartData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '40%',  // Tamaño del agujero central
                            plugins: {
                                title: {
                                    display: true,
                                    text: mesLabel,
                                    font: { size: 16 }
                                },
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                                            
                                            // Acortar nombres largos inteligentemente (IGUAL QUE GRÁFICA 3)
                                            let shortLabel = context.label;
                                            if (context.label.length > 30) {
                                                const lastSpace = context.label.lastIndexOf(' ', 30);
                                                if (lastSpace > 20) {
                                                    shortLabel = context.label.substring(0, lastSpace) + '...';
                                                } else {
                                                    shortLabel = context.label.substring(0, 30) + '...';
                                                }
                                            }
                                            
                                            return shortLabel + ': ' + context.parsed.toLocaleString() + ' casos (' + percentage + '%)';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            });
            
            console.log('✅ Gráficas mensuales de tipo creadas para:', concepto);
        }
        
        // Función para crear tabla mensual de distribución de tipos (IGUAL QUE TABLA 2)
        function createMonthlyTypeDistributionTable(concepto) {
            if (!monthlyTypeChartData || !monthlyTypeChartData[concepto]) {
                console.error('No hay datos mensuales para el concepto:', concepto);
                return;
            }
            
            // Lista de meses para mostrar en la tabla (enero 2024 a julio 2025)
            const meses = [
                '2024-01', '2024-02', '2024-03', '2024-04', '2024-05', '2024-06',
                '2024-07', '2024-08', '2024-09', '2024-10', '2024-11', '2024-12',
                '2025-01', '2025-02', '2025-03', '2025-04', '2025-05', '2025-06', '2025-07'
            ];
            
            // Lista completa incluyendo diciembre 2023 para detectar tipos
            const mesesCompletos = [
                '2023-12', '2024-01', '2024-02', '2024-03', '2024-04', '2024-05', '2024-06',
                '2024-07', '2024-08', '2024-09', '2024-10', '2024-11', '2024-12',
                '2025-01', '2025-02', '2025-03', '2025-04', '2025-05', '2025-06', '2025-07'
            ];
            
            const conceptData = monthlyTypeChartData[concepto];
            
            // Obtener todos los tipos únicos para este concepto usando todos los meses (IGUAL QUE TABLA 2)
            const allTipos = new Set();
            mesesCompletos.forEach(mes => {
                if (conceptData[mes]) {
                    Object.keys(conceptData[mes]).forEach(tipo => {
                        const valor = conceptData[mes][tipo];
                        // Solo incluir tipos que realmente tienen valores > 0 para este concepto específico
                        if (valor > 0 && 
                            tipo !== 'CONCEPTO' && 
                            tipo !== 'MES_AÑO' &&
                            typeof valor === 'number' &&
                            !isNaN(valor)) {
                            allTipos.add(tipo);
                        }
                    });
                }
            });
            
            const tipos = Array.from(allTipos).sort();
            
            // Crear tabla HTML (IGUAL QUE TABLA 2)
            let tableHTML = '<thead><tr><th>Tipo</th>';
            
            // Formatear encabezados de meses
            meses.forEach(mes => {
                const [año, mesNum] = mes.split('-');
                const mesesNombres = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 
                                     'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                const mesNombre = mesesNombres[parseInt(mesNum) - 1];
                const mesLabel = `${mesNombre} ${año}`;
                tableHTML += `<th>${mesLabel}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';
            
            // Procesar cada tipo (IGUAL QUE TABLA 2)
            tipos.forEach(tipo => {
                tableHTML += '<tr>';
                tableHTML += `<td>${tipo}</td>`;
                
                // Agregar valores para cada mes
                meses.forEach(mes => {
                    const value = conceptData[mes] && conceptData[mes][tipo] ? conceptData[mes][tipo] : 0;
                    tableHTML += `<td class="text-right">${value.toLocaleString()}</td>`;
                });
                    
                    tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody>';
            
            // Buscar la tabla de la Gráfica 7 por el título (IGUAL QUE TABLA 2)
            const tableContainers = document.querySelectorAll('.table-container');
            let targetTable = null;
            
            for (let container of tableContainers) {
                const h3 = container.querySelector('h3');
                if (h3 && h3.textContent.includes('Tabla 5')) {
                    targetTable = container;
                    break;
                }
            }
            
            if (targetTable) {
                let table = targetTable.querySelector('table');
                if (!table) {
                    // Crear tabla si no existe
                    table = document.createElement('table');
                    table.className = 'data-table';
                    targetTable.appendChild(table);
                }
                table.innerHTML = tableHTML;
            }
            
            console.log('✅ Tabla mensual de distribución de tipos creada para:', concepto);
        }
        
        // Función para crear tabla mensual de cambios porcentuales de tipos (IGUAL QUE TABLA 2.1)
        function createMonthlyTypePercentageTable(concepto) {
            if (!monthlyTypeChartData || !monthlyTypeChartData[concepto]) {
                console.error('No hay datos mensuales para el concepto:', concepto);
                return;
            }
            
            // Lista completa incluyendo diciembre 2023 como base
            const mesesCompletos = [
                '2023-12', '2024-01', '2024-02', '2024-03', '2024-04', '2024-05', '2024-06',
                '2024-07', '2024-08', '2024-09', '2024-10', '2024-11', '2024-12',
                '2025-01', '2025-02', '2025-03', '2025-04', '2025-05', '2025-06', '2025-07'
            ];
            
            // Lista de meses para mostrar en la tabla (enero 2024 a julio 2025)
            const meses = [
                '2024-01', '2024-02', '2024-03', '2024-04', '2024-05', '2024-06',
                '2024-07', '2024-08', '2024-09', '2024-10', '2024-11', '2024-12',
                '2025-01', '2025-02', '2025-03', '2025-04', '2025-05', '2025-06', '2025-07'
            ];
            
            const conceptData = monthlyTypeChartData[concepto];
            
            // Obtener todos los tipos únicos para este concepto usando meses completos (IGUAL QUE TABLA 2.1)
            const allTipos = new Set();
            mesesCompletos.forEach(mes => {
                if (conceptData[mes]) {
                    Object.keys(conceptData[mes]).forEach(tipo => {
                        const valor = conceptData[mes][tipo];
                        if (valor > 0 && 
                            tipo !== 'CONCEPTO' && 
                            tipo !== 'MES_AÑO' &&
                            typeof valor === 'number' &&
                            !isNaN(valor)) {
                            allTipos.add(tipo);
                        }
                    });
                }
            });
            
            const tipos = Array.from(allTipos).sort();
            
            // Crear tabla HTML (IGUAL QUE TABLA 2.1)
            let tableHTML = '<thead><tr><th>Tipo</th>';
            
            // Formatear encabezados de meses
            meses.forEach(mes => {
                const [año, mesNum] = mes.split('-');
                const mesesNombres = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 
                                     'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                const mesNombre = mesesNombres[parseInt(mesNum) - 1];
                const mesLabel = `${mesNombre} ${año}`;
                tableHTML += `<th>${mesLabel}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';
            
            // Procesar cada tipo (IGUAL QUE TABLA 2.1)
            tipos.forEach(tipo => {
                tableHTML += '<tr>';
                tableHTML += `<td>${tipo}</td>`;
                
                // Agregar cambios porcentuales para cada mes
                meses.forEach((mes, mesIndex) => {
                    // Calcular cambio porcentual respecto al mes anterior (incluyendo diciembre 2023 para enero 2024)
                    const currentMes = mes;
                    let previousMes;
                    
                    if (mesIndex === 0) {
                        // Para enero 2024, usar diciembre 2023 como mes anterior
                        previousMes = '2023-12';
                    } else {
                        // Para los demás meses, usar el mes anterior en la lista
                        previousMes = meses[mesIndex - 1];
                    }
                    
                    const currentValue = conceptData[currentMes] && conceptData[currentMes][tipo] ? conceptData[currentMes][tipo] : 0;
                    const previousValue = conceptData[previousMes] && conceptData[previousMes][tipo] ? conceptData[previousMes][tipo] : 0;
                    
                    let percentageChange = 0;
                    if (previousValue > 0) {
                        percentageChange = ((currentValue - previousValue) / previousValue) * 100;
                    }
                    
                    // Formatear cambios porcentuales con colores (IGUAL QUE TABLA 2.1)
                    let cellClass = 'text-right';
                    let displayValue = '-';
                    
                    if (previousValue > 0) {
                        if (percentageChange > 0) {
                            cellClass += ' positive-change';
                            displayValue = `+${percentageChange.toFixed(1)}%`;
                        } else if (percentageChange < 0) {
                            cellClass += ' negative-change';
                            displayValue = `${percentageChange.toFixed(1)}%`;
                        } else {
                            displayValue = '0.0%';
                        }
                    }
                    
                    tableHTML += `<td class="${cellClass}">${displayValue}</td>`;
                });
                
                tableHTML += '</tr>';
            });
                
                tableHTML += '</tbody>';
                
            // Buscar la tabla de la Gráfica 7 por el título (IGUAL QUE TABLA 2.1)
            const tableContainers = document.querySelectorAll('.table-container');
            let targetTable = null;
            
            for (let container of tableContainers) {
                const h3 = container.querySelector('h3');
                if (h3 && h3.textContent.includes('Tabla 5.1')) {
                    targetTable = container;
                    break;
                }
            }
            
            if (targetTable) {
                let table = targetTable.querySelector('table');
                if (!table) {
                    // Crear tabla si no existe
                    table = document.createElement('table');
                    table.className = 'data-table';
                    targetTable.appendChild(table);
                }
                table.innerHTML = tableHTML;
            }
            
            console.log('✅ Tabla mensual de cambios porcentuales de tipos creada para:', concepto);
        }
        
        // Función para generar colores flexibles para tipos mensuales (IGUAL QUE GRÁFICA 3)
        function generateFlexibleColorsForMonthlyTypes(tipos) {
            const uniqueColors = [
                '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8',
                '#F7DC6F', '#BB8FCE', '#85C1E9', '#F8C471', '#82E0AA', '#F1948A', '#85929E',
                '#AED6F1', '#A3E4D7', '#D5DBDB', '#FADBD8', '#D1F2EB', '#FCF3CF', '#EBDEF0',
                '#D6EAF8', '#D5F4E6', '#FDEAA7', '#FADBD8'
            ];
            
            const colorMap = {};
            tipos.forEach((tipo, index) => {
                colorMap[tipo] = uniqueColors[index % uniqueColors.length];
            });
            
            return colorMap;
        }

        // Función para cargar la tabla de datos nacionales
        async function loadNationalTable() {
            try {
                console.log('🔄 Cargando tabla de datos nacionales...');
                const response = await fetch('data/national_concept_analysis.csv');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                const rows = csvText.split('\n');
                const headers = rows[0].split(',');
                
                // Crear tabla HTML
                let tableHTML = '<thead><tr>';
                headers.forEach(header => {
                    tableHTML += `<th>${header}</th>`;
                });
                tableHTML += '<th>Total</th></tr></thead><tbody>';
                
                // Procesar filas de datos (saltar la primera que son headers)
                for (let i = 1; i < rows.length; i++) {
                    if (rows[i].trim() === '') continue; // Saltar filas vacías
                    
                    const values = rows[i].split(',');
                    if (values.length < headers.length) continue; // Saltar filas incompletas
                    
                    tableHTML += '<tr>';
                    
                    // Primera columna (Concepto)
                    tableHTML += `<td>${values[0]}</td>`;
                    
                    // Columnas de años (convertir a números y formatear)
                    let total = 0;
                    for (let j = 1; j < values.length; j++) {
                        const value = parseInt(values[j]) || 0;
                        total += value;
                        tableHTML += `<td class="text-right">${value.toLocaleString()}</td>`;
                    }
                    
                    // Columna de total
                    tableHTML += `<td class="text-right total-cell"><strong>${total.toLocaleString()}</strong></td>`;
                    
                    tableHTML += '</tr>';
                }
                
                tableHTML += '</tbody>';
                
                // Actualizar la tabla
                document.getElementById('national-concept-table').innerHTML = tableHTML;
                console.log('✅ Tabla nacional actualizada');
                
            } catch (error) {
                console.error('❌ Error cargando tabla nacional:', error);
                document.getElementById('national-concept-table').innerHTML = 
                    '<tbody><tr><td colspan="8">Error cargando datos</td></tr></tbody>';
            }
        }
        
        // ===== FUNCIÓN PARA CARGAR TABLA DE CAMBIOS PORCENTUALES =====
        
        async function loadPercentageChangesTable() {
            try {
                console.log('🔄 Cargando tabla de cambios porcentuales...');
                const response = await fetch('data/national_percentage_analysis.csv');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                const rows = csvText.split('\n');
                const headers = rows[0].split(',');
                
                // Crear tabla HTML
                let tableHTML = '<thead><tr>';
                headers.forEach(header => {
                    tableHTML += `<th>${header}</th>`;
                });
                tableHTML += '</tr></thead><tbody>';
                
                // Procesar filas de datos (saltar la primera que son headers)
                for (let i = 1; i < rows.length; i++) {
                    if (rows[i].trim() === '') continue; // Saltar filas vacías
                    
                    const values = rows[i].split(',');
                    if (values.length < headers.length) continue; // Saltar filas incompletas
                    
                    tableHTML += '<tr>';
                    
                    // Primera columna (Concepto)
                    tableHTML += `<td>${values[0]}</td>`;
                    
                    // Columnas de años (cambios porcentuales)
                    for (let j = 1; j < values.length; j++) {
                        const value = parseFloat(values[j]) || 0;
                        
                        // Formatear cambios porcentuales con colores
                        let cellClass = 'text-right';
                        let displayValue = value;
                        
                        if (value > 0) {
                            cellClass += ' positive-change';
                            displayValue = `+${value.toFixed(1)}%`;
                        } else if (value < 0) {
                            cellClass += ' negative-change';
                            displayValue = `${value.toFixed(1)}%`;
                        } else {
                            displayValue = '0.0%';
                        }
                        
                        tableHTML += `<td class="${cellClass}">${displayValue}</td>`;
                    }
                    
                    tableHTML += '</tr>';
                }
                
                tableHTML += '</tbody>';
                
                // Actualizar la tabla
                document.getElementById('percentage-changes-table').innerHTML = tableHTML;
                console.log('✅ Tabla de cambios porcentuales actualizada');
                
            } catch (error) {
                console.error('❌ Error cargando tabla de cambios porcentuales:', error);
                document.getElementById('percentage-changes-table').innerHTML = 
                    '<tbody><tr><td colspan="7">Error cargando datos</td></tr></tbody>';
            }
        }
        // Función para crear 7 pie charts nacionales (uno por año)
        function createNationalPieCharts() {
            // Colores consistentes para cada concepto (mismos que en la gráfica 1)
            const conceptColors = {
                'OTRAS LEYES Y CODIGOS': '#FF6384',
                'OTROS DELITOS': '#36A2EB', 
                'CONTRA LA SALUD': '#FFCE56',
                'LEY GENERAL DE SALUD (L.G.S.)': '#4BC0C0',
                'LEY FEDERAL CONTRA LA DELINCUENCIA ORGANIZADA (L.F.C.D.O.)': '#FF9F40'
            };
            
            // Colores de respaldo
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
            ];
            
            // Años disponibles
            const years = ['2019', '2020', '2021', '2022', '2023', '2024', '2025'];
            
            // Cargar datos del CSV
            fetch('data/national_concept_analysis.csv')
                .then(response => response.text())
                .then(csvText => {
                    const lines = csvText.split('\n');
                    const headers = lines[0].split(',');
                    
                    // Procesar cada línea (concepto)
                    const conceptData = [];
                    for (let i = 1; i < lines.length; i++) {
                        if (lines[i].trim()) {
                            const values = lines[i].split(',');
                            const concepto = values[0];
                            const data = values.slice(1).map(val => parseInt(val) || 0);
                            
                            conceptData.push({
                                concepto: concepto,
                                data: data
                            });
                        }
                    }
                    
                    // Crear un pie chart para cada año
                    years.forEach((year, yearIndex) => {
                        const canvasId = `pieChart${year}`;
                        const canvas = document.getElementById(canvasId);
                        
                        if (canvas) {
                            const ctx = canvas.getContext('2d');
                            
                            // Preparar datos para este año específico
                            const chartData = {
                                labels: conceptData.map(item => item.concepto),
                                datasets: [{
                                    data: conceptData.map(item => item.data[yearIndex]),
                                    backgroundColor: conceptData.map(item => conceptColors[item.concepto] || colors[conceptData.indexOf(item) % colors.length]),
                                    borderColor: conceptData.map(item => conceptColors[item.concepto] || colors[conceptData.indexOf(item) % colors.length]),
                                    borderWidth: 2,
                                    hoverOffset: 4
                                }]
                            };
                            
                            // Crear el donut chart para este año
                            new Chart(ctx, {
                                type: 'doughnut',
                                data: chartData,
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    cutout: '40%',  // Tamaño del agujero central
                                    plugins: {
                                        title: {
                                            display: true,
                                            text: `Año ${year}`,
                                            font: {
                                                size: 16
                                            }
                                        },
                                        legend: {
                                            display: false
                                        },
                                        tooltip: {
                                            callbacks: {
                                                label: function(context) {
                                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                                    const shortLabel = context.label.length > 30 ? 
                                                        context.label.substring(0, 15) + '...' : 
                                                        context.label;
                                                    return shortLabel + ': ' + context.parsed.toLocaleString() + ' casos (' + percentage + '%)';
                                                }
                                            }
                                        }
                                    }
                                }
                            });
                        }
                    });
                })
                .catch(error => {
                    console.error('Error cargando datos:', error);
                });
        }

        // ===== GRÁFICA 3: DISTRIBUCIÓN DE TIPOS POR CONCEPTO =====

        // Variables globales para la gráfica 3
        let typeChartData = null;
        let currentConcept = '';

        // Función para cargar los conceptos disponibles
        async function loadAvailableConcepts() {
            try {
                const response = await fetch('data/type_distribution_analysis.csv');
                const csvText = await response.text();
                
                const lines = csvText.split('\n');
                const headers = lines[0].split(',');
                
                // Obtener conceptos únicos
                const concepts = new Set();
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const values = lines[i].split(',');
                        if (values.length > 1) {
                            concepts.add(values[0]); // Primera columna es CONCEPTO
                        }
                    }
                }
                
                // Llenar el selector de conceptos
                const conceptSelect = document.getElementById('concept-select');
                conceptSelect.innerHTML = '<option value="">Selecciona un concepto</option>';
                
                Array.from(concepts).sort().forEach(concept => {
                    const option = document.createElement('option');
                    option.value = concept;
                    option.textContent = concept;
                    conceptSelect.appendChild(option);
                });
                

                
                // Cargar datos completos
                typeChartData = parseCSVToData(csvText);
                
                // Event listener para cambios en el selector de conceptos
                conceptSelect.addEventListener('change', function() {
                    currentConcept = this.value;
                    if (currentConcept) {
                        createTypePieCharts(currentConcept);
                        document.getElementById('type-charts-container').style.display = 'block';
                    } else {
                        document.getElementById('type-charts-container').style.display = 'none';
                    }
                });
                
            } catch (error) {
                console.error('❌ Error cargando conceptos:', error);
            }
        }

        // Función para parsear CSV a datos estructurados CORREGIDA
function parseCSVToData(csvText) {
    const lines = csvText.split('\n');
    const headers = [];
    
    // Parsear headers manualmente para manejar comillas correctamente
    const firstLine = lines[0];
    let currentHeader = '';
    let inQuotes = false;
    
    for (let i = 0; i < firstLine.length; i++) {
        const char = firstLine[i];
        
        if (char === '"') {
            inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
            headers.push(currentHeader.trim());
            currentHeader = '';
        } else {
            currentHeader += char;
        }
    }
    headers.push(currentHeader.trim()); // Último header
    
    const data = {};
    
    for (let i = 1; i < lines.length; i++) {
        if (lines[i].trim()) {
            // Parsear valores de la misma manera para manejar comillas
            const values = [];
            let currentValue = '';
            let inQuotes = false;
            
            for (let j = 0; j < lines[i].length; j++) {
                const char = lines[i][j];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    values.push(currentValue.trim());
                    currentValue = '';
                } else {
                    currentValue += char;
                }
            }
            values.push(currentValue.trim()); // Último valor
            
            const concepto = values[0];
            const año = values[1];
            
            if (!data[concepto]) {
                data[concepto] = {};
            }
            
            data[concepto][año] = {};
            
            // Agregar datos de tipos (columnas 2 en adelante)
            // El CSV tiene columnas fijas para todos los conceptos
            for (let j = 2; j < headers.length; j++) {
                const tipo = headers[j];
                // Solo procesar si es un tipo válido (no CONCEPTO ni AÑO)
                if (tipo !== 'CONCEPTO' && tipo !== 'AÑO') {
                    // Manejar valores vacíos correctamente
                    let valor = 0;
                    if (values[j] && values[j].trim() !== '') {
                        valor = parseInt(values[j]) || 0;
                    }
                    data[concepto][año][tipo] = valor;
                }
            }
        }
    }
    
    return data;
}

        // Función para generar colores flexibles únicos basados en los tipos disponibles
        function generateFlexibleColors(tipos) {
            // Paleta de colores únicos y visualmente distintos
            const uniqueColors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                '#FF9F40', '#8AC249', '#FF6B6B', '#4ECDC4', '#45B7D1',
                '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F',
                '#BB8FCE', '#85C1E9', '#F8C471', '#82E0AA', '#F1948A',
                '#D7BDE2', '#A9CCE3', '#F5B7B1', '#D2B4DE', '#AED6F1'
            ];
            
            // Crear mapeo de colores únicos para cada tipo
            const colorMap = {};
            
            tipos.forEach((tipo, index) => {
                // Asignar color único directamente por índice
                colorMap[tipo] = uniqueColors[index];
            });
            
                    return colorMap;
    }

    // Función para crear la tabla de datos de la Gráfica 3
    function createTypeDistributionTable(concepto) {
        if (!typeChartData || !typeChartData[concepto]) {
            console.error('No hay datos para el concepto:', concepto);
            return;
        }
        
        const years = ['2019', '2020', '2021', '2022', '2023', '2024', '2025'];
        const conceptData = typeChartData[concepto];
        
        // Obtener todos los tipos únicos para este concepto
        // El CSV tiene columnas fijas, pero solo mostramos las que tienen datos reales para este concepto
        const allTipos = new Set();
        years.forEach(year => {
            if (conceptData[year]) {
                Object.keys(conceptData[year]).forEach(tipo => {
                    const valor = conceptData[year][tipo];
                    // Solo incluir tipos que realmente tienen valores > 0 para este concepto específico
                    if (valor > 0 && 
                        tipo !== 'CONCEPTO' && 
                        tipo !== 'AÑO' &&
                        typeof valor === 'number' &&
                        !isNaN(valor)) {
                        allTipos.add(tipo);
                    }
                });
            }
        });
        
        const tipos = Array.from(allTipos).sort();
                
                // Crear tabla HTML
        let tableHTML = '<thead><tr><th>Tipo</th>';
        years.forEach(year => {
            tableHTML += `<th>${year}</th>`;
                });
                tableHTML += '</tr></thead><tbody>';
                
        // Procesar cada tipo
        tipos.forEach(tipo => {
            tableHTML += '<tr>';
            tableHTML += `<td>${tipo}</td>`;
            
            // Agregar valores para cada año
            years.forEach(year => {
                const value = conceptData[year] && conceptData[year][tipo] ? conceptData[year][tipo] : 0;
                tableHTML += `<td class="text-right">${value.toLocaleString()}</td>`;
            });
            
            tableHTML += '</tr>';
        });
        
        tableHTML += '</tbody>';
        
        // Buscar la tabla de la Gráfica 3 por el título
        const tableContainers = document.querySelectorAll('.table-container');
        let targetTable = null;
        
        for (let container of tableContainers) {
            const h3 = container.querySelector('h3');
            if (h3 && h3.textContent.includes('Tabla 2')) {
                targetTable = container;
                break;
            }
        }
        
        if (targetTable) {
            let table = targetTable.querySelector('table');
            if (!table) {
                // Crear tabla si no existe
                table = document.createElement('table');
                table.className = 'data-table';
                targetTable.appendChild(table);
            }
            table.innerHTML = tableHTML;
        }
        
        console.log('✅ Tabla de distribución de tipos creada para:', concepto);
    }

    // Función para crear la tabla de cambios porcentuales de la Gráfica 3
    function createTypePercentageTable(concepto) {
        if (!typeChartData || !typeChartData[concepto]) {
            console.error('No hay datos para el concepto:', concepto);
            return;
        }
        
        const years = ['2019', '2020', '2021', '2022', '2023', '2024', '2025'];
        const conceptData = typeChartData[concepto];
        
        // Obtener todos los tipos únicos para este concepto
        const allTipos = new Set();
        years.forEach(year => {
            if (conceptData[year]) {
                Object.keys(conceptData[year]).forEach(tipo => {
                    const valor = conceptData[year][tipo];
                    if (valor > 0 && 
                        tipo !== 'CONCEPTO' && 
                        tipo !== 'AÑO' &&
                        typeof valor === 'number' &&
                        !isNaN(valor)) {
                        allTipos.add(tipo);
                    }
                });
            }
        });
        
        const tipos = Array.from(allTipos).sort();
        
        // Crear tabla HTML
        let tableHTML = '<thead><tr><th>Tipo</th>';
        years.forEach(year => {
            tableHTML += `<th>${year}</th>`;
        });
        tableHTML += '</tr></thead><tbody>';
        
        // Procesar cada tipo
        tipos.forEach(tipo => {
                    tableHTML += '<tr>';
            tableHTML += `<td>${tipo}</td>`;
            
            // Agregar cambios porcentuales para cada año
            years.forEach((year, yearIndex) => {
                if (yearIndex === 0) {
                    // Para 2019, usar 2018 como año base si está disponible
                    const year2018 = conceptData['2018'];
                    const year2019 = conceptData[year];
                    
                    if (year2018 && year2018[tipo] && year2018[tipo] > 0 && 
                        year2019 && year2019[tipo] && year2019[tipo] > 0) {
                        
                        const percentageChange = ((year2019[tipo] - year2018[tipo]) / year2018[tipo]) * 100;
                        
                        // Formatear cambios porcentuales con colores
                        let cellClass = 'text-right';
                        let displayValue = '-';
                        
                        if (percentageChange > 0) {
                            cellClass += ' positive-change';
                            displayValue = `+${percentageChange.toFixed(1)}%`;
                        } else if (percentageChange < 0) {
                            cellClass += ' negative-change';
                            displayValue = `${percentageChange.toFixed(1)}%`;
                        } else {
                            displayValue = '0.0%';
                        }
                        
                        tableHTML += `<td class="${cellClass}">${displayValue}</td>`;
                    } else {
                        // Si no hay datos de 2018 o 2019, mostrar guión
                        tableHTML += '<td class="text-right">-</td>';
                    }
                } else {
                    const currentYear = parseInt(year);
                    const previousYear = currentYear - 1;
                    const currentValue = conceptData[year] && conceptData[year][tipo] ? conceptData[year][tipo] : 0;
                    const previousValue = conceptData[previousYear] && conceptData[previousYear][tipo] ? conceptData[previousYear][tipo] : 0;
                    
                    let percentageChange = 0;
                    if (previousValue > 0) {
                        percentageChange = ((currentValue - previousValue) / previousValue) * 100;
                    }
                    
                    // Formatear cambios porcentuales con colores
                    let cellClass = 'text-right';
                    let displayValue = '-';
                    
                    if (previousValue > 0) {
                        if (percentageChange > 0) {
                            cellClass += ' positive-change';
                            displayValue = `+${percentageChange.toFixed(1)}%`;
                        } else if (percentageChange < 0) {
                            cellClass += ' negative-change';
                            displayValue = `${percentageChange.toFixed(1)}%`;
                        } else {
                            displayValue = '0.0%';
                        }
                    }
                    
                    tableHTML += `<td class="${cellClass}">${displayValue}</td>`;
                }
            });
            
            tableHTML += '</tr>';
        });
                
                tableHTML += '</tbody>';
                
        // Buscar la tabla de la Gráfica 3 por el título
        const tableContainers = document.querySelectorAll('.table-container');
        let targetTable = null;
        
        for (let container of tableContainers) {
            const h3 = container.querySelector('h3');
            if (h3 && h3.textContent.includes('Tabla 2.1')) {
                targetTable = container;
                break;
            }
        }
        
        if (targetTable) {
            let table = targetTable.querySelector('table');
            if (!table) {
                // Crear tabla si no existe
                table = document.createElement('table');
                table.className = 'data-table';
                targetTable.appendChild(table);
            }
            table.innerHTML = tableHTML;
        }
        
        console.log('✅ Tabla de cambios porcentuales creada para:', concepto);
    }

    // Función para crear los pie charts de tipos
        function createTypePieCharts(concepto) {
            if (!typeChartData || !typeChartData[concepto]) {
                console.error('No hay datos para el concepto:', concepto);
                return;
            }
            
            const years = ['2019', '2020', '2021', '2022', '2023', '2024', '2025'];
            const conceptData = typeChartData[concepto];
            
            // Obtener todos los tipos únicos para este concepto
            const allTipos = new Set();
            years.forEach(year => {
                if (conceptData[year]) {
                    Object.keys(conceptData[year]).forEach(tipo => {
                        if (conceptData[year][tipo] > 0) {
                            allTipos.add(tipo);
                        }
                    });
                }
            });
            
            // Generar colores flexibles para todos los tipos
            const typeColors = generateFlexibleColors(Array.from(allTipos));
            
            // Crear un pie chart para cada año
            years.forEach(year => {
                const canvasId = `typePieChart${year}`;
                const canvas = document.getElementById(canvasId);
                
                if (canvas && conceptData[year]) {
                    const ctx = canvas.getContext('2d');
                    
                    // Destruir chart anterior si existe
                    if (window[`typeChart${year}`]) {
                        window[`typeChart${year}`].destroy();
                    }
                    
                                // Preparar datos para este año
            const yearData = conceptData[year];
            // Filtrar solo tipos con valores > 0 para este concepto específico
            // El CSV tiene columnas fijas, pero solo mostramos las que tienen datos reales
            const tipos = Object.keys(yearData).filter(tipo => {
                const valor = yearData[tipo];
                // Solo incluir tipos que realmente tienen valores > 0 para este concepto
                return valor > 0 && 
                       tipo !== 'CONCEPTO' && 
                       tipo !== 'AÑO' &&
                       typeof valor === 'number' &&
                       !isNaN(valor);
            });
            const valores = tipos.map(tipo => yearData[tipo]);
                    
                    // Preparar colores usando el mapeo flexible
                    const backgroundColor = tipos.map(tipo => typeColors[tipo]);
                    const borderColor = backgroundColor;
                    
                    const chartData = {
                        labels: tipos,
                        datasets: [{
                            data: valores,
                            backgroundColor: backgroundColor,
                            borderColor: borderColor,
                            borderWidth: 2,
                            hoverOffset: 4
                        }]
                    };
                    
                                // Crear el donut chart
            window[`typeChart${year}`] = new Chart(ctx, {
                type: 'doughnut',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '40%',  // Tamaño del agujero central
                    plugins: {
                        title: {
                            display: true,
                            text: `Año ${year}`,
                            font: { size: 16 }
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    
                                    // Acortar nombres largos inteligentemente
                                    let shortLabel = context.label;
                                    if (context.label.length > 30) {
                                        // Buscar el último espacio antes del límite
                                        const lastSpace = context.label.lastIndexOf(' ', 30);
                                        if (lastSpace > 20) {
                                            shortLabel = context.label.substring(0, lastSpace) + '...';
                                        } else {
                                            shortLabel = context.label.substring(0, 30) + '...';
                                        }
                                    }
                                    
                                    return shortLabel + ': ' + context.parsed.toLocaleString() + ' casos (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
                }
            });
            
                console.log('✅ Pie charts de tipos creados para:', concepto);
    console.log('🎨 Tipos encontrados:', Array.from(allTipos));
    console.log('🎨 Colores asignados:', typeColors);
    
    // Crear también la tabla de datos
    createTypeDistributionTable(concepto);
    
    // Crear también la tabla de cambios porcentuales
    createTypePercentageTable(concepto);
}
        // ===== EVENT LISTENERS Y INICIALIZACIÓN =====
        
        // Cargar todos los datos cuando la página se cargue
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Página cargada, iniciando carga de datos...');
            
            // Cargar estadísticas
            loadOriginalStats();
            loadProcessedStats();
            loadProcessedPreview();
            loadNationalTable();
            loadPercentageChangesTable();
            loadAvailableConcepts();
            
            // Cargar datos de tipos para el segundo mapa
            loadTipoData().then(() => {
                // Cargar conceptos para el mapa (después de cargar tipos)
                loadAvailableConceptsForMap();
            });
            
            // Cargar datos de variación porcentual
            loadPercentageData();
            loadTipoPercentageData();
            
            // Crear gráfica nacional
            createNationalStackedChart();
            createNationalPieCharts();
            
            // Crear gráfica mensual
            createMonthlyStackedChart();
            
            // Cargar tabla mensual
            loadMonthlyTable();
            
            // Crear gráficas mensuales de pie
            createMonthlyPieCharts();
            
            // Cargar conceptos para gráficas mensuales de tipo
            loadAvailableMonthlyTypeConcepts();
            
            // Crear mapa de estados
            createEstadosMap();
            
            // Cargar conceptos para el mapa
            loadAvailableConceptsForMap();
            
            // Crear mapas mensuales de estados
            createMonthlyEstadosMap();
            
            // Cargar conceptos para mapas mensuales
            loadAvailableConceptsForMonthlyMap();
            
            // Cargar datos estatales
            loadEstatalData();
            
            // Cargar datos para Gráfica Estatal 2
            loadEstatal2Data();
        });
        
        // ===========================================
        // FUNCIONES PARA MAPAS MENSUALES (GRÁFICA 8)
        // ===========================================
        
        // Variables globales para mapas mensuales
        let monthlyMap = null;
        let monthlyMap2 = null;
        let monthlyEntidadConceptoData = null;
        let monthlyEntidadTipoData = null;
        let monthlyEntidadConceptoPercentageData = null;
        let monthlyEntidadTipoPercentageData = null;
        let currentMonthlyConcepto = '';
        let currentMonthlyTipo = '';
        let currentMonth = '2024-02';
        
        // Función para cargar conceptos disponibles para mapas mensuales
        async function loadAvailableConceptsForMonthlyMap() {
            try {
                console.log('🔄 Cargando conceptos para mapas mensuales...');
                
                const response = await fetch('data/monthly_entidad_concepto_analysis.csv');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                console.log('✅ CSV cargado para mapas mensuales, longitud:', csvText.length);
                
                // Parsear CSV
                const lines = csvText.split('\n');
                console.log('📊 Líneas en CSV:', lines.length);
                console.log('📋 Headers:', lines[0]);
                
                const headers = lines[0].split(',');
                const conceptos = [...new Set(lines.slice(1).map(line => {
                    const values = line.split(',');
                    return values[1]; // CONCEPTO está en la columna 1
                }).filter(Boolean))];
                
                console.log('🎯 Conceptos encontrados para mapas mensuales:', conceptos);
                
                // Cargar datos completos
                monthlyEntidadConceptoData = parseCSVToMonthlyEntidadConceptoData(csvText);
                console.log('📊 Datos parseados para mapas mensuales:', monthlyEntidadConceptoData);
                
                // Poblar selector de conceptos
                const conceptSelector = document.getElementById('monthly-map-concept-selector');
                if (conceptSelector) {
                    conceptSelector.innerHTML = '<option value="">Selecciona un concepto...</option>';
                    conceptos.forEach(concepto => {
                        const option = document.createElement('option');
                        option.value = concepto;
                        option.textContent = concepto;
                        conceptSelector.appendChild(option);
                    });
                    
                    // Event listener para cambios de concepto
                    conceptSelector.addEventListener('change', function() {
                        currentMonthlyConcepto = this.value;
                        console.log('📋 Concepto mensual seleccionado:', currentMonthlyConcepto);
                        
                        const typeSelector = document.getElementById('monthly-map-type-selector');
                        
                        if (currentMonthlyConcepto) {
                            // Habilitar selector de tipos y cargar datos
                            if (typeSelector) {
                                typeSelector.disabled = false;
                                typeSelector.innerHTML = '<option value="">Cargando tipos...</option>';
                            }
                            
                            updateMonthlyMapColors(currentMonthlyConcepto, currentMonth);
                            loadMonthlyTypesForConcept(currentMonthlyConcepto);
                            updateMonthlyEntidadConceptoTable(currentMonthlyConcepto);
                            updateMonthlyEntidadConceptoPercentageTable(currentMonthlyConcepto);
                        } else {
                            // Deshabilitar selector de tipos y limpiar segundo mapa
                            if (typeSelector) {
                                typeSelector.disabled = true;
                                typeSelector.innerHTML = '<option value="">Primero selecciona un concepto...</option>';
                            }
                            if (monthlyMap2) {
                                monthlyMap2.remove();
                                monthlyMap2 = null;
                            }
                        }
                    });
                    
                    console.log('✅ Selector de conceptos mensuales configurado');
                }
                
                // Configurar slider de mes
                const monthSlider = document.getElementById('monthly-map-month-slider');
                const monthDisplay = document.getElementById('monthly-month-display');
                
                if (monthSlider && monthDisplay) {
                    // Array de meses en orden
                    const months = [
                        { id: '2024-01', name: 'Enero 2024' },
                        { id: '2024-02', name: 'Febrero 2024' },
                        { id: '2024-03', name: 'Marzo 2024' },
                        { id: '2024-04', name: 'Abril 2024' },
                        { id: '2024-05', name: 'Mayo 2024' },
                        { id: '2024-06', name: 'Junio 2024' },
                        { id: '2024-07', name: 'Julio 2024' },
                        { id: '2024-08', name: 'Agosto 2024' },
                        { id: '2024-09', name: 'Septiembre 2024' },
                        { id: '2024-10', name: 'Octubre 2024' },
                        { id: '2024-11', name: 'Noviembre 2024' },
                        { id: '2024-12', name: 'Diciembre 2024' },
                        { id: '2025-01', name: 'Enero 2025' },
                        { id: '2025-02', name: 'Febrero 2025' },
                        { id: '2025-03', name: 'Marzo 2025' },
                        { id: '2025-04', name: 'Abril 2025' },
                        { id: '2025-05', name: 'Mayo 2025' },
                        { id: '2025-06', name: 'Junio 2025' },
                        { id: '2025-07', name: 'Julio 2025' }
                    ];
                    
                    // Event listener para cambios del slider de mes
                    monthSlider.addEventListener('input', function() {
                        const monthIndex = parseInt(this.value) - 1; // Convertir de 1-19 a 0-18
                        const selectedMonth = months[monthIndex];
                        
                        if (selectedMonth) {
                            currentMonth = selectedMonth.id;
                            monthDisplay.textContent = selectedMonth.name;
                            console.log('📅 Mes actualizado:', currentMonth);
                            
                            if (currentMonthlyConcepto) {
                                updateMonthlyMapColors(currentMonthlyConcepto, currentMonth);
                            }
                            
                            // Actualizar segundo mapa si hay tipo seleccionado
                            if (currentMonthlyTipo && currentMonthlyConcepto && monthlyMap2) {
                                updateMonthlySecondMapColors(currentMonthlyConcepto, currentMonthlyTipo, currentMonth);
                            }
                        }
                    });
                    
                    // Inicializar con Febrero 2024 (valor 2)
                    currentMonth = '2024-02';
                    monthDisplay.textContent = 'Febrero 2024';
                    
                    console.log('✅ Slider de mes mensual configurado');
                }
                
                // Cargar datos porcentuales
                await loadMonthlyEntidadConceptoPercentageData();
                
            } catch (error) {
                console.error('❌ Error cargando conceptos para mapas mensuales:', error);
            }
        }
        
        // Función para parsear CSV de entidad-concepto mensual
        function parseCSVToMonthlyEntidadConceptoData(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = {};
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                if (values.length < headers.length) continue;
                
                const entidad = values[0];
                const concepto = values[1];
                
                if (!data[concepto]) {
                    data[concepto] = {};
                }
                if (!data[concepto][entidad]) {
                    data[concepto][entidad] = {};
                }
                
                // Agregar datos mensuales (desde columna 2 en adelante)
                for (let j = 2; j < headers.length; j++) {
                    const month = headers[j];
                    const value = parseInt(values[j]) || 0;
                    data[concepto][entidad][month] = value;
                }
            }
            
            return data;
        }
        
        // Función para crear mapas mensuales de estados
        function createMonthlyEstadosMap() {
            try {
                // Verificar que Leaflet está disponible
                if (typeof L === 'undefined') {
                    console.error('❌ Leaflet no está cargado para mapas mensuales. Esperando...');
                    setTimeout(createMonthlyEstadosMap, 1000); // Reintentar en 1 segundo
                    return;
                }
                
                // Verificar que el contenedor existe
                const mapContainer = document.getElementById('monthly-map');
                if (!mapContainer) {
                    console.error('❌ No se encontró el contenedor del mapa mensual');
                    return;
                }
                
                // Crear el mapa centrado en México (sin capa base)
                monthlyMap = L.map('monthly-map', {
                    center: [23.6345, -102.5528],
                    zoom: 5,
                    zoomControl: true,
                    attributionControl: false
                });
                
                // Establecer límites del mapa para que no se pueda alejar demasiado
                monthlyMap.setMaxBounds([14.5, -118.5, 32.5, -86.5]); // Límites de México
                
                // Cargar GeoJSON de estados
                fetch('data/geojson/estados_compressed.json')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(geojsonData => {
                        // Agregar estados al mapa
                        const estadosLayer = L.geoJSON(geojsonData, {
                            style: function(feature) {
                                return {
                                    fillColor: '#3498db',
                                    weight: 1.5,
                                    opacity: 1,
                                    color: '#2c3e50',
                                    fillOpacity: 0.8
                                };
                            },
                            onEachFeature: function(feature, layer) {
                                // Sin efectos de hover - idéntico a Gráfica 4
                            }
                        }).addTo(monthlyMap);
                        
                        console.log('✅ Mapa mensual de estados creado exitosamente');
                        
                        // Marcar como cargado para ocultar mensaje de carga
                        mapContainer.classList.add('loaded');
                        
                    })
                    .catch(error => {
                        console.error('❌ Error cargando GeoJSON para mapa mensual:', error);
                    });
                
            } catch (error) {
                console.error('❌ Error creando mapa mensual de estados:', error);
            }
        }
        
        // Función para actualizar colores del mapa mensual
        function updateMonthlyMapColors(concepto, month) {
            if (!monthlyMap || !monthlyEntidadConceptoData || !monthlyEntidadConceptoData[concepto]) {
                console.warn('⚠️ No se pueden actualizar colores del mapa mensual - datos no disponibles');
                return;
            }
            
            console.log(`🎨 Actualizando colores del mapa mensual para concepto: ${concepto}, mes: ${month}`);
            
            const conceptoData = monthlyEntidadConceptoData[concepto];
            
            // Obtener todos los valores para este concepto y mes
            const values = [];
            Object.keys(conceptoData).forEach(entidad => {
                if (conceptoData[entidad][month] !== undefined) {
                    values.push(conceptoData[entidad][month]);
                }
            });
            
            if (values.length === 0) {
                console.warn('⚠️ No hay datos disponibles para este concepto y mes');
                return;
            }
            
            // Calcular percentiles para la escala de colores
            values.sort((a, b) => a - b);
            const percentiles = {
                p0: values[0],
                p20: values[Math.floor(values.length * 0.2)],
                p40: values[Math.floor(values.length * 0.4)],
                p60: values[Math.floor(values.length * 0.6)],
                p80: values[Math.floor(values.length * 0.8)],
                p90: values[Math.floor(values.length * 0.9)],
                p100: values[values.length - 1]
            };
            
            console.log('📊 Percentiles calculados:', percentiles);
            
            // Función para obtener color basado en valor
            function getColor(value) {
                if (value === 0) return '#ffffff';
                if (value <= percentiles.p20) return '#ffebee';
                if (value <= percentiles.p40) return '#ffcdd2';
                if (value <= percentiles.p60) return '#ef9a9a';
                if (value <= percentiles.p80) return '#e57373';
                if (value <= percentiles.p90) return '#ef5350';
                return '#f44336';
            }
            
            // Actualizar colores de cada estado
            monthlyMap.eachLayer(function(layer) {
                if (layer.feature && layer.feature.properties) {
                    const entidadName = layer.feature.properties.NOMGEO.toUpperCase(); // Convertir a mayúsculas para coincidir con CSV
                    const value = conceptoData[entidadName] ? (conceptoData[entidadName][month] || 0) : 0;
                    
                    layer.setStyle({
                        fillColor: getColor(value),
                        fillOpacity: 0.7
                    });
                    
                    // Actualizar tooltip
                    const displayName = layer.feature.properties.NOMGEO; // Nombre original para mostrar
                    layer.bindTooltip(`
                        <strong>${displayName}</strong><br/>
                        ${concepto}<br/>
                        ${month}: ${value.toLocaleString()} casos
                    `);
                }
            });
            
            console.log('✅ Colores del mapa mensual actualizados');
        }
        
        // Función para cargar tipos disponibles para un concepto mensual
        async function loadMonthlyTypesForConcept(concepto) {
            try {
                console.log('🔄 Cargando tipos para concepto mensual:', concepto);
                
                // Cargar datos de tipo si no están disponibles
                if (!monthlyEntidadTipoData) {
                    const response = await fetch('data/monthly_entidad_tipo_analysis.csv');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const csvText = await response.text();
                    monthlyEntidadTipoData = parseCSVToMonthlyEntidadTipoData(csvText);
                }
                
                // Obtener tipos únicos para este concepto
                const tipos = new Set();
                if (monthlyEntidadTipoData[concepto]) {
                    Object.keys(monthlyEntidadTipoData[concepto]).forEach(entidad => {
                        Object.keys(monthlyEntidadTipoData[concepto][entidad]).forEach(tipo => {
                            tipos.add(tipo);
                        });
                    });
                }
                
                const tiposArray = Array.from(tipos).sort();
                console.log('🏷️ Tipos encontrados para concepto mensual:', tiposArray);
                
                // Poblar selector de tipos
                const typeSelector = document.getElementById('monthly-map-type-selector');
                if (typeSelector) {
                    typeSelector.innerHTML = '<option value="">Selecciona un tipo...</option>';
                    tiposArray.forEach(tipo => {
                        const option = document.createElement('option');
                        option.value = tipo;
                        option.textContent = tipo;
                        typeSelector.appendChild(option);
                    });
                    
                    // Event listener para cambios de tipo
                    typeSelector.removeEventListener('change', handleMonthlyTypeChange); // Remover listener anterior
                    typeSelector.addEventListener('change', handleMonthlyTypeChange);
                    
                    console.log('✅ Selector de tipos mensuales configurado');
                }
                
            } catch (error) {
                console.error('❌ Error cargando tipos para concepto mensual:', error);
            }
        }
        
        // Handler para cambio de tipo mensual
        function handleMonthlyTypeChange(event) {
            currentMonthlyTipo = event.target.value;
            console.log('🏷️ Tipo mensual seleccionado:', currentMonthlyTipo);
            
            if (currentMonthlyTipo && currentMonthlyConcepto) {
                createMonthlySecondMap(currentMonthlyConcepto, currentMonthlyTipo, currentMonth);
                updateMonthlyEntidadTipoTable(currentMonthlyConcepto, currentMonthlyTipo);
                updateMonthlyEntidadTipoPercentageTable(currentMonthlyConcepto, currentMonthlyTipo);
            } else {
                // Limpiar segundo mapa si no hay tipo seleccionado
                if (monthlyMap2) {
                    monthlyMap2.remove();
                    monthlyMap2 = null;
                }
            }
        }
        
        // Función para parsear CSV de entidad-tipo mensual
        function parseCSVToMonthlyEntidadTipoData(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = {};
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                if (values.length < headers.length) continue;
                
                const entidad = values[0];
                const concepto = values[1];
                const tipo = values[2];
                
                if (!data[concepto]) {
                    data[concepto] = {};
                }
                if (!data[concepto][entidad]) {
                    data[concepto][entidad] = {};
                }
                if (!data[concepto][entidad][tipo]) {
                    data[concepto][entidad][tipo] = {};
                }
                
                // Agregar datos mensuales (desde columna 3 en adelante)
                for (let j = 3; j < headers.length; j++) {
                    const month = headers[j];
                    const value = parseInt(values[j]) || 0;
                    data[concepto][entidad][tipo][month] = value;
                }
            }
            
            return data;
        }
        
        // Función para crear segundo mapa mensual
        function createMonthlySecondMap(concepto, tipo, month) {
            try {
                // Limpiar mapa anterior si existe
                if (monthlyMap2) {
                    monthlyMap2.remove();
                    monthlyMap2 = null;
                }
                
                // Verificar que el contenedor existe
                const mapContainer = document.getElementById('monthly-map2');
                if (!mapContainer) {
                    console.error('❌ No se encontró el contenedor del segundo mapa mensual');
                    return;
                }
                
                // Limpiar placeholder
                mapContainer.innerHTML = '';
                mapContainer.classList.remove('placeholder');
                
                // Crear el segundo mapa
                monthlyMap2 = L.map('monthly-map2', {
                    center: [23.6345, -102.5528],
                    zoom: 5,
                    zoomControl: true,
                    attributionControl: false
                });
                
                // Establecer límites del mapa
                monthlyMap2.setMaxBounds([14.5, -118.5, 32.5, -86.5]);
                
                // Cargar GeoJSON de estados para el segundo mapa
                fetch('data/geojson/estados_compressed.json')
                    .then(response => response.json())
                    .then(geojsonData => {
                        const estadosLayer = L.geoJSON(geojsonData, {
                            style: function(feature) {
                                return {
                                    fillColor: '#3498db',
                                    weight: 1.5,
                                    opacity: 1,
                                    color: '#2c3e50',
                                    fillOpacity: 0.8
                                };
                            },
                            onEachFeature: function(feature, layer) {
                                // Sin efectos de hover - idéntico a Gráfica 4
                            }
                        }).addTo(monthlyMap2);
                        
                        console.log('✅ Segundo mapa mensual creado exitosamente');
                        
                        // Marcar como cargado para ocultar mensaje de carga
                        mapContainer.classList.add('loaded');
                        
                        // Actualizar colores inmediatamente
                        updateMonthlySecondMapColors(concepto, tipo, month);
                        
                    })
                    .catch(error => {
                        console.error('❌ Error cargando GeoJSON para segundo mapa mensual:', error);
                    });
                
            } catch (error) {
                console.error('❌ Error creando segundo mapa mensual:', error);
            }
        }
        
        // Función para actualizar colores del segundo mapa mensual
        function updateMonthlySecondMapColors(concepto, tipo, month) {
            if (!monthlyMap2 || !monthlyEntidadTipoData || !monthlyEntidadTipoData[concepto]) {
                console.warn('⚠️ No se pueden actualizar colores del segundo mapa mensual - datos no disponibles');
                return;
            }
            
            console.log(`🎨 Actualizando colores del segundo mapa mensual para concepto: ${concepto}, tipo: ${tipo}, mes: ${month}`);
            
            const conceptoData = monthlyEntidadTipoData[concepto];
            
            // Obtener todos los valores para este concepto, tipo y mes
            const values = [];
            Object.keys(conceptoData).forEach(entidad => {
                if (conceptoData[entidad][tipo] && conceptoData[entidad][tipo][month] !== undefined) {
                    values.push(conceptoData[entidad][tipo][month]);
                }
            });
            
            if (values.length === 0) {
                console.warn('⚠️ No hay datos disponibles para este concepto, tipo y mes');
                return;
            }
            
            // Calcular percentiles para la escala de colores
            values.sort((a, b) => a - b);
            const percentiles = {
                p0: values[0],
                p20: values[Math.floor(values.length * 0.2)],
                p40: values[Math.floor(values.length * 0.4)],
                p60: values[Math.floor(values.length * 0.6)],
                p80: values[Math.floor(values.length * 0.8)],
                p90: values[Math.floor(values.length * 0.9)],
                p100: values[values.length - 1]
            };
            
            // Función para obtener color basado en valor
            function getColor(value) {
                if (value === 0) return '#ffffff';
                if (value <= percentiles.p20) return '#ffebee';
                if (value <= percentiles.p40) return '#ffcdd2';
                if (value <= percentiles.p60) return '#ef9a9a';
                if (value <= percentiles.p80) return '#e57373';
                if (value <= percentiles.p90) return '#ef5350';
                return '#f44336';
            }
            
            // Actualizar colores de cada estado
            monthlyMap2.eachLayer(function(layer) {
                if (layer.feature && layer.feature.properties) {
                    const entidadName = layer.feature.properties.NOMGEO.toUpperCase(); // Convertir a mayúsculas para coincidir con CSV
                    const value = (conceptoData[entidadName] && conceptoData[entidadName][tipo]) ? 
                                  (conceptoData[entidadName][tipo][month] || 0) : 0;
                    
                    layer.setStyle({
                        fillColor: getColor(value),
                        fillOpacity: 0.7
                    });
                    
                    // Actualizar tooltip
                    const displayName = layer.feature.properties.NOMGEO; // Nombre original para mostrar
                    layer.bindTooltip(`
                        <strong>${displayName}</strong><br/>
                        ${concepto} - ${tipo}<br/>
                        ${month}: ${value.toLocaleString()} casos
                    `);
                }
            });
            
            console.log('✅ Colores del segundo mapa mensual actualizados');
        }
        
        // Función para cargar datos porcentuales mensuales
        async function loadMonthlyEntidadConceptoPercentageData() {
            try {
                console.log('🔄 Cargando datos porcentuales mensuales de entidad-concepto...');
                const response = await fetch('data/monthly_entidad_concepto_percentage_analysis.csv');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                monthlyEntidadConceptoPercentageData = parseCSVToMonthlyEntidadConceptoData(csvText);
                console.log('✅ Datos porcentuales mensuales de entidad-concepto cargados');
            } catch (error) {
                console.error('❌ Error cargando datos porcentuales mensuales:', error);
            }
        }
        
        // Función para actualizar tabla de entidad-concepto mensual
        function updateMonthlyEntidadConceptoTable(concepto) {
            if (!monthlyEntidadConceptoData || !monthlyEntidadConceptoData[concepto]) {
                console.warn('⚠️ No hay datos disponibles para la tabla de entidad-concepto mensual');
                return;
            }
            
            console.log('📊 Actualizando tabla de entidad-concepto mensual para:', concepto);
            
            const table = document.getElementById('monthly-entidad-concepto-table');
            if (!table) return;
            
            const tbody = table.querySelector('tbody');
            if (!tbody) return;
            
            const conceptoData = monthlyEntidadConceptoData[concepto];
            const entidades = Object.keys(conceptoData).sort();
            
            // Meses disponibles
            const meses = ['2024-01', '2024-02', '2024-03', '2024-04', '2024-05', '2024-06', '2024-07', '2024-08', '2024-09', '2024-10', '2024-11', '2024-12', '2025-01', '2025-02', '2025-03', '2025-04', '2025-05', '2025-06', '2025-07'];
            
            let tableHTML = '';
            entidades.forEach(entidad => {
                tableHTML += '<tr>';
                tableHTML += `<td>${entidad}</td>`;
                
                let total = 0;
                meses.forEach(mes => {
                    const value = conceptoData[entidad][mes] || 0;
                    total += value;
                    tableHTML += `<td class="text-right">${value.toLocaleString()}</td>`;
                });
                
                tableHTML += `<td class="text-right font-bold">${total.toLocaleString()}</td>`;
                tableHTML += '</tr>';
            });
            
            tbody.innerHTML = tableHTML;
            console.log('✅ Tabla de entidad-concepto mensual actualizada');
        }
        
        // Función para actualizar tabla porcentual de entidad-concepto mensual
        function updateMonthlyEntidadConceptoPercentageTable(concepto) {
            if (!monthlyEntidadConceptoPercentageData || !monthlyEntidadConceptoPercentageData[concepto]) {
                console.warn('⚠️ No hay datos porcentuales disponibles para la tabla de entidad-concepto mensual');
                return;
            }
            
            console.log('📊 Actualizando tabla porcentual de entidad-concepto mensual para:', concepto);
            
            const table = document.getElementById('monthly-entidad-concepto-percentage-table');
            if (!table) return;
            
            const tbody = table.querySelector('tbody');
            if (!tbody) return;
            
            const conceptoData = monthlyEntidadConceptoPercentageData[concepto];
            const entidades = Object.keys(conceptoData).sort();
            
            // Meses disponibles
            const meses = ['2024-01', '2024-02', '2024-03', '2024-04', '2024-05', '2024-06', '2024-07', '2024-08', '2024-09', '2024-10', '2024-11', '2024-12', '2025-01', '2025-02', '2025-03', '2025-04', '2025-05', '2025-06', '2025-07'];
            
            let tableHTML = '';
            entidades.forEach(entidad => {
                tableHTML += '<tr>';
                tableHTML += `<td>${entidad}</td>`;
                
                meses.forEach(mes => {
                    const value = conceptoData[entidad][mes];
                    let cellClass = 'text-right';
                    let displayValue = '-';
                    
                    if (value !== null && value !== undefined) {
                        if (value > 0) {
                            cellClass += ' positive-change';
                            displayValue = `+${value}%`;
                        } else if (value < 0) {
                            cellClass += ' negative-change';
                            displayValue = `${value}%`;
                        } else {
                            displayValue = '0.0%';
                        }
                    }
                    
                    tableHTML += `<td class="${cellClass}">${displayValue}</td>`;
                });
                
                tableHTML += '</tr>';
            });
            
            tbody.innerHTML = tableHTML;
            console.log('✅ Tabla porcentual de entidad-concepto mensual actualizada');
        }
        
        // Función para actualizar tabla de entidad-tipo mensual
        function updateMonthlyEntidadTipoTable(concepto, tipo) {
            if (!monthlyEntidadTipoData || !monthlyEntidadTipoData[concepto]) {
                console.warn('⚠️ No hay datos disponibles para la tabla de entidad-tipo mensual');
                return;
            }
            
            console.log('📊 Actualizando tabla de entidad-tipo mensual para:', concepto, tipo);
            
            const table = document.getElementById('monthly-entidad-tipo-table');
            if (!table) return;
            
            const tbody = table.querySelector('tbody');
            if (!tbody) return;
            
            const conceptoData = monthlyEntidadTipoData[concepto];
            const entidades = Object.keys(conceptoData).sort();
            
            // Meses disponibles
            const meses = ['2024-01', '2024-02', '2024-03', '2024-04', '2024-05', '2024-06', '2024-07', '2024-08', '2024-09', '2024-10', '2024-11', '2024-12', '2025-01', '2025-02', '2025-03', '2025-04', '2025-05', '2025-06', '2025-07'];
            
            let tableHTML = '';
            entidades.forEach(entidad => {
                if (conceptoData[entidad] && conceptoData[entidad][tipo]) {
                    tableHTML += '<tr>';
                    tableHTML += `<td>${entidad}</td>`;
                    
                    let total = 0;
                    meses.forEach(mes => {
                        const value = conceptoData[entidad][tipo][mes] || 0;
                        total += value;
                        tableHTML += `<td class="text-right">${value.toLocaleString()}</td>`;
                    });
                    
                    tableHTML += `<td class="text-right font-bold">${total.toLocaleString()}</td>`;
                    tableHTML += '</tr>';
                }
            });
            
            tbody.innerHTML = tableHTML;
            console.log('✅ Tabla de entidad-tipo mensual actualizada');
        }
        
        // Función para actualizar tabla porcentual de entidad-tipo mensual
        function updateMonthlyEntidadTipoPercentageTable(concepto, tipo) {
            // Cargar datos porcentuales de tipo si no están disponibles
            if (!monthlyEntidadTipoPercentageData) {
                fetch('data/monthly_entidad_tipo_percentage_analysis.csv')
                    .then(response => response.text())
                    .then(csvText => {
                        monthlyEntidadTipoPercentageData = parseCSVToMonthlyEntidadTipoPercentageData(csvText);
                        updateMonthlyEntidadTipoPercentageTable(concepto, tipo);
                    })
                    .catch(error => {
                        console.error('❌ Error cargando datos porcentuales de tipo mensual:', error);
                    });
                return;
            }
            
            if (!monthlyEntidadTipoPercentageData[concepto]) {
                console.warn('⚠️ No hay datos porcentuales disponibles para la tabla de entidad-tipo mensual');
                return;
            }
            
            console.log('📊 Actualizando tabla porcentual de entidad-tipo mensual para:', concepto, tipo);
            
            const table = document.getElementById('monthly-entidad-tipo-percentage-table');
            if (!table) return;
            
            const tbody = table.querySelector('tbody');
            if (!tbody) return;
            
            const conceptoData = monthlyEntidadTipoPercentageData[concepto];
            const entidades = Object.keys(conceptoData).sort();
            
            // Meses disponibles
            const meses = ['2024-01', '2024-02', '2024-03', '2024-04', '2024-05', '2024-06', '2024-07', '2024-08', '2024-09', '2024-10', '2024-11', '2024-12', '2025-01', '2025-02', '2025-03', '2025-04', '2025-05', '2025-06', '2025-07'];
            
            let tableHTML = '';
            entidades.forEach(entidad => {
                if (conceptoData[entidad] && conceptoData[entidad][tipo]) {
                    tableHTML += '<tr>';
                    tableHTML += `<td>${entidad}</td>`;
                    
                    meses.forEach(mes => {
                        const value = conceptoData[entidad][tipo][mes];
                        let cellClass = 'text-right';
                        let displayValue = '-';
                        
                        if (value !== null && value !== undefined) {
                            if (value > 0) {
                                cellClass += ' positive-change';
                                displayValue = `+${value}%`;
                            } else if (value < 0) {
                                cellClass += ' negative-change';
                                displayValue = `${value}%`;
                            } else {
                                displayValue = '0.0%';
                            }
                        }
                        
                        tableHTML += `<td class="${cellClass}">${displayValue}</td>`;
                    });
                    
                    tableHTML += '</tr>';
                }
            });
            
            tbody.innerHTML = tableHTML;
            console.log('✅ Tabla porcentual de entidad-tipo mensual actualizada');
        }
        
        // Función para parsear CSV de datos porcentuales de entidad-tipo mensual
        function parseCSVToMonthlyEntidadTipoPercentageData(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = {};
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                if (values.length < headers.length) continue;
                
                const entidad = values[0];
                const concepto = values[1];
                const tipo = values[2];
                
                if (!data[concepto]) {
                    data[concepto] = {};
                }
                if (!data[concepto][entidad]) {
                    data[concepto][entidad] = {};
                }
                if (!data[concepto][entidad][tipo]) {
                    data[concepto][entidad][tipo] = {};
                }
                
                // Agregar datos mensuales (desde columna 3 en adelante)
                for (let j = 3; j < headers.length; j++) {
                    const month = headers[j];
                    const value = values[j] === '' || values[j] === 'NaN' ? null : parseFloat(values[j]);
                    data[concepto][entidad][tipo][month] = value;
                }
            }
            
            return data;
        }
        
        // Event listeners adicionales para debugging
        document.querySelectorAll('.content-section').forEach(section => {
            section.addEventListener('click', function() {
                console.log('Section clicked:', this.querySelector('h2').textContent);
            });
        });

        // ===== FUNCIONES PARA MAPAS =====
        
        // Variables globales para los mapas
        let map = null;
        let map2 = null;
        let entidadConceptoData = null;
        let entidadTipoData = null;
        let entidadConceptoPercentageData = null;
        let entidadTipoPercentageData = null;
        let currentConcepto = null;
        let currentTipo = null;
        let currentYear = 2019;
        
        // Función para cargar los datos de variación porcentual
        async function loadPercentageData() {
            try {
                console.log('🔄 Cargando datos de variación porcentual...');
                
                const response = await fetch('data/entidad_concepto_percentage_analysis.csv');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                console.log('✅ CSV de porcentajes cargado, longitud:', csvText.length);
                
                // Parsear CSV de porcentajes
                entidadConceptoPercentageData = parseCSVToEntidadConceptoPercentageData(csvText);
                console.log('📊 Datos de porcentajes parseados:', entidadConceptoPercentageData);
                
                return entidadConceptoPercentageData;
                
            } catch (error) {
                console.error('❌ Error cargando datos de porcentajes:', error);
                return null;
            }
        }
        
        // Función para parsear CSV de porcentajes a estructura de datos
        function parseCSVToEntidadConceptoPercentageData(csvText) {
            const lines = csvText.split('\n');
            const headers = parseCSVLine(lines[0]);
            const data = {};
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const values = parseCSVLine(line);
                if (values.length < 4) continue;
                
                const entidad = values[0];
                const concepto = values[1];
                
                // Mapear nombre de entidad del CSV al del GeoJSON
                const entidadMapeada = mapEntidadName(entidad);
                
                if (!data[entidadMapeada]) {
                    data[entidadMapeada] = {};
                }
                if (!data[entidadMapeada][concepto]) {
                    data[entidadMapeada][concepto] = {};
                }
                
                // Agregar datos por año (columnas 2 en adelante)
                for (let j = 2; j < values.length && j < headers.length; j++) {
                    const year = headers[j];
                    const value = parseFloat(values[j]) || 0;
                    data[entidadMapeada][concepto][year] = value;
                }
            }
            
            return data;
        }

        // Función para cargar los datos de variación porcentual por tipo
        async function loadTipoPercentageData() {
            try {
                console.log('🔄 Cargando datos de variación porcentual por tipo...');
                
                const response = await fetch('data/entidad_tipo_percentage_analysis.csv');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                console.log('✅ CSV de porcentajes por tipo cargado, longitud:', csvText.length);
                
                // Parsear CSV de porcentajes por tipo
                entidadTipoPercentageData = parseCSVToEntidadTipoPercentageData(csvText);
                console.log('📊 Datos de porcentajes por tipo parseados:', entidadTipoPercentageData);
                
                return entidadTipoPercentageData;
                
            } catch (error) {
                console.error('❌ Error cargando datos de porcentajes por tipo:', error);
                return null;
            }
        }
        
        // Función para parsear CSV de porcentajes por tipo a estructura de datos
        function parseCSVToEntidadTipoPercentageData(csvText) {
            const lines = csvText.split('\n');
            const headers = parseCSVLine(lines[0]);
            const data = {};
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const values = parseCSVLine(line);
                if (values.length < 5) continue;
                
                const entidad = values[0];
                const concepto = values[1];
                const tipo = values[2];
                
                // Mapear nombre de entidad del CSV al del GeoJSON
                const entidadMapeada = mapEntidadName(entidad);
                
                if (!data[entidadMapeada]) {
                    data[entidadMapeada] = {};
                }
                if (!data[entidadMapeada][concepto]) {
                    data[entidadMapeada][concepto] = {};
                }
                if (!data[entidadMapeada][concepto][tipo]) {
                    data[entidadMapeada][concepto][tipo] = {};
                }
                
                // Agregar datos por año (columnas 3 en adelante)
                for (let j = 3; j < values.length && j < headers.length; j++) {
                    const year = headers[j];
                    const value = parseFloat(values[j]) || 0;
                    data[entidadMapeada][concepto][tipo][year] = value;
                }
            }
            
            return data;
        }

        // Función para cargar los datos de tipos
        async function loadTipoData() {
            try {
                console.log('🔄 Cargando datos de tipos...');
                
                const response = await fetch('data/entidad_tipo_analysis.csv');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                console.log('✅ CSV de tipos cargado, longitud:', csvText.length);
                
                // Parsear CSV de tipos
                entidadTipoData = parseCSVToEntidadTipoData(csvText);
                console.log('📊 Datos de tipos parseados:', entidadTipoData);
                
                return entidadTipoData;
                
            } catch (error) {
                console.error('❌ Error cargando datos de tipos:', error);
                return null;
            }
        }
        
        // Función para parsear CSV de tipos a estructura de datos
        function parseCSVToEntidadTipoData(csvText) {
            const lines = csvText.split('\n');
            const headers = parseCSVLine(lines[0]);
            const data = {};
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const values = parseCSVLine(line);
                if (values.length < 4) continue;
                
                const entidad = values[0];
                const concepto = values[1];
                const tipo = values[2];
                
                // Mapear nombre de entidad del CSV al del GeoJSON
                const entidadMapeada = mapEntidadName(entidad);
                
                if (!data[entidadMapeada]) {
                    data[entidadMapeada] = {};
                }
                if (!data[entidadMapeada][concepto]) {
                    data[entidadMapeada][concepto] = {};
                }
                if (!data[entidadMapeada][concepto][tipo]) {
                    data[entidadMapeada][concepto][tipo] = {};
                }
                
                // Agregar datos por año
                for (let j = 3; j < values.length && j < headers.length; j++) {
                    const year = headers[j];
                    const value = parseInt(values[j]) || 0;
                    data[entidadMapeada][concepto][tipo][year] = value;
                }
            }
            
            return data;
        }
        
        // Función para parsear una línea CSV correctamente (maneja comillas)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        // Comilla escapada
                        current += '"';
                        i++; // Saltar la siguiente comilla
                    } else {
                        // Toggle estado de comillas
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    // Separador de campo
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            // Agregar el último campo
            result.push(current.trim());
            
            return result;
        }
        
        // Función para cargar los conceptos disponibles
        async function loadAvailableConceptsForMap() {
            try {
                console.log('🔄 Cargando conceptos para el mapa...');
                
                const response = await fetch('data/entidad_concepto_analysis.csv');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                console.log('✅ CSV cargado, longitud:', csvText.length);
                
                // Parsear CSV
                const lines = csvText.split('\n');
                console.log('📊 Líneas en CSV:', lines.length);
                console.log('📋 Headers:', lines[0]);
                
                const headers = lines[0].split(',');
                const conceptos = [...new Set(lines.slice(1).map(line => {
                    const values = line.split(',');
                    return values[1]; // CONCEPTO está en la columna 1
                }).filter(Boolean))];
                
                console.log('🎯 Conceptos encontrados:', conceptos);
                
                // Cargar datos completos
                entidadConceptoData = parseCSVToEntidadConceptoData(csvText);
                console.log('📊 Datos parseados:', entidadConceptoData);
                
                // Poblar selector de conceptos
                const conceptSelector = document.getElementById('map-concept-selector');
                if (!conceptSelector) {
                    console.error('❌ Selector de conceptos no encontrado');
                    return;
                }
                
                conceptSelector.innerHTML = '<option value="">Selecciona un concepto</option>';
                conceptos.forEach(concepto => {
                    const option = document.createElement('option');
                    option.value = concepto;
                    option.textContent = concepto;
                    conceptSelector.appendChild(option);
                });
                
                // Configurar selector de tipos (inicialmente deshabilitado)
                const typeSelector = document.getElementById('map-type-selector');
                if (typeSelector) {
                    typeSelector.disabled = true;
                    typeSelector.innerHTML = '<option value="">Primero selecciona un concepto...</option>';
                }
                
                console.log('✅ Selector poblado con', conceptos.length, 'conceptos');
                
                // Event listener para cambios de concepto
                conceptSelector.addEventListener('change', function() {
                    currentConcepto = this.value;
                    console.log('🎯 Concepto seleccionado:', currentConcepto);
                    
                    if (currentConcepto) {
                        // Habilitar selector de tipos y cargar tipos disponibles
                        if (typeSelector) {
                            typeSelector.disabled = false;
                            typeSelector.innerHTML = '<option value="">Cargando tipos...</option>';
                            
                            // Cargar tipos reales para el concepto seleccionado
                            if (entidadTipoData) {
                                const tipos = new Set();
                                
                                // Obtener todos los tipos únicos para este concepto
                                Object.keys(entidadTipoData).forEach(entidad => {
                                    if (entidadTipoData[entidad][currentConcepto]) {
                                        Object.keys(entidadTipoData[entidad][currentConcepto]).forEach(tipo => {
                                            // Verificar si este tipo tiene datos en algún año
                                            const tipoData = entidadTipoData[entidad][currentConcepto][tipo];
                                            const hasData = Object.values(tipoData).some(value => value > 0);
                                            if (hasData) {
                                                tipos.add(tipo);
                                            }
                                        });
                                    }
                                });
                                
                                // Poblar selector con tipos reales
                                typeSelector.innerHTML = '<option value="">Selecciona un tipo...</option>';
                                Array.from(tipos).sort().forEach(tipo => {
                                    const option = document.createElement('option');
                                    option.value = tipo;
                                    option.textContent = tipo;
                                    typeSelector.appendChild(option);
                                });
                                
                                console.log(`✅ Tipos cargados para ${currentConcepto}:`, Array.from(tipos));
                            }
                        }
                        
                        updateMapColors(currentConcepto, currentYear);
                        createEntidadConceptoTable(currentConcepto);
                        createEntidadConceptoPercentageTable(currentConcepto);
                    } else {
                        // Deshabilitar selector de tipos
                        if (typeSelector) {
                            typeSelector.disabled = true;
                            typeSelector.innerHTML = '<option value="">Primero selecciona un concepto...</option>';
                        }
                        
                        // Limpiar tabla 3
                        const table = document.getElementById('entidad-concepto-table');
                        if (table) {
                            table.innerHTML = `
                                <thead>
                                    <tr>
                                        <th>Entidad</th>
                                        <th>2019</th>
                                        <th>2020</th>
                                        <th>2021</th>
                                        <th>2022</th>
                                        <th>2023</th>
                                        <th>2024</th>
                                        <th>2025</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Selecciona un concepto para ver datos...</td>
                                        <td colspan="8">Espera...</td>
                                    </tr>
                                </tbody>
                            `;
                        }
                        
                        // Limpiar tabla 3.1.1 (segundo bloque)
                        const tablePercentage3 = document.getElementById('entidad-concepto-percentage-table');
                        if (tablePercentage3) {
                            tablePercentage3.innerHTML = `
                                <thead>
                                    <tr>
                                        <th>Entidad</th>
                                        <th>2019</th>
                                        <th>2020</th>
                                        <th>2021</th>
                                        <th>2022</th>
                                        <th>2023</th>
                                        <th>2024</th>
                                        <th>2025</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Selecciona un concepto para ver datos...</td>
                                        <td colspan="7">Espera...</td>
                                    </tr>
                                </tbody>
                            `;
                        }
                        
                        // Limpiar tabla 3.1.1
                        const tablePercentage2 = document.getElementById('entidad-concepto-percentage-table');
                        if (tablePercentage2) {
                            tablePercentage2.innerHTML = `
                                <thead>
                                    <tr>
                                        <th>Entidad</th>
                                        <th>2019</th>
                                        <th>2020</th>
                                        <th>2021</th>
                                        <th>2022</th>
                                        <th>2023</th>
                                        <th>2024</th>
                                        <th>2025</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Selecciona un concepto para ver datos...</td>
                                        <td colspan="7">Espera...</td>
                                    </tr>
                                </tbody>
                            `;
                        }
                        
                        // Limpiar tabla 3.1
                        const tableTipo = document.getElementById('entidad-tipo-table');
                        if (tableTipo) {
                            tableTipo.innerHTML = `
                                <thead>
                                    <tr>
                                        <th>Entidad</th>
                                        <th>2019</th>
                                        <th>2020</th>
                                        <th>2021</th>
                                        <th>2022</th>
                                        <th>2023</th>
                                        <th>2024</th>
                                        <th>2025</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Selecciona un concepto y tipo para ver datos...</td>
                                        <td colspan="8">Espera...</td>
                                    </tr>
                                </tbody>
                            `;
                        }
                        
                        // Limpiar tabla 3.1.3
                        const tableTipoPercentage2 = document.getElementById('entidad-tipo-percentage-table');
                        if (tableTipoPercentage2) {
                            tableTipoPercentage2.innerHTML = `
                                <thead>
                                    <tr>
                                        <th>Entidad</th>
                                        <th>2019</th>
                                        <th>2020</th>
                                        <th>2021</th>
                                        <th>2022</th>
                                        <th>2023</th>
                                        <th>2024</th>
                                        <th>2025</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Selecciona un concepto y tipo para ver datos...</td>
                                        <td colspan="7">Espera...</td>
                                    </tr>
                                </tbody>
                            `;
                        }
                        
                        // Limpiar segundo mapa y restaurar placeholder
                        if (map2) {
                            map2.remove();
                            map2 = null;
                        }
                        
                        const mapContainer2 = document.getElementById('map2');
                        if (mapContainer2) {
                            mapContainer2.classList.add('placeholder');
                            mapContainer2.classList.remove('loaded'); // Quitar clase loaded
                            mapContainer2.innerHTML = `
                                <div class="placeholder-content">
                                </div>
                            `;
                        }
                    }
                });
                
                // Event listener para cambios de tipo
                if (typeSelector) {
                    typeSelector.addEventListener('change', function() {
                        currentTipo = this.value;
                        console.log('🎯 Tipo seleccionado:', currentTipo);
                        
                        if (currentTipo && currentConcepto) {
                            // Crear o actualizar el segundo mapa
                            createSecondMap(currentConcepto, currentTipo, currentYear);
                            // Crear tabla de tipos
                            createEntidadTipoTable(currentConcepto, currentTipo);
                            // Crear tabla de porcentajes por tipo
                            createEntidadTipoPercentageTable(currentConcepto, currentTipo);
                        } else {
                            // Limpiar el segundo mapa y restaurar placeholder
                            if (map2) {
                                map2.remove();
                                map2 = null;
                            }
                            
                            // Restaurar placeholder
                            const mapContainer2 = document.getElementById('map2');
                            if (mapContainer2) {
                                mapContainer2.classList.add('placeholder');
                                mapContainer2.classList.remove('loaded'); // Quitar clase loaded
                                mapContainer2.innerHTML = `
                                    <div class="placeholder-content">
                                        <p>🚧 Mapa en desarrollo</p>
                                        <p>Este espacio está reservado para funcionalidad adicional</p>
                                    </div>
                                `;
                            }
                            
                            // Limpiar tabla 3.1
                            const tableTipo = document.getElementById('entidad-tipo-table');
                            if (tableTipo) {
                                tableTipo.innerHTML = `
                                    <thead>
                                        <tr>
                                            <th>Entidad</th>
                                            <th>2019</th>
                                            <th>2020</th>
                                            <th>2021</th>
                                            <th>2022</th>
                                            <th>2023</th>
                                            <th>2024</th>
                                            <th>2025</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Selecciona un concepto y tipo para ver datos...</td>
                                            <td colspan="8">Espera...</td>
                                        </tr>
                                    </tbody>
                                `;
                            }
                            
                            // Limpiar tabla 3.1.3
                            const tableTipoPercentage = document.getElementById('entidad-tipo-percentage-table');
                            if (tableTipoPercentage) {
                                tableTipoPercentage.innerHTML = `
                                    <thead>
                                        <tr>
                                            <th>Entidad</th>
                                            <th>2019</th>
                                            <th>2020</th>
                                            <th>2021</th>
                                            <th>2022</th>
                                            <th>2023</th>
                                            <th>2024</th>
                                            <th>2025</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Selecciona un concepto y tipo para ver datos...</td>
                                            <td colspan="7">Espera...</td>
                                        </tr>
                                    </tbody>
                                `;
                            }
                        }
                    });
                }
                
                // Configurar slider de año
                const yearSlider = document.getElementById('map-year-slider');
                const yearDisplay = document.getElementById('year-display');
                
                if (yearSlider && yearDisplay) {
                    // Event listener para cambios del slider
                    yearSlider.addEventListener('input', function() {
                        currentYear = parseInt(this.value);
                        yearDisplay.textContent = currentYear;
                        console.log('📅 Año actualizado:', currentYear);
                        
                        if (currentConcepto) {
                            updateMapColors(currentConcepto, currentYear);
                        }
                        
                        // Actualizar segundo mapa si hay tipo seleccionado
                        if (currentTipo && currentConcepto && map2) {
                            updateSecondMapColors(currentConcepto, currentTipo, currentYear);
                        }
                    });
                    
                    console.log('✅ Slider de año configurado');
                }
                
            } catch (error) {
                console.error('❌ Error cargando conceptos para mapa:', error);
            }
        }
        
        // Función para mapear nombres de entidades del CSV a los del GeoJSON
        function mapEntidadName(csvName) {
            const mapping = {
                'AGUASCALIENTES': 'Aguascalientes',
                'BAJA CALIFORNIA': 'Baja California',
                'BAJA CALIFORNIA SUR': 'Baja California Sur',
                'CAMPECHE': 'Campeche',
                'COAHUILA': 'Coahuila de Zaragoza',
                'COLIMA': 'Colima',
                'CHIAPAS': 'Chiapas',
                'CHIHUAHUA': 'Chihuahua',
                'CIUDAD DE MEXICO': 'Ciudad de México',
                'DURANGO': 'Durango',
                'GUANAJUATO': 'Guanajuato',
                'GUERRERO': 'Guerrero',
                'HIDALGO': 'Hidalgo',
                'JALISCO': 'Jalisco',
                'MEXICO': 'México',
                'MICHOACAN': 'Michoacán de Ocampo',
                'MORELOS': 'Morelos',
                'NAYARIT': 'Nayarit',
                'NUEVO LEON': 'Nuevo León',
                'OAXACA': 'Oaxaca',
                'PUEBLA': 'Puebla',
                'QUERETARO': 'Querétaro',
                'QUINTANA ROO': 'Quintana Roo',
                'SAN LUIS POTOSI': 'San Luis Potosí',
                'SINALOA': 'Sinaloa',
                'SONORA': 'Sonora',
                'TABASCO': 'Tabasco',
                'TAMAULIPAS': 'Tamaulipas',
                'TLAXCALA': 'Tlaxcala',
                'VERACRUZ': 'Veracruz de Ignacio de la Llave',
                'YUCATAN': 'Yucatán',
                'ZACATECAS': 'Zacatecas'
            };
            
            return mapping[csvName] || csvName;
        }
        
        // Función para parsear CSV de entidad-concepto
        function parseCSVToEntidadConceptoData(csvText) {
            const lines = csvText.split('\n');
            const headers = parseCSVLine(lines[0]);
            const data = {};
            
            lines.slice(1).forEach(line => {
                if (line.trim()) {
                    const values = parseCSVLine(line);
                    const entidad = values[0];
                    const concepto = values[1];
                    
                    // Mapear nombre de entidad del CSV al del GeoJSON
                    const entidadMapeada = mapEntidadName(entidad);
                    
                    if (!data[entidadMapeada]) data[entidadMapeada] = {};
                    if (!data[entidadMapeada][concepto]) data[entidadMapeada][concepto] = {};
                    
                    // Agregar años
                    for (let i = 2; i < headers.length; i++) {
                        const year = headers[i];
                        const value = parseInt(values[i]) || 0;
                        data[entidadMapeada][concepto][year] = value;
                    }
                }
            });
            
            return data;
        }
        
        // Función para crear el segundo mapa (por tipo)
        function createSecondMap(concepto, tipo, year) {
            try {
                // Verificar que Leaflet está disponible
                if (typeof L === 'undefined') {
                    console.error('❌ Leaflet no está cargado para el segundo mapa');
                    return;
                }
                
                // Verificar que el contenedor existe
                const mapContainer2 = document.getElementById('map2');
                if (!mapContainer2) {
                    console.error('❌ No se encontró el contenedor del segundo mapa');
                    return;
                }
                
                // Ocultar el placeholder
                mapContainer2.classList.remove('placeholder');
                mapContainer2.innerHTML = ''; // Limpiar contenido del placeholder
                
                // Limpiar mapa anterior si existe
                if (map2) {
                    map2.remove();
                }
                
                // Crear el segundo mapa
                map2 = L.map('map2', {
                    center: [23.6345, -102.5528],
                    zoom: 5,
                    zoomControl: true,
                    attributionControl: false
                });
                
                // Establecer límites del mapa
                map2.setMaxBounds([14.5, -118.5, 32.5, -86.5]);
                
                // Cargar GeoJSON de estados
                fetch('data/geojson/estados_compressed.json')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(geojsonData => {
                        // Agregar estados al segundo mapa
                        const estadosLayer2 = L.geoJSON(geojsonData, {
                            style: function(feature) {
                                return {
                                    fillColor: '#3498db',
                                    weight: 1.5,
                                    opacity: 1,
                                    color: '#2c3e50',
                                    fillOpacity: 0.8
                                };
                            },
                            onEachFeature: function(feature, layer) {
                                const nombre = feature.properties.NOMGEO || 'Estado';
                                
                                // Crear popup con datos de tipo
                                let popupContent = `<b>${nombre}</b>`;
                                
                                if (entidadTipoData && currentConcepto && currentTipo && currentYear) {
                                    const entidadData = entidadTipoData[nombre];
                                    if (entidadData && entidadData[currentConcepto] && entidadData[currentConcepto][currentTipo] && entidadData[currentConcepto][currentTipo].hasOwnProperty(currentYear)) {
                                        const value = entidadData[currentConcepto][currentTipo][currentYear];
                                        popupContent += `<br><br><b>Concepto:</b> ${currentConcepto}<br><b>Tipo:</b> ${currentTipo}<br><b>Año:</b> ${currentYear}<br><b>Incidencia:</b> ${value.toLocaleString()} carpetas`;
                                    } else {
                                        popupContent += `<br><br><i>No hay datos disponibles para "${currentTipo}" en ${currentYear}</i>`;
                                    }
                                } else {
                                    popupContent += `<br><br><i>Selecciona un tipo para ver datos</i>`;
                                }
                                
                                layer.bindPopup(popupContent);
                            }
                        });
                        
                        estadosLayer2.addTo(map2);
                        
                        // Ajustar la vista del mapa
                        if (estadosLayer2.getBounds) {
                            const bounds = estadosLayer2.getBounds();
                            map2.fitBounds(bounds, { padding: [20, 20] });
                        }
                        
                        // Actualizar colores del segundo mapa
                        updateSecondMapColors(concepto, tipo, year);
                        
                        // Ocultar el mensaje de carga del segundo mapa
                        const mapContainer2 = document.getElementById('map2');
                        if (mapContainer2) {
                            mapContainer2.classList.add('loaded');
                        }
                        
                        console.log('✅ Segundo mapa creado exitosamente');
                    })
                    .catch(error => {
                        console.error('❌ Error cargando GeoJSON para segundo mapa:', error);
                    });
                
            } catch (error) {
                console.error('❌ Error creando segundo mapa:', error);
            }
        }
        
        // Función para actualizar colores del segundo mapa según el tipo
        function updateSecondMapColors(concepto, tipo, year) {
            console.log('🔄 Actualizando colores del segundo mapa para concepto:', concepto, 'tipo:', tipo, 'año:', year);
            
            if (!map2 || !entidadTipoData) {
                console.error('❌ Segundo mapa o datos de tipos no disponibles');
                return;
            }
            
            // Recopilar todos los valores para este tipo y concepto
            const allValues = [];
            Object.keys(entidadTipoData).forEach(entidad => {
                if (entidadTipoData[entidad][concepto] && entidadTipoData[entidad][concepto][tipo] && entidadTipoData[entidad][concepto][tipo].hasOwnProperty(year)) {
                    allValues.push(entidadTipoData[entidad][concepto][tipo][year]);
                }
            });
            
            console.log('📈 Valores encontrados para', concepto, tipo, 'en', year, ':', allValues);
            
            if (allValues.length === 0) {
                console.error('❌ No hay valores para el concepto:', concepto, 'tipo:', tipo, 'en año:', year);
                return;
            }
            
            // Calcular percentiles para la escala de colores (7 niveles)
            allValues.sort((a, b) => a - b);
            const q14 = allValues[Math.floor(allValues.length * 0.14)];
            const q28 = allValues[Math.floor(allValues.length * 0.28)];
            const q42 = allValues[Math.floor(allValues.length * 0.42)];
            const q56 = allValues[Math.floor(allValues.length * 0.56)];
            const q70 = allValues[Math.floor(allValues.length * 0.70)];
            const q84 = allValues[Math.floor(allValues.length * 0.84)];
            
            console.log('📊 Percentiles - Q14:', q14, 'Q28:', q28, 'Q42:', q42, 'Q56:', q56, 'Q70:', q70, 'Q84:', q84);
            
            // Actualizar colores de los estados en el segundo mapa
            let estadosActualizados = 0;
            map2.eachLayer(layer => {
                if (layer.feature && layer.feature.properties) {
                    const entidad = layer.feature.properties.NOMGEO;
                    console.log('🗺️ Procesando entidad en segundo mapa:', entidad);
                    
                    const entidadData = entidadTipoData[entidad];
                    
                    if (entidadData && entidadData[concepto] && entidadData[concepto][tipo] && entidadData[concepto][tipo].hasOwnProperty(year)) {
                        const value = entidadData[concepto][tipo][year];
                        
                        console.log(`   📊 ${entidad}: Tipo ${tipo} Año ${year} = ${value}`);
                        
                        // Asignar color según el valor (escala blanco a rojo con 7 niveles)
                        let color;
                        if (value <= q14) {
                            color = '#ffffff'; // Blanco (muy baja incidencia)
                        } else if (value <= q28) {
                            color = '#ffe6e6'; // Rosa muy claro (baja incidencia)
                        } else if (value <= q42) {
                            color = '#ffcccc'; // Rosa claro (media-baja incidencia)
                        } else if (value <= q56) {
                            color = '#ffb3b3'; // Rosa medio (media incidencia)
                        } else if (value <= q70) {
                            color = '#ff9999'; // Rosa medio-alto (media-alta incidencia)
                        } else if (value <= q84) {
                            color = '#ff6666'; // Rosa alto (alta incidencia)
                        } else {
                            color = '#ff0000'; // Rojo intenso (muy alta incidencia)
                        }
                        
                        layer.setStyle({
                            fillColor: color,
                            fillOpacity: 0.8
                        });
                        
                        // Actualizar el popup con los nuevos datos
                        const nombre = layer.feature.properties.NOMGEO;
                        let popupContent = `<b>${nombre}</b>`;
                        
                        if (entidadTipoData && currentConcepto && currentTipo && currentYear) {
                            const entidadData = entidadTipoData[nombre];
                            if (entidadData && entidadData[currentConcepto] && entidadData[currentConcepto][currentTipo] && entidadData[currentConcepto][currentTipo].hasOwnProperty(currentYear)) {
                                const value = entidadData[currentConcepto][currentTipo][currentYear];
                                popupContent += `<br><br><b>Concepto:</b> ${currentConcepto}<br><b>Tipo:</b> ${currentTipo}<br><b>Año:</b> ${currentYear}<br><b>Incidencia:</b> ${value.toLocaleString()} carpetas`;
                            } else {
                                popupContent += `<br><br><i>No hay datos disponibles para "${currentTipo}" en ${currentYear}</i>`;
                            }
                        } else {
                            popupContent += `<br><br><i>Selecciona un tipo para ver datos</i>`;
                        }
                        
                        layer.bindPopup(popupContent);
                        
                        estadosActualizados++;
                    } else {
                        console.log(`   ⚠️ ${entidad}: No hay datos para ${concepto} - ${tipo} en ${year}`);
                    }
                }
            });
            
            console.log(`✅ Estados actualizados en segundo mapa: ${estadosActualizados}`);
        }
        
        // Función para crear la tabla de variación porcentual por entidad y concepto
        function createEntidadConceptoPercentageTable(concepto) {
            if (!entidadConceptoPercentageData || !concepto) {
                console.error('No hay datos de porcentajes o concepto seleccionado');
                return;
            }
            
            const years = ['2019', '2020', '2021', '2022', '2023', '2024', '2025'];
            
            // Obtener todas las entidades que tienen datos para este concepto
            const entidades = Object.keys(entidadConceptoPercentageData).filter(entidad => {
                return entidadConceptoPercentageData[entidad][concepto];
            }).sort();
            
            // Crear tabla HTML
            let tableHTML = '<thead><tr><th>Entidad</th>';
            years.forEach(year => {
                tableHTML += `<th>${year}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';
            
            // Procesar cada entidad
            entidades.forEach(entidad => {
                tableHTML += '<tr>';
                tableHTML += `<td>${entidad}</td>`;
                
                // Agregar cambios porcentuales para cada año
                years.forEach(year => {
                    const value = entidadConceptoPercentageData[entidad][concepto][year] || 0;
                    
                    // Formatear cambios porcentuales con colores
                    let cellClass = 'text-right';
                    let displayValue = '-';
                    
                    if (value > 0) {
                        cellClass += ' positive-change';
                        displayValue = `+${value.toFixed(1)}%`;
                    } else if (value < 0) {
                        cellClass += ' negative-change';
                        displayValue = `${value.toFixed(1)}%`;
                    } else if (value === 0) {
                        displayValue = '0.0%';
                    }
                    
                    tableHTML += `<td class="${cellClass}">${displayValue}</td>`;
                });
                
                tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody>';
            
            // Actualizar la tabla
            const table = document.getElementById('entidad-concepto-percentage-table');
            if (table) {
                table.innerHTML = tableHTML;
                console.log('✅ Tabla de variación porcentual creada para:', concepto);
            }
        }

        // Función para crear la tabla de variación porcentual por entidad y tipo
        function createEntidadTipoPercentageTable(concepto, tipo) {
            if (!entidadTipoPercentageData || !concepto || !tipo) {
                console.error('No hay datos de porcentajes por tipo, concepto o tipo seleccionado');
                return;
            }
            
            const years = ['2019', '2020', '2021', '2022', '2023', '2024', '2025'];
            
            // Obtener todas las entidades que tienen datos para este concepto y tipo
            const entidades = Object.keys(entidadTipoPercentageData).filter(entidad => {
                return entidadTipoPercentageData[entidad][concepto] && entidadTipoPercentageData[entidad][concepto][tipo];
            }).sort();
            
            // Crear tabla HTML
            let tableHTML = '<thead><tr><th>Entidad</th>';
            years.forEach(year => {
                tableHTML += `<th>${year}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';
            
            // Procesar cada entidad
            entidades.forEach(entidad => {
                tableHTML += '<tr>';
                tableHTML += `<td>${entidad}</td>`;
                
                // Agregar cambios porcentuales para cada año
                years.forEach(year => {
                    const value = entidadTipoPercentageData[entidad][concepto][tipo][year] || 0;
                    
                    // Formatear cambios porcentuales con colores
                    let cellClass = 'text-right';
                    let displayValue = '-';
                    
                    if (value > 0) {
                        cellClass += ' positive-change';
                        displayValue = `+${value.toFixed(1)}%`;
                    } else if (value < 0) {
                        cellClass += ' negative-change';
                        displayValue = `${value.toFixed(1)}%`;
                    } else if (value === 0) {
                        displayValue = '0.0%';
                    }
                    
                    tableHTML += `<td class="${cellClass}">${displayValue}</td>`;
                });
                
                tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody>';
            
            // Actualizar la tabla
            const table = document.getElementById('entidad-tipo-percentage-table');
            if (table) {
                table.innerHTML = tableHTML;
                console.log('✅ Tabla de variación porcentual por tipo creada para:', concepto, '-', tipo);
            }
        }

        // Función para crear la tabla de datos por entidad y tipo
        function createEntidadTipoTable(concepto, tipo) {
            if (!entidadTipoData || !concepto || !tipo) {
                console.error('No hay datos, concepto o tipo seleccionado');
                return;
            }
            
            const years = ['2019', '2020', '2021', '2022', '2023', '2024', '2025'];
            
            // Obtener todas las entidades que tienen datos para este concepto y tipo
            const entidades = Object.keys(entidadTipoData).filter(entidad => {
                return entidadTipoData[entidad][concepto] && entidadTipoData[entidad][concepto][tipo];
            }).sort();
            
            // Crear tabla HTML
            let tableHTML = '<thead><tr><th>Entidad</th>';
            years.forEach(year => {
                tableHTML += `<th>${year}</th>`;
            });
            tableHTML += '<th>Total</th></tr></thead><tbody>';
            
            // Procesar cada entidad
            entidades.forEach(entidad => {
                tableHTML += '<tr>';
                tableHTML += `<td>${entidad}</td>`;
                
                let total = 0;
                years.forEach(year => {
                    const value = entidadTipoData[entidad][concepto][tipo][year] || 0;
                    total += value;
                    tableHTML += `<td class="text-right">${value.toLocaleString()}</td>`;
                });
                
                // Columna de total
                tableHTML += `<td class="text-right total-cell"><strong>${total.toLocaleString()}</strong></td>`;
                tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody>';
            
            // Actualizar la tabla
            const table = document.getElementById('entidad-tipo-table');
            if (table) {
                table.innerHTML = tableHTML;
                console.log('✅ Tabla de entidad-tipo creada para:', concepto, '-', tipo);
            }
        }

        // Función para crear la tabla de datos por entidad y concepto
        function createEntidadConceptoTable(concepto) {
            if (!entidadConceptoData || !concepto) {
                console.error('No hay datos o concepto seleccionado');
                return;
            }
            
            const years = ['2019', '2020', '2021', '2022', '2023', '2024', '2025'];
            
            // Obtener todas las entidades que tienen datos para este concepto
            const entidades = Object.keys(entidadConceptoData).filter(entidad => {
                return entidadConceptoData[entidad][concepto];
            }).sort();
            
            // Crear tabla HTML
            let tableHTML = '<thead><tr><th>Entidad</th>';
            years.forEach(year => {
                tableHTML += `<th>${year}</th>`;
            });
            tableHTML += '<th>Total</th></tr></thead><tbody>';
            
            // Procesar cada entidad
            entidades.forEach(entidad => {
                tableHTML += '<tr>';
                tableHTML += `<td>${entidad}</td>`;
                
                let total = 0;
                years.forEach(year => {
                    const value = entidadConceptoData[entidad][concepto][year] || 0;
                    total += value;
                    tableHTML += `<td class="text-right">${value.toLocaleString()}</td>`;
                });
                
                // Columna de total
                tableHTML += `<td class="text-right total-cell"><strong>${total.toLocaleString()}</strong></td>`;
                tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody>';
            
            // Actualizar la tabla
            const table = document.getElementById('entidad-concepto-table');
            if (table) {
                table.innerHTML = tableHTML;
                console.log('✅ Tabla de entidad-concepto creada para:', concepto);
            }
        }

        // Función para actualizar colores del mapa según el concepto y año
        function updateMapColors(concepto, year) {
            console.log('🔄 Actualizando colores del mapa para concepto:', concepto, 'año:', year);
            console.log('📊 Datos disponibles:', entidadConceptoData);
            
            if (!map || !entidadConceptoData) {
                console.error('❌ Mapa o datos no disponibles');
                return;
            }
            
            // Obtener todos los valores para este concepto y año específico
            const allValues = [];
            Object.values(entidadConceptoData).forEach(entidadData => {
                if (entidadData[concepto] && entidadData[concepto].hasOwnProperty(year)) {
                    const value = entidadData[concepto][year];
                    allValues.push(value); // Incluir todos los valores, incluyendo 0s
                }
            });
            
            console.log('📈 Valores encontrados para', concepto, 'en', year, ':', allValues);
            
            if (allValues.length === 0) {
                console.error('❌ No hay valores para el concepto:', concepto, 'en año:', year);
                return;
            }
            
            // Calcular percentiles para la escala de colores (7 niveles)
            allValues.sort((a, b) => a - b);
            const q14 = allValues[Math.floor(allValues.length * 0.14)];
            const q28 = allValues[Math.floor(allValues.length * 0.28)];
            const q42 = allValues[Math.floor(allValues.length * 0.42)];
            const q56 = allValues[Math.floor(allValues.length * 0.56)];
            const q70 = allValues[Math.floor(allValues.length * 0.70)];
            const q84 = allValues[Math.floor(allValues.length * 0.84)];
            
            console.log('📊 Percentiles - Q14:', q14, 'Q28:', q28, 'Q42:', q42, 'Q56:', q56, 'Q70:', q70, 'Q84:', q84);
            
            // Actualizar colores de los estados
            let estadosActualizados = 0;
            map.eachLayer(layer => {
                if (layer.feature && layer.feature.properties) {
                    const entidad = layer.feature.properties.NOMGEO;
                    console.log('🗺️ Procesando entidad:', entidad);
                    
                    const entidadData = entidadConceptoData[entidad];
                    
                    if (entidadData && entidadData[concepto] && entidadData[concepto].hasOwnProperty(year)) {
                        // Usar el valor del año específico
                        const value = entidadData[concepto][year];
                        
                        console.log(`   📊 ${entidad}: Año ${year} = ${value}`);
                        
                        // Asignar color según el valor (escala blanco a rojo con 7 niveles)
                        let color;
                        if (value <= q14) {
                            color = '#ffffff'; // Blanco (muy baja incidencia)
                        } else if (value <= q28) {
                            color = '#ffe6e6'; // Rosa muy claro (baja incidencia)
                        } else if (value <= q42) {
                            color = '#ffcccc'; // Rosa claro (media-baja incidencia)
                        } else if (value <= q56) {
                            color = '#ffb3b3'; // Rosa medio (media incidencia)
                        } else if (value <= q70) {
                            color = '#ff9999'; // Rosa medio-alto (media-alta incidencia)
                        } else if (value <= q84) {
                            color = '#ff6666'; // Rosa alto (alta incidencia)
                        } else {
                            color = '#ff0000'; // Rojo intenso (muy alta incidencia)
                        }
                        
                        layer.setStyle({
                            fillColor: color,
                            fillOpacity: 0.8
                        });
                        
                        // Actualizar el popup con los nuevos datos
                        const nombre = layer.feature.properties.NOMGEO;
                        let popupContent = `<b>${nombre}</b>`;
                        
                        if (entidadConceptoData && currentConcepto && currentYear) {
                            const entidadData = entidadConceptoData[nombre];
                            if (entidadData && entidadData[currentConcepto] && entidadData[currentConcepto].hasOwnProperty(currentYear)) {
                                const value = entidadData[currentConcepto][currentYear];
                                popupContent += `<br><br><b>Concepto:</b> ${currentConcepto}<br><b>Año:</b> ${currentYear}<br><b>Incidencia:</b> ${value.toLocaleString()} carpetas`;
                            } else {
                                popupContent += `<br><br><i>No hay datos disponibles para "${currentConcepto}" en ${currentYear}</i>`;
                            }
                        } else {
                            popupContent += `<br><br><i>Selecciona un concepto y año para ver datos</i>`;
                        }
                        
                        layer.bindPopup(popupContent);
                        
                        estadosActualizados++;
                    } else {
                        console.log(`   ⚠️ ${entidad}: No hay datos para ${concepto} en ${year}`);
                    }
                }
            });
            
            console.log(`✅ Estados actualizados: ${estadosActualizados}`);
        }
        
        // Función para crear el mapa de estados
        function createEstadosMap() {
            try {
                // Verificar que Leaflet está disponible
                if (typeof L === 'undefined') {
                    console.error('❌ Leaflet no está cargado. Esperando...');
                    setTimeout(createEstadosMap, 1000); // Reintentar en 1 segundo
                    return;
                }
                
                // Verificar que el contenedor existe
                const mapContainer = document.getElementById('map');
                if (!mapContainer) {
                    console.error('❌ No se encontró el contenedor del mapa');
                    return;
                }
                
                // Crear el mapa centrado en México (sin capa base)
                map = L.map('map', {
                    center: [23.6345, -102.5528],
                    zoom: 5,
                    zoomControl: true,
                    attributionControl: false
                });
                
                // Establecer límites del mapa para que no se pueda alejar demasiado
                map.setMaxBounds([14.5, -118.5, 32.5, -86.5]); // Límites de México
                
                // Cargar GeoJSON de estados
                fetch('data/geojson/estados_compressed.json')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(geojsonData => {
                        // Agregar estados al mapa
                        const estadosLayer = L.geoJSON(geojsonData, {
                            style: function(feature) {
                                return {
                                    fillColor: '#3498db',
                                    weight: 1.5,
                                    opacity: 1,
                                    color: '#2c3e50',
                                    fillOpacity: 0.8
                                };
                            },
                            onEachFeature: function(feature, layer) {
                                // Mostrar nombre del estado en popup
                                const nombre = feature.properties.NOMGEO || 'Estado';
                                
                                // Crear popup con datos si están disponibles
                                let popupContent = `<b>${nombre}</b>`;
                                
                                if (entidadConceptoData && currentConcepto && currentYear) {
                                    const entidadData = entidadConceptoData[nombre];
                                    if (entidadData && entidadData[currentConcepto] && entidadData[currentConcepto].hasOwnProperty(currentYear)) {
                                        const value = entidadData[currentConcepto][currentYear];
                                        popupContent += `<br><br><b>Concepto:</b> ${currentConcepto}<br><b>Año:</b> ${currentYear}<br><b>Incidencia:</b> ${value.toLocaleString()} carpetas`;
                                    } else {
                                        popupContent += `<br><br><i>No hay datos disponibles para "${currentConcepto}" en ${currentYear}</i>`;
                                    }
                                } else {
                                    popupContent += `<br><br><i>Selecciona un concepto y año para ver datos</i>`;
                                }
                                
                                layer.bindPopup(popupContent);
                            }
                        });
                        
                        estadosLayer.addTo(map);
                        
                        // Ajustar la vista del mapa para mostrar todos los estados
                        if (estadosLayer.getBounds) {
                            const bounds = estadosLayer.getBounds();
                            map.fitBounds(bounds, { padding: [20, 20] });
                        }
                        
                        // Forzar redibujado del mapa
                        map.invalidateSize();
                        
                        // Ocultar el mensaje de carga
                        const mapContainer = document.getElementById('map');
                        if (mapContainer) {
                            mapContainer.classList.add('loaded');
                        }
                    })
                    .catch(error => {
                        console.error('❌ Error cargando GeoJSON:', error);
                        mapContainer.innerHTML = '<p style="text-align: center; color: #d32f2f; padding: 20px;">Error cargando el mapa</p>';
                    });
                
            } catch (error) {
                console.error('❌ Error creando mapa:', error);
            }
        }

        // ===========================================
        // FUNCIONES PARA ANÁLISIS ESTATAL
        // ===========================================
        
        // Variables globales para análisis estatal
        let estatalData = null;
        let estatalChart1 = null;
        
        // Función para cargar datos estatales
        async function loadEstatalData() {
            try {
                console.log('🔄 Cargando datos estatales...');
                
                const response = await fetch('data/estatal_concepto_tipo_analysis.csv');
                const csvText = await response.text();
                
                console.log(`✅ CSV estatal cargado, longitud: ${csvText.length}`);
                
                const lines = csvText.trim().split('\n');
                console.log(`📊 Líneas en CSV estatal: ${lines.length}`);
                
                if (lines.length < 2) {
                    console.error('❌ Archivo CSV estatal vacío o solo headers');
                    return;
                }
                
                const headers = parseCSVLine(lines[0]);
                console.log('📋 Headers estatal:', headers);
                
                const data = {};
                
                // Procesar cada línea
                for (let i = 1; i < lines.length; i++) {
                    const values = parseCSVLine(lines[i]);
                    
                    if (values.length >= 4) {
                        const entidad = values[0].trim();
                        const concepto = values[1].trim();
                        const tipo = values[2].trim();
                        const total = parseInt(values[3]) || 0;
                        
                        if (!data[concepto]) data[concepto] = {};
                        if (!data[concepto][entidad]) data[concepto][entidad] = {};
                        data[concepto][entidad][tipo] = total;
                    }
                }
                
                estatalData = data;
                console.log('📊 Datos estatales parseados:', estatalData);
                
                // Cargar conceptos en el selector
                loadEstatalConceptos();
                
            } catch (error) {
                console.error('❌ Error cargando datos estatales:', error);
            }
        }
        
        // Función para cargar conceptos en el selector estatal
        function loadEstatalConceptos() {
            const selector = document.getElementById('estatal-concepto-selector');
            if (!selector || !estatalData) return;
            
            // Limpiar opciones existentes (excepto la primera)
            while (selector.children.length > 1) {
                selector.removeChild(selector.lastChild);
            }
            
            const conceptos = Object.keys(estatalData).sort();
            console.log('🎯 Conceptos estatales encontrados:', conceptos);
            
            conceptos.forEach(concepto => {
                const option = document.createElement('option');
                option.value = concepto;
                option.textContent = concepto;
                selector.appendChild(option);
            });
            
            // Agregar event listener
            selector.addEventListener('change', function() {
                const selectedConcepto = this.value;
                if (selectedConcepto) {
                    createEstatalChart1(selectedConcepto);
                    createEstatalTable1(selectedConcepto);
                } else {
                    // Limpiar gráfica y tabla
                    if (estatalChart1) {
                        estatalChart1.destroy();
                        estatalChart1 = null;
                    }
                    document.getElementById('estatal-table-1').innerHTML = 
                        '<p style="text-align: center; color: #666; padding: 20px;">Selecciona un concepto para ver los datos</p>';
                }
            });
        }
        
        // Función para crear la gráfica estatal 1 (stacked horizontal bar chart)
        function createEstatalChart1(concepto) {
            if (!estatalData || !estatalData[concepto]) return;
            
            const ctx = document.getElementById('estatal-chart-1');
            if (!ctx) return;
            
            // Destruir gráfica existente
            if (estatalChart1) {
                estatalChart1.destroy();
            }
            
            const conceptoData = estatalData[concepto];
            
            // Obtener todos los tipos únicos para este concepto
            const todosLosTipos = new Set();
            Object.values(conceptoData).forEach(entidadData => {
                Object.keys(entidadData).forEach(tipo => todosLosTipos.add(tipo));
            });
            const tipos = Array.from(todosLosTipos).sort();
            
            // Calcular totales por entidad y ordenar
            const entidadTotales = [];
            Object.keys(conceptoData).forEach(entidad => {
                const entidadData = conceptoData[entidad];
                const total = Object.values(entidadData).reduce((sum, val) => sum + val, 0);
                entidadTotales.push({ entidad, total, data: entidadData });
            });
            
            // Ordenar de mayor a menor
            entidadTotales.sort((a, b) => b.total - a.total);
            
            // Preparar datos para Chart.js
            const labels = entidadTotales.map(item => item.entidad);
            
            // Crear datasets para cada tipo
            const datasets = tipos.map((tipo, index) => {
                const data = entidadTotales.map(item => item.data[tipo] || 0);
                
                // Colores para los tipos (usar paleta distintiva)
                const colors = [
                    '#2196F3', // Azul
                    '#4CAF50', // Verde
                    '#FF9800', // Naranja
                    '#9C27B0', // Púrpura
                    '#F44336', // Rojo
                    '#00BCD4', // Cian
                    '#795548', // Marrón
                    '#607D8B', // Gris azulado
                    '#FFC107', // Ámbar
                    '#E91E63'  // Rosa
                ];
                
                return {
                    label: tipo,
                    data: data,
                    backgroundColor: colors[index % colors.length],
                    borderColor: colors[index % colors.length],
                    borderWidth: 1
                };
            });
            
            estatalChart1 = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    indexAxis: 'y', // Hacer barras horizontales
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Número de casos'
                            }
                        },
                        y: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Entidad Federativa'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: false,
                            text: `${concepto} - Enero a Julio 2025`,
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            mode: 'point',
                            callbacks: {
                                title: function(context) {
                                    return `${context[0].label}`;
                                },
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.x.toLocaleString()} casos`;
                                },
                                footer: function(context) {
                                    const entidad = context[0].label;
                                    const entidadData = conceptoData[entidad];
                                    const total = Object.values(entidadData).reduce((sum, val) => sum + val, 0);
                                    return `Total: ${total.toLocaleString()} casos`;
                                }
                            }
                        }
                    }
                }
            });
            
            console.log(`✅ Gráfica estatal 1 creada para: ${concepto}`);
        }
        
        // Función para crear la tabla estatal 1
        function createEstatalTable1(concepto) {
            if (!estatalData || !estatalData[concepto]) return;
            
            const container = document.getElementById('estatal-table-1');
            if (!container) return;
            
            const conceptoData = estatalData[concepto];
            
            // Obtener todos los tipos únicos para este concepto
            const todosLosTipos = new Set();
            Object.values(conceptoData).forEach(entidadData => {
                Object.keys(entidadData).forEach(tipo => todosLosTipos.add(tipo));
            });
            const tipos = Array.from(todosLosTipos).sort();
            
            // Calcular totales por entidad y ordenar
            const entidadTotales = [];
            Object.keys(conceptoData).forEach(entidad => {
                const entidadData = conceptoData[entidad];
                const total = Object.values(entidadData).reduce((sum, val) => sum + val, 0);
                entidadTotales.push({ entidad, total, data: entidadData });
            });
            
            // Ordenar de mayor a menor (igual que la gráfica)
            entidadTotales.sort((a, b) => b.total - a.total);
            
            // Crear tabla HTML
            let tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Entidad Federativa</th>
                            ${tipos.map(tipo => `<th>${tipo}</th>`).join('')}
                            <th style="background-color: #e3f2fd; font-weight: bold;">TOTAL</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            entidadTotales.forEach(item => {
                const { entidad, total, data } = item;
                tableHTML += `
                    <tr>
                        <td style="font-weight: bold;">${entidad}</td>
                        ${tipos.map(tipo => `<td>${(data[tipo] || 0).toLocaleString()}</td>`).join('')}
                        <td style="background-color: #e3f2fd; font-weight: bold;">${total.toLocaleString()}</td>
                    </tr>
                `;
            });
            
            // Fila de totales
            const totalPorTipo = tipos.map(tipo => {
                return entidadTotales.reduce((sum, item) => sum + (item.data[tipo] || 0), 0);
            });
            const granTotal = totalPorTipo.reduce((sum, val) => sum + val, 0);
            
            tableHTML += `
                    <tr style="background-color: #f5f5f5; font-weight: bold; border-top: 2px solid #ddd;">
                        <td>TOTAL NACIONAL</td>
                        ${totalPorTipo.map(total => `<td>${total.toLocaleString()}</td>`).join('')}
                        <td style="background-color: #e3f2fd;">${granTotal.toLocaleString()}</td>
                    </tr>
                </tbody>
            </table>
            `;
            
            container.innerHTML = tableHTML;
            console.log(`✅ Tabla estatal 1 creada para: ${concepto}`);
        }

        // ========================================
        // GRÁFICA ESTATAL 2: TOP 10 ENTIDADES MENSUALES
        // ========================================

        let estatal2Data = null;

        // Cargar datos para Gráfica Estatal 2
        async function loadEstatal2Data() {
            try {
                console.log('📊 Cargando datos para Gráfica Estatal 2...');
                const response = await fetch('data/estatal_top10_monthly_analysis.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                estatal2Data = await response.json();
                console.log('✅ Datos de Gráfica Estatal 2 cargados:', Object.keys(estatal2Data).length, 'meses');
                
                // Llenar selectores
                populateEstatal2Selectors();
                
            } catch (error) {
                console.error('❌ Error cargando datos Gráfica Estatal 2:', error);
                document.getElementById('estatal2-chart-container').innerHTML = 
                    '<p style="text-align: center; color: #e74c3c; padding: 20px;">Error cargando datos</p>';
            }
        }

        // Llenar selectores de Gráfica Estatal 2
        function populateEstatal2Selectors() {
            const conceptoSelector = document.getElementById('estatal2-concepto-selector');
            const tipoSelector = document.getElementById('estatal2-tipo-selector');
            
            if (!estatal2Data || !conceptoSelector) return;
            
            // Obtener conceptos únicos
            const conceptos = new Set();
            Object.values(estatal2Data).forEach(mesData => {
                Object.keys(mesData).forEach(concepto => conceptos.add(concepto));
            });
            
            // Llenar selector de conceptos
            conceptoSelector.innerHTML = '<option value="">-- Selecciona un concepto --</option>';
            [...conceptos].sort().forEach(concepto => {
                const option = document.createElement('option');
                option.value = concepto;
                // Hacer más corto el nombre en el selector
                option.textContent = concepto.includes('L.F.C.D.O.') ? 
                    'LEY FEDERAL CONTRA LA DELINCUENCIA ORGANIZADA' : concepto;
                conceptoSelector.appendChild(option);
            });
            
            // Event listener para concepto
            conceptoSelector.addEventListener('change', onEstatal2ConceptoChange);
        }

        // Cuando cambia el concepto en Gráfica Estatal 2
        function onEstatal2ConceptoChange() {
            const conceptoSelector = document.getElementById('estatal2-concepto-selector');
            const tipoSelector = document.getElementById('estatal2-tipo-selector');
            const concepto = conceptoSelector.value;
            
            // Limpiar visualización previa
            document.getElementById('estatal2-chart-container').style.display = 'none';
            document.getElementById('table-estatal2-container').style.display = 'none';
            
            if (!concepto) {
                tipoSelector.innerHTML = '<option value="">-- Primero selecciona un concepto --</option>';
                tipoSelector.disabled = true;
                return;
            }
            
            // Habilitar y llenar selector de tipos
            tipoSelector.disabled = false;
            tipoSelector.innerHTML = '<option value="">-- Todos los tipos --</option>';
            
            // Obtener tipos únicos para este concepto
            const tipos = new Set();
            Object.values(estatal2Data).forEach(mesData => {
                if (mesData[concepto]) {
                    Object.keys(mesData[concepto]).forEach(tipo => {
                        if (tipo !== 'TODOS') tipos.add(tipo);
                    });
                }
            });
            
            [...tipos].sort().forEach(tipo => {
                const option = document.createElement('option');
                option.value = tipo;
                option.textContent = tipo;
                tipoSelector.appendChild(option);
            });
            
            // Event listener para tipo
            tipoSelector.removeEventListener('change', onEstatal2TipoChange);
            tipoSelector.addEventListener('change', onEstatal2TipoChange);
            
            // Mostrar datos con "TODOS" por defecto
            renderEstatal2Chart(concepto, 'TODOS');
        }

        // Cuando cambia el tipo en Gráfica Estatal 2
        function onEstatal2TipoChange() {
            const conceptoSelector = document.getElementById('estatal2-concepto-selector');
            const tipoSelector = document.getElementById('estatal2-tipo-selector');
            const concepto = conceptoSelector.value;
            const tipo = tipoSelector.value || 'TODOS';
            
            if (concepto) {
                renderEstatal2Chart(concepto, tipo);
            }
        }

        // Renderizar cajas mensuales de Gráfica Estatal 2
        function renderEstatal2Chart(concepto, tipo) {
            console.log(`📊 Renderizando Gráfica Estatal 2: ${concepto} - ${tipo}`);
            
            const container = document.getElementById('estatal2-monthly-boxes');
            const chartContainer = document.getElementById('estatal2-chart-container');
            const tableContainer = document.getElementById('table-estatal2-container');
            
            if (!estatal2Data || !container) return;
            
            // Obtener meses ordenados
            const meses = Object.keys(estatal2Data).sort();
            
            // Limpiar contenedor
            container.innerHTML = '';
            
            // Generar cajas para cada mes
            meses.forEach(mes => {
                const mesData = estatal2Data[mes];
                if (!mesData[concepto] || !mesData[concepto][tipo]) return;
                
                const ranking = mesData[concepto][tipo];
                const [year, month] = mes.split('-');
                const monthNames = [
                    'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                    'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
                ];
                const monthName = monthNames[parseInt(month) - 1];
                
                // Crear caja mensual
                const box = document.createElement('div');
                box.className = 'monthly-box';
                
                box.innerHTML = `
                    <div class="monthly-box-header">
                        <h5 class="monthly-box-title">${monthName} ${year}</h5>
                        <p class="monthly-box-subtitle">${tipo === 'TODOS' ? 'Todos los tipos' : tipo}</p>
                    </div>
                    <ol class="monthly-ranking">
                        ${ranking.map((item, index) => {
                            const isSinaloa = item.entidad.toUpperCase() === 'SINALOA';
                            const highlightClass = isSinaloa ? ' highlight-sinaloa' : '';
                            return `
                                <li class="ranking-item${highlightClass}">
                                    <span class="ranking-position">${index + 1}</span>
                                    <span class="ranking-entity">${item.entidad}</span>
                                    <span class="ranking-value">${item.casos.toLocaleString()}</span>
                                </li>
                            `;
                        }).join('')}
                    </ol>
                `;
                
                container.appendChild(box);
            });
            
            // Mostrar contenedores
            chartContainer.style.display = 'block';
            
            // Crear tabla asociada
            createEstatal2Table(concepto, tipo);
        }

        // Crear tabla para Gráfica Estatal 2
        function createEstatal2Table(concepto, tipo) {
            const container = document.getElementById('table-estatal2');
            const tableContainer = document.getElementById('table-estatal2-container');
            
            if (!estatal2Data || !container) return;
            
            console.log(`📋 Creando tabla Estatal 2: ${concepto} - ${tipo}`);
            
            // Obtener meses ordenados
            const meses = Object.keys(estatal2Data).sort();
            const monthNames = [
                'Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun',
                'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'
            ];
            
            // Obtener todas las entidades que aparecen en top 10
            const todasEntidades = new Set();
            meses.forEach(mes => {
                const mesData = estatal2Data[mes];
                if (mesData[concepto] && mesData[concepto][tipo]) {
                    mesData[concepto][tipo].forEach(item => {
                        todasEntidades.add(item.entidad);
                    });
                }
            });
            
            const entidadesOrdenadas = [...todasEntidades].sort();
            
            // Crear encabezados de columnas
            const headers = meses.map(mes => {
                const [year, month] = mes.split('-');
                const monthName = monthNames[parseInt(month) - 1];
                return `${monthName} ${year}`;
            });
            
            // Crear tabla HTML
            let tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Entidad Federativa</th>
                            ${headers.map(header => `<th>${header}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            entidadesOrdenadas.forEach(entidad => {
                tableHTML += `
                    <tr>
                        <td style="font-weight: bold;">${entidad}</td>
                        ${meses.map(mes => {
                            const mesData = estatal2Data[mes];
                            let valor = 0;
                            if (mesData[concepto] && mesData[concepto][tipo]) {
                                const entidadData = mesData[concepto][tipo].find(item => item.entidad === entidad);
                                valor = entidadData ? entidadData.casos : 0;
                            }
                            return `<td>${valor.toLocaleString()}</td>`;
                        }).join('')}
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
            tableContainer.style.display = 'block';
            
            console.log(`✅ Tabla Estatal 2 creada: ${entidadesOrdenadas.length} entidades`);
        }

    </script>
    
    <!-- Leaflet JavaScript para mapas -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
</body>
</html>
