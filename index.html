<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Incidencia Delictiva - SESNSP México</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Custom CSS Files -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/snapshots.css">
</head>
<body>
    <!-- Header Section -->
    <header class="main-header">
        <div class="header-content">
            <h1>Análisis de las cifras de incidencia delictiva federal </h1>
            <p class="subtitle">Datos del Secretariado Ejecutivo del Sistema Nacional de Seguridad Pública</p>
            <p class="update-date">Última actualización: Agosto 2025</p>
        </div>
    </header>

    <!-- Main Content Container -->
    <main class="main-container">
        <!-- Overview section -->
        <section class="content-section">
            <h2>Estructura de la base de datos</h2>
            <p class="section-description">Overview de la base de datos original</p>

            <!-- Data Summary Cards -->
            <div class="data-overview">
                <div class="summary-card">
                    <div class="card-icon"></div>
                    <div class="card-content">
                        <h3>Total de registros</h3>
                        <p class="card-number" id="total-registros-original">Cargando...</p>
                        <p class="card-description">Registros delictivos incluidos</p>
                    </div>
                </div>
                
                <div class="summary-card">
                    <div class="card-icon"></div>
                    <div class="card-content">
                        <h3>Período</h3>
                        <p class="card-number" id="periodo-original">Cargando...</p>
                        <p class="card-description">Rango temporal completo</p>
                    </div>
                </div>
                
                <div class="summary-card">
                    <div class="card-icon"></div>
                    <div class="card-content">
                        <h3>Estados</h3>
                        <p class="card-number" id="total-estados-original">Cargando...</p>
                        <p class="card-description">Entidades federativas incluidas</p>
                    </div>
                </div>
                
                <div class="summary-card">
                    <div class="card-icon"></div>
                    <div class="card-content">
                        <h3>Conceptos</h3>
                        <p class="card-number" id="conceptos-unicos-original">Cargando...</p>
                        <p class="card-description">Conceptos principales</p>
                    </div>
                </div>
            </div>
            <p class="section-description">Base de datos procesada para el resto del informe</p>
            <!-- Data Summary Cards - Base Procesada -->
            <div class="data-overview">
                <div class="summary-card">
                    <div class="card-icon"></div>
                    <div class="card-content">
                        <h3>Total de Registros</h3>
                        <p class="card-number" id="total-registros-procesados">Cargando...</p>
                        <p class="card-description">Registros delictivos procesados</p>
                    </div>
                </div>
                
                <div class="summary-card">
                    <div class="card-icon"></div>
                    <div class="card-content">
                        <h3>Período</h3>
                        <p class="card-number" id="periodo-procesado">Cargando...</p>
                        <p class="card-description">Rango temporal filtrado</p>
                    </div>
                </div>
                
                <div class="summary-card">
                    <div class="card-icon"></div>
                    <div class="card-content">
                        <h3>Estados</h3>
                        <p class="card-number" id="total-estados-procesados">Cargando...</p>
                        <p class="card-description">Entidades federativas incluidas</p>
                    </div>
                </div>
                
                <div class="summary-card">
                    <div class="card-icon"></div>
                    <div class="card-content">
                        <h3>Conceptos</h3>
                        <p class="card-number" id="conceptos-unicos-procesados">Cargando...</p>
                        <p class="card-description">Conceptos principales</p>
                    </div>
                </div>
            </div>
            
            <!-- Database Preview Table - Solo Base Procesada -->
            <div class="database-preview">
                <h3>Vista previa de la base procesada</h3>
                <p class="preview-description">Primeras 10 filas de la base procesada - 'IDEFF_processed.csv'</p>
                <div class="table-container">
                    <table class="data-table" id="preview-table-procesados">
                        <thead>
                            <tr>
                                <th>Cargando...</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Cargando datos...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>


        <!-- Nacional Section -->
        <section class="content-section">
            <h2>Sección: Nacional</h2>
            <p class="section-description">Análisis a nivel nacional</p>
            
            <!-- Gráfica 1 -->
            <div class="chart-container">
                <h2>Gráfica 1. Evolución temporal de la incidencia delictiva del fuero federal por concepto (2019–2025)</h2>
                <p class="table-description">Datos reportados por el Secretariado Ejecutivo del Sistema Nacional de Seguridad Pública, enero–julio de cada año</p>
                <div style="height: 500px; width: 100%;">
                    <canvas id="nationalChart"></canvas>
                </div>
            </div>
            <!-- Tabla de Datos de la Gráfica -->
            <div class="table-container">
                <h3>Tabla 1. Incidencia delictiva del fuero federal por concepto (2019–2025)</h3>
                <p class="table-description">Valores agregados por concepto y año (suma de todos los meses)</p>
                
                <table class="data-table" id="national-concept-table">
                    <thead>
                        <tr>
                            <th>Concepto</th>
                            <th>2019</th>
                            <th>2020</th>
                            <th>2021</th>
                            <th>2022</th>
                            <th>2023</th>
                            <th>2024</th>
                            <th>2025</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Cargando datos...</td>
                            <td colspan="7">Espera...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- Tabla de cambios porcentuales de la Gráfica -->
            <div class="table-container">
                <h3>Tabla 1.1 Incidencia delictiva del fuero federal por concepto (2019–2025)</h3>
                <p class="table-description">Cambios porcentuales con respecto al año anterior (enero-julio)</p>
                
                <table class="data-table" id="percentage-changes-table">
                    <thead>
                        <tr>
                            <th>Concepto</th>
                            <th>2019</th>
                            <th>2020</th>
                            <th>2021</th>
                            <th>2022</th>
                            <th>2023</th>
                            <th>2024</th>
                            <th>2025</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Cargando datos...</td>
                            <td colspan="7">Espera...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- Gráfica 2 -->
            <div class="chart-container">
                <h2>Gráfica 2. Distribución porcentual anual de la delictiva del fuero federal por concepto (2019–2025)</h2>
                <p class="table-description">Datos reportados por el Secretariado Ejecutivo del Sistema Nacional de Seguridad Pública, enero–julio de cada año</p>
                <!-- Grid de 7 pie charts -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 50px; margin-top: 20px;">
                    <div style="height: 300px; width: 100%;">
                        <canvas id="pieChart2019"></canvas>
                    </div>
                    <div style="height: 300px; width: 100%;">
                        <canvas id="pieChart2020"></canvas>
                    </div>
                    <div style="height: 300px; width: 100%;">
                        <canvas id="pieChart2021"></canvas>
                    </div>
                    <div style="height: 300px; width: 100%;">
                        <canvas id="pieChart2022"></canvas>
                    </div>
                    <div style="height: 300px; width: 100%;">
                        <canvas id="pieChart2023"></canvas>
                    </div>
                    <div style="height: 300px; width: 100%;">
                        <canvas id="pieChart2024"></canvas>
                    </div>
                    <div style="height: 300px; width: 100%;">
                        <canvas id="pieChart2025"></canvas>
                    </div>
                </div>
            </div>
            <!-- Gráfica 3 -->
            <div class="chart-container">
                <h2>Gráfica 3. Distribución de tipos por concepto y año (2019–2025)</h2>
                <p class="table-description">Distribución porcentual de tipos para el concepto seleccionado</p>
                
                <!-- Selector de Concepto -->
                <div class="concept-selector">
                    <label for="concept-select">Selecciona un concepto:</label>
                    <select id="concept-select">
                        <option value="">Cargando conceptos...</option>
                    </select>
                </div>
                
                <!-- Grid de 7 pie charts -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-top: 20px;">
                    <div style="height: 300px; width: 100%;">
                        <canvas id="typePieChart2019"></canvas>
                    </div>
                    <div style="height: 300px; width: 100%;">
                        <canvas id="typePieChart2020"></canvas>
                    </div>
                    <div style="height: 300px; width: 100%;">
                        <canvas id="typePieChart2021"></canvas>
                    </div>
                    <div style="height: 300px; width: 100%;">
                        <canvas id="typePieChart2022"></canvas>
                    </div>
                    <div style="height: 300px; width: 100%;">
                        <canvas id="typePieChart2023"></canvas>
                    </div>
                    <div style="height: 300px; width: 100%;">
                        <canvas id="typePieChart2024"></canvas>
                    </div>
                    <div style="height: 300px; width: 100%;">
                        <canvas id="typePieChart2025"></canvas>
                    </div>
                </div>
            </div>
            <!-- Tabla de datos de la gráfica 3-->
            <div class="table-container">
                <h3>Tabla 2. Incidencia delictiva del fuero federal por concepto (2019–2025)</h3>
                <p class="table-description">Valores agregados por concepto y año (suma de todos los meses)</p>
            </div>
        </section>

        <!-- Estatal Section -->
        <section class="content-section">
            <h2>Estatal</h2>
            <p class="section-description">Análisis estatal con evolución de rankings</p>
            
            <!-- Placeholder for your content -->
            <div class="placeholder-content">
                <p>Tu contenido aquí...</p>
            </div>
        </section>

        <!-- Snapshots Section -->
        <section class="content-section">
            <h2>Snapshots Temporales</h2>
            <p class="section-description">Vista rápida de la evolución temporal</p>
            
            <!-- Placeholder for your content -->
            <div class="placeholder-content">
                <p>Tu contenido aquí...</p>
            </div>
        </section>
    </main>

    <!-- JavaScript para cargar estadísticas -->
         <!-- JavaScript para cargar estadísticas -->
    <script>
        // Función para cargar estadísticas de la base ORIGINAL
        async function loadOriginalStats() {
            try {
                console.log('🔄 Cargando estadísticas de base original...');
                const response = await fetch('data/stats.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const stats = await response.json();
                console.log('✅ Estadísticas originales cargadas:', stats);
                
                // Actualizar elementos de la base ORIGINAL
                if (stats.total_registros !== undefined) {
                    document.getElementById('total-registros-original').textContent = stats.total_registros.toLocaleString();
                }
                
                if (stats.fecha_minima && stats.fecha_maxima) {
                    document.getElementById('periodo-original').textContent = `${stats.fecha_minima} - ${stats.fecha_maxima}`;
                }
                
                if (stats.conceptos_unicos !== undefined) {
                    document.getElementById('conceptos-unicos-original').textContent = stats.conceptos_unicos;
                }
                
                if (stats.estados_unicos !== undefined) {
                    document.getElementById('total-estados-original').textContent = stats.estados_unicos;
                } else {
                    document.getElementById('total-estados-original').textContent = '32';
                }
                
                console.log('✅ Base original actualizada');
                
            } catch (error) {
                console.error('❌ Error cargando estadísticas originales:', error);
                document.getElementById('total-registros-original').textContent = 'Error';
                document.getElementById('periodo-original').textContent = 'Error';
                document.getElementById('conceptos-unicos-original').textContent = 'Error';
                document.getElementById('total-estados-original').textContent = 'Error';
            }
        }
        
        // Función para cargar estadísticas de la base PROCESADA
        async function loadProcessedStats() {
            try {
                console.log('🔄 Cargando estadísticas de base procesada...');
                const response = await fetch('data/stats_processed.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const stats = await response.json();
                console.log('✅ Estadísticas procesadas cargadas:', stats);
                
                // Actualizar elementos de la base PROCESADA
                if (stats.total_registros_procesados !== undefined) {
                    document.getElementById('total-registros-procesados').textContent = stats.total_registros_procesados.toLocaleString();
                }
                
                if (stats.fecha_minima_procesada && stats.fecha_maxima_procesada) {
                    document.getElementById('periodo-procesado').textContent = `${stats.fecha_minima_procesada} - ${stats.fecha_maxima_procesada}`;
                }
                
                if (stats.conceptos_unicos_procesados !== undefined) {
                    document.getElementById('conceptos-unicos-procesados').textContent = stats.conceptos_unicos_procesados;
                }
                
                if (stats.estados_unicos_procesados !== undefined) {
                    document.getElementById('total-estados-procesados').textContent = stats.estados_unicos_procesados;
                }
                
                console.log('✅ Base procesada actualizada');
                
            } catch (error) {
                console.error('❌ Error cargando estadísticas procesadas:', error);
                document.getElementById('total-registros-procesados').textContent = 'Error';
                document.getElementById('periodo-procesado').textContent = 'Error';
                document.getElementById('conceptos-unicos-procesados').textContent = 'Error';
                document.getElementById('total-estados-procesados').textContent = 'Error';
            }
        }
        
        // Función para cargar preview de la base PROCESADA (solo esta)
        async function loadProcessedPreview() {
            try {
                console.log('🔄 Cargando preview de base procesada...');
                const response = await fetch('data/preview_processed.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const previewData = await response.json();
                updatePreviewTable('preview-table-procesados', previewData);
                console.log('✅ Preview procesado actualizado');
                
            } catch (error) {
                console.error('❌ Error cargando preview procesado:', error);
                document.getElementById('preview-table-procesados').innerHTML = '<tbody><tr><td>Error cargando preview</td></tr></tbody>';
            }
        }
        
        // Función auxiliar para actualizar tabla de preview
        function updatePreviewTable(tableId, previewData) {
            if (previewData.length > 0) {
                const columns = Object.keys(previewData[0]);
                
                let tableHTML = '<thead><tr>';
                columns.forEach(col => {
                    tableHTML += `<th>${col}</th>`;
                });
                tableHTML += '</tr></thead><tbody>';
                
                previewData.forEach(row => {
                    tableHTML += '<tr>';
                    columns.forEach(col => {
                        const value = row[col] || '';
                        tableHTML += `<td>${value}</td>`;
                    });
                    tableHTML += '</tr>';
                });
                
                tableHTML += '</tbody>';
                document.getElementById(tableId).innerHTML = tableHTML;
            }
        }

        // Función para crear el stacked chart nacional
        function createNationalStackedChart() {
            // Obtener el canvas
            const ctx = document.getElementById('nationalChart').getContext('2d');
            
            // Datos del CSV (esto se cargará dinámicamente)
            const chartData = {
                labels: ['2019', '2020', '2021', '2022', '2023', '2024', '2025'],
                datasets: []
            };
            
            // Colores consistentes para cada concepto
            const conceptColors = {
                'OTRAS LEYES Y CODIGOS': '#FF6384',
                'OTROS DELITOS': '#36A2EB', 
                'CONTRA LA SALUD': '#FFCE56',
                'LEY GENERAL DE SALUD (L.G.S.)': '#4BC0C0',
                'LEY FEDERAL CONTRA LA DELINCUENCIA ORGANIZADA (L.F.C.D.O.)': '#FF9F40'
            };
            
            // Colores de respaldo
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
            ];
            
            // Cargar datos del CSV
            fetch('data/national_concept_analysis.csv')
                .then(response => response.text())
                .then(csvText => {
                    const lines = csvText.split('\n');
                    const headers = lines[0].split(',');
                    const years = headers.slice(1); // Años (2019, 2020, etc.)
                    
                    // Procesar cada línea (concepto)
                    for (let i = 1; i < lines.length; i++) {
                        if (lines[i].trim()) {
                            const values = lines[i].split(',');
                            const concepto = values[0];
                            const data = values.slice(1).map(val => parseInt(val) || 0);
                            
                            // Crear dataset para este concepto
                            chartData.datasets.push({
                                label: concepto,
                                data: data,
                                backgroundColor: conceptColors[concepto] || colors[i % colors.length],
                                borderColor: conceptColors[concepto] || colors[i % colors.length],
                                borderWidth: 1,
                            });
                        }
                    }
                    
                    // Crear el chart
                    new Chart(ctx, {
                        type: 'bar',
                        data: chartData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        usePointStyle: true,
                                        padding: 20
                                    }
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + ' casos';
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Año (enero-julio)'
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: 'Número de carpetas de investigación'
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return value.toLocaleString();
                                        }
                                    }
                                }
                            },
                            interaction: {
                                mode: 'nearest',
                                axis: 'x',
                                intersect: false
                            }
                        }
                    });
                })
                .catch(error => {
                    console.error('Error cargando datos:', error);
                });
        }


        // Función para cargar la tabla de datos nacionales
        async function loadNationalTable() {
            try {
                console.log('🔄 Cargando tabla de datos nacionales...');
                const response = await fetch('data/national_concept_analysis.csv');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                const rows = csvText.split('\n');
                const headers = rows[0].split(',');
                
                // Crear tabla HTML
                let tableHTML = '<thead><tr>';
                headers.forEach(header => {
                    tableHTML += `<th>${header}</th>`;
                });
                tableHTML += '<th>Total</th></tr></thead><tbody>';
                
                // Procesar filas de datos (saltar la primera que son headers)
                for (let i = 1; i < rows.length; i++) {
                    if (rows[i].trim() === '') continue; // Saltar filas vacías
                    
                    const values = rows[i].split(',');
                    if (values.length < headers.length) continue; // Saltar filas incompletas
                    
                    tableHTML += '<tr>';
                    
                    // Primera columna (Concepto)
                    tableHTML += `<td>${values[0]}</td>`;
                    
                    // Columnas de años (convertir a números y formatear)
                    let total = 0;
                    for (let j = 1; j < values.length; j++) {
                        const value = parseInt(values[j]) || 0;
                        total += value;
                        tableHTML += `<td class="text-right">${value.toLocaleString()}</td>`;
                    }
                    
                    // Columna de total
                    tableHTML += `<td class="text-right total-cell"><strong>${total.toLocaleString()}</strong></td>`;
                    
                    tableHTML += '</tr>';
                }
                
                tableHTML += '</tbody>';
                
                // Actualizar la tabla
                document.getElementById('national-concept-table').innerHTML = tableHTML;
                console.log('✅ Tabla nacional actualizada');
                
            } catch (error) {
                console.error('❌ Error cargando tabla nacional:', error);
                document.getElementById('national-concept-table').innerHTML = 
                    '<tbody><tr><td colspan="8">Error cargando datos</td></tr></tbody>';
            }
        }
        
        // ===== FUNCIÓN PARA CARGAR TABLA DE CAMBIOS PORCENTUALES =====
        
        async function loadPercentageChangesTable() {
            try {
                console.log('🔄 Cargando tabla de cambios porcentuales...');
                const response = await fetch('data/national_percentage_analysis.csv');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                const rows = csvText.split('\n');
                const headers = rows[0].split(',');
                
                // Crear tabla HTML
                let tableHTML = '<thead><tr>';
                headers.forEach(header => {
                    tableHTML += `<th>${header}</th>`;
                });
                tableHTML += '</tr></thead><tbody>';
                
                // Procesar filas de datos (saltar la primera que son headers)
                for (let i = 1; i < rows.length; i++) {
                    if (rows[i].trim() === '') continue; // Saltar filas vacías
                    
                    const values = rows[i].split(',');
                    if (values.length < headers.length) continue; // Saltar filas incompletas
                    
                    tableHTML += '<tr>';
                    
                    // Primera columna (Concepto)
                    tableHTML += `<td>${values[0]}</td>`;
                    
                    // Columnas de años (cambios porcentuales)
                    for (let j = 1; j < values.length; j++) {
                        const value = parseFloat(values[j]) || 0;
                        
                        // Formatear cambios porcentuales con colores
                        let cellClass = 'text-right';
                        let displayValue = value;
                        
                        if (value > 0) {
                            cellClass += ' positive-change';
                            displayValue = `+${value.toFixed(1)}%`;
                        } else if (value < 0) {
                            cellClass += ' negative-change';
                            displayValue = `${value.toFixed(1)}%`;
                        } else {
                            displayValue = '0.0%';
                        }
                        
                        tableHTML += `<td class="${cellClass}">${displayValue}</td>`;
                    }
                    
                    tableHTML += '</tr>';
                }
                
                tableHTML += '</tbody>';
                
                // Actualizar la tabla
                document.getElementById('percentage-changes-table').innerHTML = tableHTML;
                console.log('✅ Tabla de cambios porcentuales actualizada');
                
            } catch (error) {
                console.error('❌ Error cargando tabla de cambios porcentuales:', error);
                document.getElementById('percentage-changes-table').innerHTML = 
                    '<tbody><tr><td colspan="7">Error cargando datos</td></tr></tbody>';
            }
        }
        // Función para crear 7 pie charts nacionales (uno por año)
        function createNationalPieCharts() {
            // Colores consistentes para cada concepto (mismos que en la gráfica 1)
            const conceptColors = {
                'OTRAS LEYES Y CODIGOS': '#FF6384',
                'OTROS DELITOS': '#36A2EB', 
                'CONTRA LA SALUD': '#FFCE56',
                'LEY GENERAL DE SALUD (L.G.S.)': '#4BC0C0',
                'LEY FEDERAL CONTRA LA DELINCUENCIA ORGANIZADA (L.F.C.D.O.)': '#FF9F40'
            };
            
            // Colores de respaldo
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
            ];
            
            // Años disponibles
            const years = ['2019', '2020', '2021', '2022', '2023', '2024', '2025'];
            
            // Cargar datos del CSV
            fetch('data/national_concept_analysis.csv')
                .then(response => response.text())
                .then(csvText => {
                    const lines = csvText.split('\n');
                    const headers = lines[0].split(',');
                    
                    // Procesar cada línea (concepto)
                    const conceptData = [];
                    for (let i = 1; i < lines.length; i++) {
                        if (lines[i].trim()) {
                            const values = lines[i].split(',');
                            const concepto = values[0];
                            const data = values.slice(1).map(val => parseInt(val) || 0);
                            
                            conceptData.push({
                                concepto: concepto,
                                data: data
                            });
                        }
                    }
                    
                    // Crear un pie chart para cada año
                    years.forEach((year, yearIndex) => {
                        const canvasId = `pieChart${year}`;
                        const canvas = document.getElementById(canvasId);
                        
                        if (canvas) {
                            const ctx = canvas.getContext('2d');
                            
                            // Preparar datos para este año específico
                            const chartData = {
                                labels: conceptData.map(item => item.concepto),
                                datasets: [{
                                    data: conceptData.map(item => item.data[yearIndex]),
                                    backgroundColor: conceptData.map(item => conceptColors[item.concepto] || colors[conceptData.indexOf(item) % colors.length]),
                                    borderColor: conceptData.map(item => conceptColors[item.concepto] || colors[conceptData.indexOf(item) % colors.length]),
                                    borderWidth: 2,
                                    hoverOffset: 4
                                }]
                            };
                            
                            // Crear el donut chart para este año
                            new Chart(ctx, {
                                type: 'doughnut',
                                data: chartData,
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    cutout: '40%',  // Tamaño del agujero central
                                    plugins: {
                                        title: {
                                            display: true,
                                            text: `Año ${year}`,
                                            font: {
                                                size: 16
                                            }
                                        },
                                        legend: {
                                            display: false
                                        },
                                        tooltip: {
                                            callbacks: {
                                                label: function(context) {
                                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                                    const shortLabel = context.label.length > 30 ? 
                                                        context.label.substring(0, 15) + '...' : 
                                                        context.label;
                                                    return shortLabel + ': ' + context.parsed.toLocaleString() + ' casos (' + percentage + '%)';
                                                }
                                            }
                                        }
                                    }
                                }
                            });
                        }
                    });
                })
                .catch(error => {
                    console.error('Error cargando datos:', error);
                });
        }

        // ===== GRÁFICA 3: DISTRIBUCIÓN DE TIPOS POR CONCEPTO =====

        // Variables globales para la gráfica 3
        let typeChartData = null;
        let currentConcept = '';

        // Función para cargar los conceptos disponibles
        async function loadAvailableConcepts() {
            try {
                const response = await fetch('data/type_distribution_analysis.csv');
                const csvText = await response.text();
                
                const lines = csvText.split('\n');
                const headers = lines[0].split(',');
                
                // Obtener conceptos únicos
                const concepts = new Set();
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const values = lines[i].split(',');
                        if (values.length > 1) {
                            concepts.add(values[0]); // Primera columna es CONCEPTO
                        }
                    }
                }
                
                // Llenar el selector
                const select = document.getElementById('concept-select');
                select.innerHTML = '<option value="">Selecciona un concepto...</option>';
                
                Array.from(concepts).sort().forEach(concept => {
                    const option = document.createElement('option');
                    option.value = concept;
                    option.textContent = concept;
                    select.appendChild(option);
                });
                
                // Cargar datos completos
                typeChartData = parseCSVToData(csvText);
                
                // Event listener para cambios en el selector
                select.addEventListener('change', function() {
                    currentConcept = this.value;
                    if (currentConcept) {
                        createTypePieCharts(currentConcept);
                        document.getElementById('type-charts-container').style.display = 'block';
                    } else {
                        document.getElementById('type-charts-container').style.display = 'none';
                    }
                });
                
                console.log('✅ Conceptos cargados:', Array.from(concepts));
                
            } catch (error) {
                console.error('❌ Error cargando conceptos:', error);
            }
        }

        // Función para parsear CSV a datos estructurados
        function parseCSVToData(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',');
            
            const data = {};
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = lines[i].split(',');
                    const concepto = values[0];
                    const año = values[1];
                    
                    if (!data[concepto]) {
                        data[concepto] = {};
                    }
                    
                    data[concepto][año] = {};
                    
                    // Agregar datos de tipos (columnas 2 en adelante)
                    for (let j = 2; j < headers.length; j++) {
                        const tipo = headers[j];
                        const valor = parseInt(values[j]) || 0;
                        data[concepto][año][tipo] = valor;
                    }
                }
            }
            
            return data;
        }

        // Función para generar colores flexibles únicos basados en los tipos disponibles
        function generateFlexibleColors(tipos) {
            // Paleta de colores únicos y visualmente distintos
            const uniqueColors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                '#FF9F40', '#8AC249', '#FF6B6B', '#4ECDC4', '#45B7D1',
                '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F',
                '#BB8FCE', '#85C1E9', '#F8C471', '#82E0AA', '#F1948A',
                '#D7BDE2', '#A9CCE3', '#F5B7B1', '#D2B4DE', '#AED6F1'
            ];
            
            // Crear mapeo de colores únicos para cada tipo
            const colorMap = {};
            
            tipos.forEach((tipo, index) => {
                // Asignar color único directamente por índice
                colorMap[tipo] = uniqueColors[index];
            });
            
                    return colorMap;
    }

    // Función para crear la tabla de datos de la Gráfica 3
    function createTypeDistributionTable(concepto) {
        if (!typeChartData || !typeChartData[concepto]) {
            console.error('No hay datos para el concepto:', concepto);
            return;
        }
        
        const years = ['2019', '2020', '2021', '2022', '2023', '2024', '2025'];
        const conceptData = typeChartData[concepto];
        
        // Obtener todos los tipos únicos para este concepto
        const allTipos = new Set();
        years.forEach(year => {
            if (conceptData[year]) {
                Object.keys(conceptData[year]).forEach(tipo => {
                    if (conceptData[year][tipo] > 0) {
                        allTipos.add(tipo);
                    }
                });
            }
        });
        
        const tipos = Array.from(allTipos).sort();
        
        // Crear tabla HTML
        let tableHTML = '<thead><tr><th>Tipo</th>';
        years.forEach(year => {
            tableHTML += `<th>${year}</th>`;
        });
        tableHTML += '</tr></thead><tbody>';
        
        // Procesar cada tipo
        tipos.forEach(tipo => {
            tableHTML += '<tr>';
            tableHTML += `<td>${tipo}</td>`;
            
            // Agregar valores para cada año
            years.forEach(year => {
                const value = conceptData[year] && conceptData[year][tipo] ? conceptData[year][tipo] : 0;
                tableHTML += `<td class="text-right">${value.toLocaleString()}</td>`;
            });
            
            tableHTML += '</tr>';
        });
        
        tableHTML += '</tbody>';
        
        // Buscar la tabla de la Gráfica 3 por el título
        const tableContainers = document.querySelectorAll('.table-container');
        let targetTable = null;
        
        for (let container of tableContainers) {
            const h3 = container.querySelector('h3');
            if (h3 && h3.textContent.includes('Tabla 2')) {
                targetTable = container;
                break;
            }
        }
        
        if (targetTable) {
            let table = targetTable.querySelector('table');
            if (!table) {
                // Crear tabla si no existe
                table = document.createElement('table');
                table.className = 'data-table';
                targetTable.appendChild(table);
            }
            table.innerHTML = tableHTML;
        }
        
        console.log('✅ Tabla de distribución de tipos creada para:', concepto);
    }

    // Función para crear los pie charts de tipos
        function createTypePieCharts(concepto) {
            if (!typeChartData || !typeChartData[concepto]) {
                console.error('No hay datos para el concepto:', concepto);
                return;
            }
            
            const years = ['2019', '2020', '2021', '2022', '2023', '2024', '2025'];
            const conceptData = typeChartData[concepto];
            
            // Obtener todos los tipos únicos para este concepto
            const allTipos = new Set();
            years.forEach(year => {
                if (conceptData[year]) {
                    Object.keys(conceptData[year]).forEach(tipo => {
                        if (conceptData[year][tipo] > 0) {
                            allTipos.add(tipo);
                        }
                    });
                }
            });
            
            // Generar colores flexibles para todos los tipos
            const typeColors = generateFlexibleColors(Array.from(allTipos));
            
            // Crear un pie chart para cada año
            years.forEach(year => {
                const canvasId = `typePieChart${year}`;
                const canvas = document.getElementById(canvasId);
                
                if (canvas && conceptData[year]) {
                    const ctx = canvas.getContext('2d');
                    
                    // Destruir chart anterior si existe
                    if (window[`typeChart${year}`]) {
                        window[`typeChart${year}`].destroy();
                    }
                    
                    // Preparar datos para este año
                    const yearData = conceptData[year];
                    const tipos = Object.keys(yearData).filter(tipo => yearData[tipo] > 0);
                    const valores = tipos.map(tipo => yearData[tipo]);
                    
                    // Preparar colores usando el mapeo flexible
                    const backgroundColor = tipos.map(tipo => typeColors[tipo]);
                    const borderColor = backgroundColor;
                    
                    const chartData = {
                        labels: tipos,
                        datasets: [{
                            data: valores,
                            backgroundColor: backgroundColor,
                            borderColor: borderColor,
                            borderWidth: 2,
                            hoverOffset: 4
                        }]
                    };
                    
                                // Crear el donut chart
            window[`typeChart${year}`] = new Chart(ctx, {
                type: 'doughnut',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '40%',  // Tamaño del agujero central
                    plugins: {
                        title: {
                            display: true,
                            text: `Año ${year}`,
                            font: { size: 16 }
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    
                                    // Acortar nombres largos inteligentemente
                                    let shortLabel = context.label;
                                    if (context.label.length > 30) {
                                        // Buscar el último espacio antes del límite
                                        const lastSpace = context.label.lastIndexOf(' ', 30);
                                        if (lastSpace > 20) {
                                            shortLabel = context.label.substring(0, lastSpace) + '...';
                                        } else {
                                            shortLabel = context.label.substring(0, 30) + '...';
                                        }
                                    }
                                    
                                    return shortLabel + ': ' + context.parsed.toLocaleString() + ' casos (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
                }
            });
            
                console.log('✅ Pie charts de tipos creados para:', concepto);
    console.log('🎨 Tipos encontrados:', Array.from(allTipos));
    console.log('🎨 Colores asignados:', typeColors);
    
    // Crear también la tabla de datos
    createTypeDistributionTable(concepto);
}
        // ===== EVENT LISTENERS Y INICIALIZACIÓN =====
        
        // Cargar todos los datos cuando la página se cargue
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Página cargada, iniciando carga de datos...');
            
            // Cargar estadísticas
            loadOriginalStats();
            loadProcessedStats();
            loadProcessedPreview();
            loadNationalTable();
            loadPercentageChangesTable();
            loadAvailableConcepts();
            
            // Crear gráfica nacional
            createNationalStackedChart();
            createNationalPieCharts();
        });
        
        // Event listeners adicionales para debugging
        document.querySelectorAll('.content-section').forEach(section => {
            section.addEventListener('click', function() {
                console.log('Section clicked:', this.querySelector('h2').textContent);
            });
        });

    </script>
</body>
</html>
